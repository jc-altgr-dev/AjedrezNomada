<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENAEL Recap 2025</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --navidad-rojo: #c0392b;
            --navidad-verde: #1e8449;
            --oro: #f1c40f;
            --blanco: #ffffff;
            --oscuro: #1a1a1a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--oscuro);
            color: var(--blanco);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
        }

        #snow-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 99; }

        .story-container {
            width: 100%;
            max-width: 450px;
            height: 100vh;
            position: relative;
            background: linear-gradient(180deg, #1a1a1a 0%, #2c3e50 100%);
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* Diapositivas */
        .slide {
            position: absolute; width: 100%; height: 100%; padding: 60px 30px;
            display: none; flex-direction: column; align-items: center;
            justify-content: center; text-align: center; animation: fadeIn 0.4s ease-in;
        }
        .active { display: flex; }

        /* Barras de Progreso Superior */
        .progress-container { position: absolute; top: 15px; left: 10px; right: 10px; display: flex; gap: 5px; z-index: 100; }
        .progress-bar { height: 3px; background: rgba(255,255,255,0.2); flex-grow: 1; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--oro); width: 0%; }

        /* Textos */
        h1.navideno { font-family: 'Mountains of Christmas', cursive; font-size: 3rem; color: var(--oro); text-shadow: 2px 2px 8px rgba(0,0,0,0.5); }
        .stat-huge { font-size: 5.5rem; font-weight: 900; color: var(--blanco); line-height: 1; margin: 15px 0; }
        
        /* Foto Proporci√≥n Vertical 4:6 */
        .photo-frame {
            width: 80%;
            aspect-ratio: 4 / 6;
            border: 6px solid var(--blanco);
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            transform: rotate(-1.5deg);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            margin: 15px 0;
            background-color: #333;
        }

        /* Tarjeta Final Estilo Spotify/Instagram */
        #capture-area {
            background: var(--blanco); color: var(--oscuro);
            padding: 25px 20px; border-radius: 12px; width: 100%;
            text-align: left; border-bottom: 8px solid var(--navidad-verde);
        }
        .final-logo { font-family: 'Mountains of Christmas', cursive; font-size: 1.3rem; color: var(--navidad-rojo); margin-bottom: 5px; display: block;}
        .stat-badge { background: #f0f0f0; padding: 8px; border-radius: 5px; font-size: 0.85rem; }

        /* Botones */
        .btn-group { display: flex; gap: 10px; margin-top: 20px; z-index: 101; }
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .btn-wa { background: #25D366; color: white; }
        .btn-dl { background: var(--oro); color: var(--oscuro); }
        .btn:active { transform: scale(0.95); }

        .official-msg { font-size: 0.78rem; line-height: 1.4; color: #eee; margin-top: 20px; padding: 0 5px; opacity: 0.9; }

        /* Navegaci√≥n Invisible */
        .nav-zones { position: absolute; top: 0; width: 100%; height: 100%; display: flex; z-index: 90; }
        .zone { width: 50%; height: 100%; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <canvas id="snow-canvas"></canvas>

    <div class="story-container">
        <div class="progress-container" id="progress-bars"></div>
        
        <div class="nav-zones">
            <div class="zone" onclick="prevSlide()"></div>
            <div class="zone" onclick="nextSlide()"></div>
        </div>

        <div class="slide active" style="background: var(--navidad-verde);">
            <h1 class="navideno">¬°Hola!</h1>
            <h2 id="p-name-intro">Cargando...</h2>
            <p style="margin-top: 15px;">Bienvenido a tu resumen 2025</p>
            <div style="font-size: 3rem; margin-top: 20px;">üéÑ‚ôüÔ∏è</div>
        </div>

        <div class="slide" style="background: var(--navidad-rojo);">
            <h2 id="p-title" style="font-size: 1.8rem; line-height: 1.2;">¬°Preparando tu corona!</h2>
            <p id="p-title-desc" style="margin-top: 15px; font-size: 0.95rem; opacity: 0.9;"></p>
        </div>

        <div class="slide">
            <h3 style="color: var(--oro);">CONSTANCIA</h3>
            <div class="stat-huge" id="p-part">0</div>
            <h3>Torneos Jugados</h3>
            <p style="margin-top: 15px;">¬°Gracias por cada batalla en el tablero!</p>
        </div>

        <div class="slide" style="background: #2980b9;">
            <h3 style="color: var(--oro);">PUNTUACI√ìN</h3>
            <div class="stat-huge" id="p-pts">0</div>
            <h3>Puntos Totales</h3>
            <p style="font-size: 0.9rem;">Puntos FIDE / FENAMAC</p>
        </div>

        <div class="slide" style="background: #2c3e50;">
            <h3 style="color: var(--oro);">BRILLASTE EN EL TOP</h3>
            <div style="display: flex; gap: 40px; margin-top: 30px;">
                <div>
                    <div class="stat-huge" id="p-top3" style="font-size: 4rem; color: var(--oro);">0</div>
                    <p>TOP 3</p>
                </div>
                <div>
                    <div class="stat-huge" id="p-top10" style="font-size: 4rem;">0</div>
                    <p>TOP 10</p>
                </div>
            </div>
        </div>

        <div class="slide">
            <h3>Tu 2025 en im√°genes</h3>
            <div class="photo-frame" id="p-photo"></div>
            <p style="font-size: 0.8rem; font-style: italic;">Club Emanuel Lasker</p>
        </div>

        <div class="slide" id="last-slide">
            <div id="capture-area">
                <span class="final-logo">Club Escuela Nacional de Ajedrez Emanuel Lasker</span>
                <h3 id="p-final-name" style="font-size: 1.4rem;">Nombre Jugador</h3>
                <p id="p-final-club" style="color: var(--navidad-verde); font-weight: bold; font-size: 0.9rem;">Club</p>
                
                <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.8rem;">
                    <div style="background: #f4f4f4; padding: 5px; border-radius: 4px;"><strong>Torneos:</strong> <span id="f-part">0</span></div>
                    <div style="background: #f4f4f4; padding: 5px; border-radius: 4px;"><strong>Puntos:</strong> <span id="f-pts">0</span></div>
                    <div style="background: #f4f4f4; padding: 5px; border-radius: 4px;"><strong>Top 3:</strong> <span id="f-top3">0</span></div>
                    <div style="background: #f4f4f4; padding: 5px; border-radius: 4px;"><strong>Top 10:</strong> <span id="f-top10">0</span></div>
                </div>
            </div>

            <div class="official-msg">
                Felicita a todos sus miembros y amigos que participaron en nuestros torneos oficiales durante el ciclo 2025, esperando verlos de vuelta en 2026.<br><br>
                <strong>¬°Felices fiestas y un pr√≥spero a√±o nuevo!</strong>
            </div>

            <div class="btn-group">
                <button class="btn btn-dl" onclick="downloadRecap()">üíæ Guardar</button>
                <button class="btn btn-wa" onclick="shareWhatsApp()">üì± Compartir</button>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = '../recapENAEL2025.csv';
        let currentSlide = 0;
        let slides = document.querySelectorAll('.slide');
        let slideDuration = 5500;
        let timer;
        let playerData = null;

        async function init() {
            try {
                const res = await fetch(CSV_URL);
                const data = await res.text();
                const players = parseCSV(data);
                
                // Detectar nombre por carpeta
                const pathArray = window.location.pathname.split('/').filter(p => p);
                const nameInPage = pathArray[pathArray.length - 1];

                playerData = players.find(p => p.NameInPage.toLowerCase() === nameInPage.toLowerCase());
                
                if (playerData) {
                    analyzeAndFill(playerData, players);
                    setupProgressBars();
                    startStory();
                } else {
                    document.getElementById('p-name-intro').innerText = "¬°Hola!";
                    console.error("Jugador no encontrado en el CSV.");
                }
            } catch (e) { 
                console.error("Error cargando el CSV:", e);
                document.getElementById('p-name-intro').innerText = "Error de Datos";
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(l => l.trim());
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim());
                return headers.reduce((obj, header, i) => {
                    obj[header] = values[i];
                    return obj;
                }, {});
            });
        }

        function analyzeAndFill(player, all) {
            // Llenar datos b√°sicos en slides
            document.getElementById('p-name-intro').innerText = player.NombresPila;
            document.getElementById('p-part').innerText = player.PARTICIPACIONES || 0;
            document.getElementById('p-pts').innerText = player.PUNTOS || 0;
            document.getElementById('p-top3').innerText = player.TOP3 || 0;
            document.getElementById('p-top10').innerText = player.TOP10 || 0;
            document.getElementById('p-photo').style.backgroundImage = `url('../fotos/${player.NameInPage}.jpg')`;
            
            // Llenar tarjeta final
            document.getElementById('p-final-name').innerText = player.NombresPila + " " + (player.Apellidos || "");
            document.getElementById('p-final-club').innerText = player.Club || "Independiente";
            document.getElementById('f-part').innerText = player.PARTICIPACIONES || 0;
            document.getElementById('f-pts').innerText = player.PUNTOS || 0;

            // Omitir ceros en TARJETA FINAL
            const t3 = parseInt(player.TOP3) || 0;
            const t10 = parseInt(player.TOP10) || 0;
            
            if(t3 > 0) {
                document.getElementById('f-top3').innerText = t3;
                document.getElementById('box-top3').style.display = 'block';
            } else {
                document.getElementById('box-top3').style.display = 'none';
            }

            if(t10 > 0) {
                document.getElementById('f-top10').innerText = t10;
                document.getElementById('box-top10').style.display = 'block';
            } else {
                document.getElementById('box-top10').style.display = 'none';
            }

            // L√ìGICA DE T√çTULOS ESPECIALES (PARA QUE NO SALGAN ...)
            const pPart = parseInt(player.PARTICIPACIONES) || 0;
            const pPts = parseFloat(player.PUNTOS) || 0;
            const maxPartGlobal = Math.max(...all.map(p => parseInt(p.PARTICIPACIONES) || 0));
            const maxPtsGlobal = Math.max(...all.map(p => parseFloat(p.PUNTOS) || 0));
            const compa√±eros = all.filter(p => p.Club === player.Club);
            const maxPtsClub = Math.max(...compa√±eros.map(p => parseFloat(p.PUNTOS) || 0));

            let title = "¬°Un a√±o incre√≠ble!";
            let desc = "Gracias por acompa√±arnos en cada tablero durante este ciclo 2025.";

            if (pPart >= maxPartGlobal && pPart > 0) {
                title = "¬°Rey de la Constancia!";
                desc = "Fuiste de los jugadores m√°s activos de toda la escuela. ¬°Disciplina ejemplar!";
            } else if (pPts >= maxPtsGlobal && pPts > 0) {
                title = "¬°Estratega Maestro!";
                desc = "Lograste la puntuaci√≥n m√°s alta de todo el ciclo. ¬°Simplemente imparable!";
            } else if (pPts >= maxPtsClub && compa√±eros.length > 1 && pPts > 0) {
                title = `Orgullo de ${player.Club}`;
                desc = "Fuiste el jugador con mayor puntaje de tu club. ¬°Felicidades!";
            } else if (t3 > 0) {
                title = "¬°Fuerza en el Podio!";
                desc = "Tus trofeos demuestran que est√°s en el nivel m√°s alto de competencia.";
            }

            document.getElementById('p-title').innerText = title;
            document.getElementById('p-title-desc').innerText = desc;
        }

        // L√ìGICA DE HISTORIAS
        function setupProgressBars() {
            const container = document.getElementById('progress-bars');
            container.innerHTML = ""; // Limpiar
            slides.forEach((_, i) => {
                const bar = document.createElement('div');
                bar.className = 'progress-bar';
                bar.innerHTML = `<div class="progress-fill" id="fill-${i}"></div>`;
                container.appendChild(bar);
            });
        }

        function showSlide(index) {
            slides.forEach(s => s.classList.remove('active'));
            slides[index].classList.add('active');
            
            for(let i=0; i<slides.length; i++) {
                const fill = document.getElementById(`fill-${i}`);
                if(fill) fill.style.width = i < index ? '100%' : '0%';
            }

            if (index === slides.length - 1) { cancelAnimationFrame(timer); return; }
            
            let fillCurrent = document.getElementById(`fill-${index}`);
            let start = null;
            cancelAnimationFrame(timer);
            
            function animate(timestamp) {
                if (!start) start = timestamp;
                let progress = (timestamp - start) / slideDuration;
                if(fillCurrent) fillCurrent.style.width = Math.min(progress * 100, 100) + '%';
                if (progress < 1) timer = requestAnimationFrame(animate);
                else nextSlide();
            }
            timer = requestAnimationFrame(animate);
        }

        function nextSlide() { if (currentSlide < slides.length - 1) { currentSlide++; showSlide(currentSlide); } }
        function prevSlide() { if (currentSlide > 0) { currentSlide--; showSlide(currentSlide); } }
        function startStory() { showSlide(0); }

        function downloadRecap() {
            const area = document.getElementById('capture-area');
            html2canvas(area, { backgroundColor: '#ffffff', scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Recap2025_ENAEL.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        }

        function shareWhatsApp() {
            const msg = `¬°Mira mi resumen 2025 en el Club Emanuel Lasker! M√≠ralo aqu√≠: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // Animaci√≥n de Nieve
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let flakes = [];
        function setupSnow() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            flakes = [];
            for(let i=0; i<70; i++) flakes.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3+1 });
        }
        function drawSnow() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white"; ctx.beginPath();
            flakes.forEach(f => {
                ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
                f.y += 1 + f.r/2; if(f.y > canvas.height) f.y = -10;
            });
            ctx.fill(); requestAnimationFrame(drawSnow);
        }

        window.onload = () => { init(); setupSnow(); drawSnow(); };
        window.onresize = setupSnow;
    </script>
</body>
</html>
