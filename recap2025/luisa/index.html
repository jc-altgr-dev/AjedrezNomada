<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENAEL Recap 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --navidad-rojo: #c0392b;
            --navidad-verde: #1e8449;
            --oro: #f1c40f;
            --blanco: #ffffff;
            --oscuro: #1a1a1a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--oscuro);
            color: var(--blanco);
            overflow: hidden;
            height: 100vh;
        }

        #snow-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 99; }

        .story-container {
            max-width: 450px; height: 100vh; margin: 0 auto;
            position: relative; background: linear-gradient(180deg, #1a1a1a 0%, #2c3e50 100%);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        .slide {
            position: absolute; width: 100%; height: 100%; padding: 50px 25px;
            display: none; flex-direction: column; align-items: center;
            justify-content: center; text-align: center; animation: fadeIn 0.4s ease-in;
        }
        .active { display: flex; }

        .progress-container { position: absolute; top: 15px; left: 10px; right: 10px; display: flex; gap: 5px; z-index: 100; }
        .progress-bar { height: 3px; background: rgba(255,255,255,0.2); flex-grow: 1; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--oro); width: 0%; }

        h1.navideno { font-family: 'Mountains of Christmas', cursive; font-size: 3rem; color: var(--oro); text-shadow: 2px 2px 8px rgba(0,0,0,0.5); }
        .stat-huge { font-size: 5rem; font-weight: 900; color: var(--blanco); line-height: 1; margin: 15px 0; }
        
        /* FOTO ADAPTABLE VERTICAL (4:6) */
        .photo-frame {
            width: 70%; /* Ancho relativo */
            aspect-ratio: 4 / 6; /* Proporci√≥n vertical */
            border: 6px solid var(--blanco);
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            transform: rotate(-2deg);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            margin: 15px 0;
        }

        /* Tarjeta Final */
        #capture-area {
            background: var(--blanco); color: var(--oscuro);
            padding: 20px; border-radius: 12px; width: 100%;
            text-align: left; border-bottom: 6px solid var(--navidad-verde);
        }
        .final-logo { font-family: 'Mountains of Christmas', cursive; font-size: 1.2rem; color: var(--navidad-rojo); margin-bottom: 5px; display: block;}
        
        .stat-badge { background: #f4f4f4; padding: 6px 10px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 5px; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; z-index: 101; }
        .btn { padding: 12px 18px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .btn-wa { background: #25D366; color: white; }
        .btn-dl { background: var(--oro); color: var(--oscuro); }

        .official-msg { font-size: 0.8rem; line-height: 1.4; color: #eee; margin-top: 20px; padding: 0 10px; }

        .nav-zones { position: absolute; top: 0; width: 100%; height: 100%; display: flex; z-index: 90; }
        .zone { width: 50%; height: 100%; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <canvas id="snow-canvas"></canvas>

    <div class="story-container">
        <div class="progress-container" id="progress-bars"></div>
        <div class="nav-zones">
            <div class="zone" onclick="prevSlide()"></div>
            <div class="zone" onclick="nextSlide()"></div>
        </div>

        <div class="slide active" style="background: var(--navidad-verde);">
            <h1 class="navideno">¬°Hola!</h1>
            <h2 id="p-name-intro">...</h2>
            <p style="margin-top: 15px;">Bienvenido a tu resumen 2025</p>
            <div style="font-size: 3rem; margin-top: 20px;">üéÑ‚ôüÔ∏è</div>
        </div>

        <div class="slide" id="slide-achievement" style="background: var(--navidad-rojo);">
            <h2 id="p-title" style="font-size: 1.8rem; line-height: 1.2;">...</h2>
            <p id="p-title-desc" style="margin-top: 15px; font-size: 0.9rem; opacity: 0.9;"></p>
        </div>

        <div class="slide">
            <h3>Tus mejores jugadas</h3>
            <div class="photo-frame" id="p-photo"></div>
            <p style="font-size: 0.8rem; font-style: italic;">Club Emanuel Lasker</p>
        </div>

        <div class="slide" style="background: var(--oscuro);">
            
            <div id="capture-area">
                <span class="final-logo">Club Escuela Nacional de Ajedrez Emanuel Lasker les agradece</span>
                <h3 id="p-final-name" style="font-size: 1.4rem;">Nombre Jugador</h3>
                <p id="p-final-club" style="color: var(--navidad-verde); font-weight: bold; font-size: 0.9rem;">Club</p>
                
                <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.8rem;">
                    <div style="background: #f4f4f4; padding: 5px; border-radius: 4px;"><strong>Torneos:</strong> <span id="f-part">0</span></div>
                    <div style="background: #f4f4f4; padding: 5px; border-radius: 4px;"><strong>Puntos:</strong> <span id="f-pts">0</span></div>
                    <div style="background: #f4f4f4; padding: 5px; border-radius: 4px;"><strong>Top 3:</strong> <span id="f-top3">0</span></div>
                    <div style="background: #f4f4f4; padding: 5px; border-radius: 4px;"><strong>Top 10:</strong> <span id="f-top10">0</span></div>
                </div>
            </div>

            <div class="official-msg">
                Felicita a todos sus miembros y amigos que participaron de nuestros torneos oficiales durante el ciclo 2025, esperando verlos de vuelta en 2026.<br><br>
                <strong>¬°Les deseamos felices fiestas y un pr√≥spero a√±o nuevo rodeados de sus familiares y amigos!</strong>
            </div>

            <div class="btn-group">
                <button class="btn btn-dl" onclick="downloadRecap()">üíæ Guardar</button>
                <button class="btn btn-wa" onclick="shareWhatsApp()">üì± Compartir</button>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = '../recapENAEL2025.csv';
        let currentSlide = 0;
        let slides = document.querySelectorAll('.slide');
        let slideDuration = 5500;
        let timer;
        let playerData = null;

        async function init() {
            try {
                const res = await fetch(CSV_URL);
                const data = await res.text();
                const players = parseCSV(data);
                const pathArray = window.location.pathname.split('/').filter(p => p);
                const nameInPage = pathArray[pathArray.length - 1];

                playerData = players.find(p => p.NameInPage.toLowerCase() === nameInPage.toLowerCase());
                
                if (playerData) {
                    analyzeAndFill(playerData, players);
                    setupProgressBars();
                    startStory();
                }
            } catch (e) { console.error(e); }
        }

        function parseCSV(text) {
            const [header, ...rows] = text.split('\n').filter(r => r.trim());
            const keys = header.split(',').map(k => k.trim());
            return rows.map(row => {
                const values = row.split(',').map(v => v.trim());
                return keys.reduce((o, k, i) => ({ ...o, [k]: values[i] }), {});
            });
        }

        function analyzeAndFill(player, all) {
            document.getElementById('p-name-intro').innerText = player.NombresPila;
            document.getElementById('p-photo').style.backgroundImage = `url('../fotos/${player.NameInPage}.jpg')`;
            
            document.getElementById('p-final-name').innerText = player.NombresPila + " " + player.Apellidos;
            document.getElementById('p-final-club').innerText = player.Club;
            document.getElementById('f-part').innerText = player.PARTICIPACIONES;
            document.getElementById('f-pts').innerText = player.PUNTOS;

            // L√≥gica para ocultar estad√≠sticas en 0
            const t3 = parseInt(player.TOP3);
            const t10 = parseInt(player.TOP10);
            
            if(t3 > 0) { document.getElementById('f-top3').innerText = t3; } 
            else { document.getElementById('box-top3').style.display = 'none'; }
            
            if(t10 > 0) { document.getElementById('f-top10').innerText = t10; } 
            else { document.getElementById('box-top10').style.display = 'none'; }

            const maxPart = Math.max(...all.map(p => parseInt(p.PARTICIPACIONES)));
            const maxPts = Math.max(...all.map(p => parseFloat(p.PUNTOS)));

            let title = "¬°Gran a√±o de ajedrez!";
            let desc = "Gracias por ser parte fundamental de nuestra comunidad este 2025.";

            if (parseInt(player.PARTICIPACIONES) >= maxPart) {
                title = "¬°El Rey de la Constancia!";
                desc = "Fuiste de los jugadores m√°s activos de todo el a√±o. ¬°Felicidades!";
            } else if (parseFloat(player.PUNTOS) >= maxPts) {
                title = "¬°Estratega Maestro!";
                desc = "Lograste una de las puntuaciones m√°s altas del ciclo. ¬°Qu√© nivel!";
            }

            document.getElementById('p-title').innerText = title;
            document.getElementById('p-title-desc').innerText = desc;
        }

        function setupProgressBars() {
            const container = document.getElementById('progress-bars');
            slides.forEach((_, i) => {
                const bar = document.createElement('div');
                bar.className = 'progress-bar';
                bar.innerHTML = `<div class="progress-fill" id="fill-${i}"></div>`;
                container.appendChild(bar);
            });
        }

        function showSlide(index) {
            slides.forEach(s => s.classList.remove('active'));
            slides[index].classList.add('active');
            for(let i=0; i<slides.length; i++) {
                document.getElementById(`fill-${i}`).style.width = i < index ? '100%' : '0%';
            }
            if (index === slides.length - 1) { cancelAnimationFrame(timer); return; }
            
            let fill = document.getElementById(`fill-${index}`);
            let start = null;
            cancelAnimationFrame(timer);
            function animate(timestamp) {
                if (!start) start = timestamp;
                let progress = (timestamp - start) / slideDuration;
                fill.style.width = Math.min(progress * 100, 100) + '%';
                if (progress < 1) timer = requestAnimationFrame(animate);
                else nextSlide();
            }
            timer = requestAnimationFrame(animate);
        }

        function nextSlide() { if (currentSlide < slides.length - 1) { currentSlide++; showSlide(currentSlide); } }
        function prevSlide() { if (currentSlide > 0) { currentSlide--; showSlide(currentSlide); } }

        function downloadRecap() {
            const area = document.getElementById('capture-area');
            html2canvas(area).then(canvas => {
                const link = document.createElement('a');
                link.download = `Recap2025_${playerData.NombresPila}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function shareWhatsApp() {
            const msg = `Mira mi resumen 2025 en el Club Escuela Nacional de Ajedrez Emanuel Lasker: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // NIEVE
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let flakes = [];
        function setupSnow() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            for(let i=0; i<80; i++) flakes.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3+1, d: Math.random()*1 });
        }
        function drawSnow() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "white"; ctx.beginPath();
            flakes.forEach(f => {
                ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
                f.y += 1 + f.r/2;
                if(f.y > canvas.height) f.y = -10;
            });
            ctx.fill(); requestAnimationFrame(drawSnow);
        }

        window.onload = () => { init(); setupSnow(); drawSnow(); };
    </script>
</body>
</html>
