<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENAEL Recap 2025 - Comunidad y M√©rito</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --navidad-rojo: #c0392b;
            --navidad-verde: #1e8449;
            --oro: #f1c40f;
            --blanco: #ffffff;
            --oscuro: #1a1a1a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--oscuro);
            color: var(--blanco);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
        }

        #snow-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 99; }

        .story-container {
            width: 100%; max-width: 450px; height: 100vh;
            position: relative; background: linear-gradient(180deg, #1a1a1a 0%, #2c3e50 100%);
            overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        .slide {
            position: absolute; width: 100%; height: 100%; padding: 40px 25px;
            display: none; flex-direction: column; align-items: center;
            justify-content: center; text-align: center; animation: fadeIn 0.5s ease-in;
        }
        .active { display: flex; }

        /* Barra de progreso */
        .progress-container { position: absolute; top: 15px; left: 10px; right: 10px; display: flex; gap: 3px; z-index: 100; }
        .progress-bar { height: 3px; background: rgba(255,255,255,0.2); flex-grow: 1; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--oro); width: 0%; }

        /* Textos */
        h1.navideno { font-family: 'Mountains of Christmas', cursive; font-size: 2.8rem; color: var(--oro); text-shadow: 2px 2px 8px rgba(0,0,0,0.5); margin-bottom: 15px; }
        .stat-huge { font-size: 4.5rem; font-weight: 900; color: var(--blanco); line-height: 1; margin: 10px 0; }
        .stat-label { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 30px; font-weight: 700; color: var(--oro); }

        /* Listas */
        .leader-list { width: 100%; text-align: left; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-top: 5px; }
        .leader-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 3px; }
        .leader-item:last-child { border: none; margin: 0; }
        .leader-name { font-weight: bold; color: var(--oro); }

        /* BUSCADOR - Z-INDEX ALTO PARA CLICS */
        .search-slide { z-index: 110 !important; }
        .search-box { 
            margin-top: 20px; 
            width: 100%; 
            display: flex; 
            justify-content: center;
            position: relative;
            z-index: 120; /* Por encima de nav-zones */
        }
        input { 
            padding: 15px; width: 65%; border-radius: 30px 0 0 30px; border: 2px solid var(--oro); 
            outline: none; font-size: 1rem; text-align: center; color: var(--oscuro);
        }
        button.search-btn { 
            padding: 15px 20px; width: 25%; border-radius: 0 30px 30px 0; border: none; 
            background: var(--oro); color: var(--oscuro); font-weight: bold; cursor: pointer; 
        }

        /* Spotlight */
        .spotlight-frame {
            width: 75%; aspect-ratio: 4/6; border: 5px solid white; border-radius: 10px;
            background-size: cover; background-position: center; margin-bottom: 15px;
            transform: rotate(1deg); box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .badge-club { background: var(--navidad-rojo); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; margin-top: 5px; border: 1px solid var(--oro); }

        /* Zonas de navegaci√≥n t√°ctil */
        .nav-zones { position: absolute; top: 0; width: 100%; height: 100%; display: flex; z-index: 90; }
        .zone { width: 50%; height: 100%; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <canvas id="snow-canvas"></canvas>

    <div class="story-container" id="story-box">
        <div class="progress-container" id="progress-bars"></div>
        <div class="nav-zones">
            <div class="zone" onclick="prevSlide()"></div>
            <div class="zone" onclick="nextSlide()"></div>
        </div>

        <div class="slide active" style="background: var(--navidad-verde);">
            <h1 class="navideno">Comunidad ENAEL</h1>
            <h2>Resumen Colectivo 2025</h2>
            <div style="font-size: 4rem; margin: 25px 0;">‚ôüÔ∏èü§ù</div>
            <p>Un a√±o de historia escrito en el tablero.</p>
        </div>

        <div class="slide" style="background: #2c3e50;">
            <h1 class="navideno">Impacto Real</h1>
            <div class="stat-huge" id="g-players">0</div>
            <div class="stat-label">Ajedrecistas Unidos</div>
            <div class="stat-huge" id="g-games">0</div>
            <div class="stat-label">Encuentros Disputados</div>
            <p style="opacity: 0.9; font-size: 0.8rem; padding: 0 15px;">Fortaleciendo el tejido social a trav√©s del deporte ciencia.</p>
        </div>

        <div class="slide" style="background: var(--navidad-rojo);">
            <h1 class="navideno">Top 5 Constancia</h1>
            <p style="margin-bottom: 10px; font-size: 0.9rem;">L√≠deres en asistencia 2025:</p>
            <div class="leader-list" id="list-part"></div>
        </div>

        <div class="slide" style="background: #2980b9;">
            <h1 class="navideno">Top 5 Puntuaci√≥n</h1>
            <p style="margin-bottom: 10px; font-size: 0.9rem;">Mejor desempe√±o deportivo:</p>
            <div class="leader-list" id="list-pts"></div>
        </div>

        <div class="slide" style="background: var(--oscuro);">
            <h1 class="navideno" style="color: var(--oro);">Top 5 Podios</h1>
            <p style="margin-bottom: 10px; font-size: 0.9rem;">Frecuencia en el Top 3:</p>
            <div class="leader-list" id="list-top3"></div>
        </div>

        <div class="slide search-slide" style="background: var(--navidad-verde);">
            <h1 class="navideno">¬°Busca tu Recap!</h1>
            
            <p style="font-size: 0.9rem; padding: 0 10px; line-height: 1.4;">
                Si participaste este 2025 en nuestros torneos oficiales, usa tu <strong>nick personalizado</strong> para buscarte:
            </p>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Tu Nick">
                <button class="search-btn" onclick="manualSearch()">IR</button>
            </div>
            
            <p id="error-msg" style="color: #ffcccc; margin-top: 15px; display: none; font-size: 0.8rem;"></p>

            <div style="margin-top: 30px; font-size: 0.8rem; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                O accede directamente en:<br>
                <span style="color: var(--oro);">enael.com.mx/recap2025/tu-nick</span>
            </div>
            
            <div style="font-size: 2rem; margin-top: 20px;">üéÑ</div>
        </div>
    </div>

    <script>
        const CSV_URL = 'recapENAEL2025.csv';
        let currentSlide = 0;
        let slideDuration = 5500;
        let timer;
        let allPlayers = [];
        let slides;

        async function init() {
            try {
                const res = await fetch(CSV_URL);
                const text = await res.text();
                allPlayers = parseCSV(text);
                calculateGlobals(allPlayers);
                slides = document.querySelectorAll('.slide');
                setupProgressBars();
                showSlide(0);
            } catch (e) { console.error(e); }
        }

        function parseCSV(text) {
            const cleanText = text.replace(/^\uFEFF/, '');
            const lines = cleanText.split(/\r?\n/).filter(l => l.trim());
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, h, i) => {
                    obj[h] = values[i] ? values[i].trim() : "";
                    return obj;
                }, {});
            });
        }

        function calculateGlobals(players) {
            const sumParticipaciones = players.reduce((sum, p) => sum + (parseInt(p.PARTICIPACIONES) || 0), 0);
            const totalEncuentros = Math.floor((sumParticipaciones * 6) / 2);
            document.getElementById('g-players').innerText = players.length;
            document.getElementById('g-games').innerText = totalEncuentros;

            const top5Part = [...players].sort((a,b) => (parseInt(b.PARTICIPACIONES)||0) - (parseInt(a.PARTICIPACIONES)||0)).slice(0, 5);
            const top5Pts = [...players].sort((a,b) => (parseFloat(b.PUNTOS)||0) - (parseFloat(a.PUNTOS)||0)).slice(0, 5);
            const top5Podium = [...players].sort((a,b) => (parseInt(b.TOP3)||0) - (parseInt(a.TOP3)||0)).slice(0, 5);

            renderList('list-part', top5Part, 'PARTICIPACIONES', 'Torns');
            renderList('list-pts', top5Pts, 'PUNTOS', 'Pts');
            renderList('list-top3', top5Podium, 'TOP3', 'Pod');

            let destacados = [];
            const clubs = [...new Set(players.map(p => p.Club).filter(c => c && c !== ""))];
            clubs.forEach(clubName => {
                const mejorDelClub = players.filter(p => p.Club === clubName).sort((a,b) => (parseFloat(b.PUNTOS)||0) - (parseFloat(a.PUNTOS)||0))[0];
                if(mejorDelClub) { mejorDelClub.honorTitle = `Mejor de ${clubName}`; destacados.push(mejorDelClub); }
            });
            top5Pts.forEach((p, index) => {
                if(!destacados.some(d => d.NameInPage === p.NameInPage)) { p.honorTitle = `Top ${index + 1} General`; destacados.push(p); }
            });
            injectSpotlightSlides(destacados);
        }

        function renderList(id, list, key, label) {
            const container = document.getElementById(id);
            list.forEach((p, i) => {
                container.innerHTML += `<div class="leader-item"><span>${i+1}. <span class="leader-name">${p.NombresPila}</span></span><span>${p[key]} ${label}</span></div>`;
            });
        }

        function injectSpotlightSlides(destacados) {
            const container = document.getElementById('story-box');
            const searchSlide = document.querySelector('.search-slide');
            destacados.forEach(p => {
                if(!p.NameInPage) return;
                const div = document.createElement('div');
                div.className = 'slide';
                div.innerHTML = `
                    <h3 style="color: var(--oro); font-size: 0.9rem; letter-spacing: 2px;">MURO DE HONOR</h3>
                    <div class="spotlight-frame" style="background-image: url('fotos/${p.NameInPage}.jpg')"></div>
                    <h2 style="font-size: 2rem;">${p.NombresPila}</h2>
                    <div class="badge-club">${p.honorTitle}</div>
                    <p style="margin-top: 15px; font-size: 0.85rem; line-height: 1.4; padding: 0 15px; opacity: 0.9;">Inspirando a la comunidad ENAEL con su talento y dedicaci√≥n este 2025.</p>
                `;
                container.insertBefore(div, searchSlide);
            });
        }

        function setupProgressBars() {
            const container = document.getElementById('progress-bars');
            container.innerHTML = "";
            slides.forEach((_, i) => {
                const bar = document.createElement('div');
                bar.className = 'progress-bar';
                bar.innerHTML = `<div class="progress-fill" id="fill-${i}"></div>`;
                container.appendChild(bar);
            });
        }

        function showSlide(index) {
            slides.forEach(s => s.classList.remove('active'));
            slides[index].classList.add('active');
            for(let i=0; i<slides.length; i++) {
                const fill = document.getElementById(`fill-${i}`);
                if(fill) fill.style.width = i < index ? '100%' : '0%';
            }
            if (index === slides.length - 1) { cancelAnimationFrame(timer); return; }
            let fillCurrent = document.getElementById(`fill-${index}`);
            let start = null;
            cancelAnimationFrame(timer);
            function animate(timestamp) {
                if (!start) start = timestamp;
                let progress = (timestamp - start) / slideDuration;
                if(fillCurrent) fillCurrent.style.width = Math.min(progress * 100, 100) + '%';
                if (progress < 1) timer = requestAnimationFrame(animate);
                else nextSlide();
            }
            timer = requestAnimationFrame(animate);
        }

        function nextSlide() { if (currentSlide < slides.length - 1) { currentSlide++; showSlide(currentSlide); } }
        function prevSlide() { if (currentSlide > 0) { currentSlide--; showSlide(currentSlide); } }

        function manualSearch() {
            const input = document.getElementById('searchInput').value.trim().toLowerCase();
            const player = allPlayers.find(p => p.NameInPage.toLowerCase() === input || p.NombresPila.toLowerCase() === input);
            if (player) {
                window.location.href = `./${player.NameInPage}/`; 
            } else {
                const error = document.getElementById('error-msg');
                error.style.display = 'block';
                error.innerText = `El nick "${input}" no existe. Prueba con tu nombre de pila.`;
            }
        }

        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let flakes = [];
        function setupSnow() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            flakes = [];
            for(let i=0; i<60; i++) flakes.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3+1 });
        }
        function drawSnow() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "white"; ctx.beginPath();
            flakes.forEach(f => {
                ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
                f.y += 1 + f.r/2; if(f.y > canvas.height) f.y = -10;
            });
            ctx.fill(); requestAnimationFrame(drawSnow);
        }
        window.onload = () => { init(); setupSnow(); drawSnow(); };
    </script>
</body>
</html>
