<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENAEL Recap 2025 - Resumen de la Comunidad</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --navidad-rojo: #c0392b;
            --navidad-verde: #1e8449;
            --oro: #f1c40f;
            --blanco: #ffffff;
            --oscuro: #1a1a1a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--oscuro);
            color: var(--blanco);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
        }

        #snow-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 99; }

        .story-container {
            width: 100%; max-width: 450px; height: 100vh;
            position: relative; background: linear-gradient(180deg, #1a1a1a 0%, #2c3e50 100%);
            overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        .slide {
            position: absolute; width: 100%; height: 100%; padding: 40px 25px;
            display: none; flex-direction: column; align-items: center;
            justify-content: center; text-align: center; animation: fadeIn 0.5s ease-in;
        }
        .active { display: flex; }

        .progress-container { position: absolute; top: 15px; left: 10px; right: 10px; display: flex; gap: 3px; z-index: 100; }
        .progress-bar { height: 3px; background: rgba(255,255,255,0.2); flex-grow: 1; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--oro); width: 0%; }

        h1.navideno { font-family: 'Mountains of Christmas', cursive; font-size: 3rem; color: var(--oro); text-shadow: 2px 2px 8px rgba(0,0,0,0.5); margin-bottom: 20px; }
        .stat-huge { font-size: 4.5rem; font-weight: 900; color: var(--blanco); line-height: 1; margin: 10px 0; }
        .stat-label { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 30px; font-weight: 700; color: var(--oro); }

        .leader-list { width: 100%; text-align: left; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-top: 10px; }
        .leader-item { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; }
        .leader-item:last-child { border: none; margin: 0; }
        .leader-name { font-weight: bold; color: var(--oro); }

        .search-box { margin-top: 30px; width: 100%; display: flex; justify-content: center; }
        input { padding: 15px; width: 65%; border-radius: 30px 0 0 30px; border: none; outline: none; font-size: 1rem; text-align: center; }
        button.search-btn { padding: 15px 20px; width: 25%; border-radius: 0 30px 30px 0; border: none; background: var(--oro); color: var(--oscuro); font-weight: bold; cursor: pointer; }

        .spotlight-frame {
            width: 80%; aspect-ratio: 4/6; border: 5px solid white; border-radius: 10px;
            background-size: cover; background-position: center; margin-bottom: 15px;
            transform: rotate(1.5deg); box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        .nav-zones { position: absolute; top: 0; width: 100%; height: 100%; display: flex; z-index: 90; }
        .zone { width: 50%; height: 100%; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <canvas id="snow-canvas"></canvas>

    <div class="story-container" id="story-box">
        <div class="progress-container" id="progress-bars"></div>
        <div class="nav-zones">
            <div class="zone" onclick="prevSlide()"></div>
            <div class="zone" onclick="nextSlide()"></div>
        </div>

        <div class="slide active" style="background: var(--navidad-verde);">
            <h1 class="navideno">Comunidad ENAEL</h1>
            <h2>Resumen Colectivo 2025</h2>
            <div style="font-size: 4rem; margin: 30px 0;">鮫勇游뱋</div>
            <p>Celebrando un a침o de crecimiento y pasi칩n por el ajedrez.</p>
        </div>

        <div class="slide" style="background: #2c3e50;">
            <h1 class="navideno">Impacto 2025</h1>
            
            <div class="stat-huge" id="g-players">0</div>
            <div class="stat-label">Ajedrecistas Activos</div>
            
            <div class="stat-huge" id="g-games">0</div>
            <div class="stat-label">Encuentros en el Tablero</div>
            
            <p style="opacity: 0.9; font-size: 0.85rem; padding: 0 15px;">
                Cada partida sum칩 al compa침erismo y fortaleci칩 nuestra comunidad en la ciudad.
            </p>
        </div>

        <div class="slide" style="background: var(--navidad-rojo);">
            <h1 class="navideno">Los M치s Activos</h1>
            <p style="margin-bottom: 20px;">Liderando en asistencia este ciclo:</p>
            <div class="leader-list" id="list-part"></div>
        </div>

        <div class="slide" style="background: #2980b9;">
            <h1 class="navideno">M치ximo Puntaje</h1>
            <p style="margin-bottom: 20px;">Destacados en el ranking oficial:</p>
            <div class="leader-list" id="list-pts"></div>
        </div>

        <div class="slide" style="background: var(--oscuro);">
            <h1 class="navideno" style="color: var(--oro);">En el Podio</h1>
            <p style="margin-bottom: 20px;">M치s veces en los primeros lugares:</p>
            <div class="leader-list" id="list-top3"></div>
        </div>

        <div class="slide search-slide" style="background: var(--navidad-verde);">
            <h1 class="navideno">춰Busca tu Recap!</h1>
            <p>Si participaste en nuestros torneos,</p>
            <p>aqu칤 est치 tu resumen personalizado:</p>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Escribe tu Nombre">
                <button class="search-btn" onclick="manualSearch()">IR</button>
            </div>
            <p id="error-msg" style="color: #ffcccc; margin-top: 15px; display: none; font-size: 0.8rem;">No encontrado. Prueba con tu nombre de pila (Ej: Juan).</p>
            
            <div style="font-size: 2.5rem; margin-top: 40px;">游꾻</div>
        </div>
    </div>

    <script>
        const CSV_URL = 'recapENAEL2025.csv';
        let currentSlide = 0;
        let slideDuration = 5500;
        let timer;
        let allPlayers = [];
        let slides;

        async function init() {
            try {
                const res = await fetch(CSV_URL);
                const text = await res.text();
                allPlayers = parseCSV(text);
                
                calculateGlobals(allPlayers);
                
                slides = document.querySelectorAll('.slide');
                setupProgressBars();
                showSlide(0);
            } catch (e) { console.error(e); }
        }

        function parseCSV(text) {
            const cleanText = text.replace(/^\uFEFF/, '');
            const lines = cleanText.split(/\r?\n/).filter(l => l.trim());
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, h, i) => {
                    obj[h] = values[i] ? values[i].trim() : "";
                    return obj;
                }, {});
            });
        }

        function calculateGlobals(players) {
            // L칩gica de Encuentros: (Total Participaciones * 6 rondas) / 2 personas por tablero
            const sumParticipaciones = players.reduce((sum, p) => sum + (parseInt(p.PARTICIPACIONES) || 0), 0);
            const totalEncuentros = Math.floor((sumParticipaciones * 6) / 2);

            document.getElementById('g-players').innerText = players.length;
            document.getElementById('g-games').innerText = totalEncuentros;

            // Ordenar por categor칤as para los Tops
            const sortedByPart = [...players].sort((a,b) => (parseInt(b.PARTICIPACIONES)||0) - (parseInt(a.PARTICIPACIONES)||0));
            const sortedByPts = [...players].sort((a,b) => (parseFloat(b.PUNTOS)||0) - (parseFloat(a.PUNTOS)||0));
            const sortedByTop3 = [...players].sort((a,b) => (parseInt(b.TOP3)||0) - (parseInt(a.TOP3)||0));

            renderList('list-part', sortedByPart.slice(0, 3), 'PARTICIPACIONES', 'torneos');
            renderList('list-pts', sortedByPts.slice(0, 3), 'PUNTOS', 'pts');
            renderList('list-top3', sortedByTop3.slice(0, 3), 'TOP3', 'podios');

            // Selecci칩n de Fotos Meritocr치tica (Top de cada categor칤a)
            const destacados = [sortedByPart[0], sortedByPts[0], sortedByTop3[0], sortedByPart[1], sortedByPts[1]];
            const destacadosUnicos = [...new Map(destacados.map(p => [p.NameInPage, p])).values()];

            injectSpotlightSlides(destacadosUnicos);
        }

        function renderList(id, list, key, label) {
            const container = document.getElementById(id);
            list.forEach(p => {
                container.innerHTML += `
                    <div class="leader-item">
                        <span class="leader-name">${p.NombresPila}</span>
                        <span>${p[key]} ${label}</span>
                    </div>`;
            });
        }

        function injectSpotlightSlides(destacados) {
            const container = document.getElementById('story-box');
            const searchSlide = document.querySelector('.search-slide');

            destacados.forEach(p => {
                if(!p.NameInPage) return;
                const div = document.createElement('div');
                div.className = 'slide';
                div.innerHTML = `
                    <h3 style="color: var(--oro); font-size: 1rem; letter-spacing: 2px;">MURO DE HONOR</h3>
                    <div class="spotlight-frame" style="background-image: url('fotos/${p.NameInPage}.jpg')"></div>
                    <h2 style="font-size: 2.2rem; margin-top: 5px;">${p.NombresPila}</h2>
                    <p style="color: var(--oro); font-weight: bold;">${p.Club || "Comunidad ENAEL"}</p>
                    <p style="margin-top: 15px; font-size: 0.9rem; line-height: 1.4; padding: 0 10px; opacity: 0.9;">
                        Pilar fundamental en el compa침erismo y crecimiento del ajedrez local en 2025.
                    </p>
                `;
                container.insertBefore(div, searchSlide);
            });
        }

        function setupProgressBars() {
            const container = document.getElementById('progress-bars');
            container.innerHTML = "";
            slides.forEach((_, i) => {
                const bar = document.createElement('div');
                bar.className = 'progress-bar';
                bar.innerHTML = `<div class="progress-fill" id="fill-${i}"></div>`;
                container.appendChild(bar);
            });
        }

        function showSlide(index) {
            slides.forEach(s => s.classList.remove('active'));
            slides[index].classList.add('active');
            for(let i=0; i<slides.length; i++) {
                const fill = document.getElementById(`fill-${i}`);
                if(fill) fill.style.width = i < index ? '100%' : '0%';
            }
            if (index === slides.length - 1) { cancelAnimationFrame(timer); return; }
            let fillCurrent = document.getElementById(`fill-${index}`);
            let start = null;
            cancelAnimationFrame(timer);
            function animate(timestamp) {
                if (!start) start = timestamp;
                let progress = (timestamp - start) / slideDuration;
                if(fillCurrent) fillCurrent.style.width = Math.min(progress * 100, 100) + '%';
                if (progress < 1) timer = requestAnimationFrame(animate);
                else nextSlide();
            }
            timer = requestAnimationFrame(animate);
        }

        function nextSlide() { if (currentSlide < slides.length - 1) { currentSlide++; showSlide(currentSlide); } }
        function prevSlide() { if (currentSlide > 0) { currentSlide--; showSlide(currentSlide); } }

        function manualSearch() {
            const input = document.getElementById('searchInput').value.trim().toLowerCase();
            // Buscamos tanto por NameInPage como por NombresPila para ayudar al usuario
            const player = allPlayers.find(p => p.NameInPage.toLowerCase() === input || p.NombresPila.toLowerCase() === input);
            if (player) {
                window.location.href = `${player.NameInPage}/`; 
            } else {
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let flakes = [];
        function setupSnow() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            flakes = [];
            for(let i=0; i<60; i++) flakes.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3+1 });
        }
        function drawSnow() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "white"; ctx.beginPath();
            flakes.forEach(f => {
                ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
                f.y += 1 + f.r/2; if(f.y > canvas.height) f.y = -10;
            });
            ctx.fill(); requestAnimationFrame(drawSnow);
        }

        window.onload = () => { init(); setupSnow(); drawSnow(); };
    </script>
</body>
</html>
