<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENAEL Recap 2025 - Resumen Global</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --navidad-rojo: #c0392b;
            --navidad-verde: #1e8449;
            --oro: #f1c40f;
            --blanco: #ffffff;
            --oscuro: #1a1a1a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--oscuro);
            color: var(--blanco);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
        }

        #snow-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 99; }

        .story-container {
            width: 100%; max-width: 450px; height: 100vh;
            position: relative; background: linear-gradient(180deg, #1a1a1a 0%, #2c3e50 100%);
            overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* Slides */
        .slide {
            position: absolute; width: 100%; height: 100%; padding: 40px 25px;
            display: none; flex-direction: column; align-items: center;
            justify-content: center; text-align: center; animation: fadeIn 0.5s ease-in;
        }
        .active { display: flex; }

        /* Barras de Progreso */
        .progress-container { position: absolute; top: 15px; left: 10px; right: 10px; display: flex; gap: 3px; z-index: 100; }
        .progress-bar { height: 3px; background: rgba(255,255,255,0.2); flex-grow: 1; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--oro); width: 0%; }

        /* Textos y Estilos */
        h1.navideno { font-family: 'Mountains of Christmas', cursive; font-size: 3rem; color: var(--oro); text-shadow: 2px 2px 8px rgba(0,0,0,0.5); margin-bottom: 20px; }
        .stat-huge { font-size: 4.5rem; font-weight: 900; color: var(--blanco); line-height: 1; margin: 10px 0; }
        .stat-label { font-size: 1rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 30px; }

        /* Listas de Top Players */
        .leader-list { width: 100%; text-align: left; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-top: 10px; }
        .leader-item { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; }
        .leader-item:last-child { border: none; margin: 0; }
        .leader-name { font-weight: bold; color: var(--oro); }
        .leader-val { font-weight: 400; }

        /* Buscador Final */
        .search-box { margin-top: 30px; width: 100%; }
        input { padding: 15px; width: 70%; border-radius: 30px 0 0 30px; border: none; outline: none; font-size: 1rem; text-align: center; }
        button.search-btn { padding: 15px 20px; width: 25%; border-radius: 0 30px 30px 0; border: none; background: var(--oro); color: var(--oscuro); font-weight: bold; cursor: pointer; }

        /* Foto Destacada (Generada por JS) */
        .spotlight-frame {
            width: 85%; aspect-ratio: 4/6; border: 5px solid white; border-radius: 10px;
            background-size: cover; background-position: center; margin-bottom: 15px;
            transform: rotate(2deg); box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        .nav-zones { position: absolute; top: 0; width: 100%; height: 100%; display: flex; z-index: 90; }
        .zone { width: 50%; height: 100%; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <canvas id="snow-canvas"></canvas>

    <div class="story-container" id="story-box">
        <div class="progress-container" id="progress-bars"></div>
        <div class="nav-zones">
            <div class="zone" onclick="prevSlide()"></div>
            <div class="zone" onclick="nextSlide()"></div>
        </div>

        <div class="slide active" style="background: var(--navidad-verde);">
            <h1 class="navideno">Resumen 2025</h1>
            <h2>Club Escuela Nacional de Ajedrez Emanuel Lasker</h2>
            <div style="font-size: 4rem; margin: 30px 0;">‚ôüÔ∏èüåé</div>
            <p>Un a√±o de grandes jugadas y nuevos amigos.</p>
        </div>

        <div class="slide" style="background: #2c3e50;">
            <h1 class="navideno">En N√∫meros</h1>
            
            <div class="stat-huge" id="g-players">0</div>
            <div class="stat-label">Jugadores Activos</div>
            
            <div class="stat-huge" id="g-games">0</div>
            <div class="stat-label">Torneos Jugados</div>
            
            <p style="opacity: 0.8; font-size: 0.9rem;">Sumando esfuerzo colectivo</p>
        </div>

        <div class="slide" style="background: var(--navidad-rojo);">
            <h1 class="navideno">Los M√°s Activos</h1>
            <p style="margin-bottom: 20px;">Nadie jug√≥ m√°s torneos que ellos:</p>
            <div class="leader-list" id="list-part">
                </div>
        </div>

        <div class="slide" style="background: #2980b9;">
            <h1 class="navideno">M√°ximos Puntos</h1>
            <p style="margin-bottom: 20px;">Liderando el ranking FENAMAC/FIDE:</p>
            <div class="leader-list" id="list-pts">
                </div>
        </div>

        <div class="slide" style="background: var(--oscuro);">
            <h1 class="navideno" style="color: var(--oro);">Reyes del Podio</h1>
            <p style="margin-bottom: 20px;">M√°s veces en el Top 3:</p>
            <div class="leader-list" id="list-top3">
                </div>
        </div>

        <div class="slide search-slide" style="background: var(--navidad-verde);">
            <h1 class="navideno">Tu Turno</h1>
            <p>¬øJugaste con nosotros en 2025?</p>
            <p style="margin-top: 10px;">Busca tu resumen personal:</p>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Tu nombre (ej: Juan)">
                <button class="search-btn" onclick="manualSearch()">IR</button>
            </div>
            <p id="error-msg" style="color: #ffcccc; margin-top: 15px; display: none;">Usuario no encontrado. Prueba otro nombre.</p>
            
            <div style="font-size: 3rem; margin-top: 40px;">üéÑ</div>
        </div>
    </div>

    <script>
        const CSV_URL = 'recapENAEL2025.csv'; // Aseg√∫rate que est√© en la misma carpeta
        let currentSlide = 0;
        let slideDuration = 5000;
        let timer;
        let allPlayers = [];
        let slides; // Se definir√° despu√©s de inyectar

        async function init() {
            try {
                const res = await fetch(CSV_URL);
                const text = await res.text();
                allPlayers = parseCSV(text);
                
                calculateGlobals(allPlayers);
                injectSpotlightSlides(allPlayers); // Inyectar fotos antes de iniciar
                
                // Reiniciar lista de slides ahora que agregamos nuevos
                slides = document.querySelectorAll('.slide');
                
                setupProgressBars();
                showSlide(0);
            } catch (e) { console.error("Error:", e); }
        }

        function parseCSV(text) {
            const cleanText = text.replace(/^\uFEFF/, '');
            const lines = cleanText.split(/\r?\n/).filter(l => l.trim());
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, h, i) => {
                    obj[h] = values[i] ? values[i].trim() : "";
                    return obj;
                }, {});
            });
        }

        function calculateGlobals(players) {
            // 1. Totales
            document.getElementById('g-players').innerText = players.length;
            const totalTorneos = players.reduce((sum, p) => sum + (parseInt(p.PARTICIPACIONES)||0), 0);
            document.getElementById('g-games').innerText = totalTorneos;

            // 2. Tops
            const topPart = [...players].sort((a,b) => (parseInt(b.PARTICIPACIONES)||0) - (parseInt(a.PARTICIPACIONES)||0)).slice(0, 3);
            const topPts = [...players].sort((a,b) => (parseFloat(b.PUNTOS)||0) - (parseFloat(a.PUNTOS)||0)).slice(0, 3);
            const topPodium = [...players].sort((a,b) => (parseInt(b.TOP3)||0) - (parseInt(a.TOP3)||0)).slice(0, 3);

            renderList('list-part', topPart, 'PARTICIPACIONES', 'torneos');
            renderList('list-pts', topPts, 'PUNTOS', 'pts');
            renderList('list-top3', topPodium, 'TOP3', 'podios');
        }

        function renderList(id, list, key, label) {
            const container = document.getElementById(id);
            list.forEach(p => {
                container.innerHTML += `
                    <div class="leader-item">
                        <span class="leader-name">${p.NombresPila}</span>
                        <span class="leader-val">${p[key]} ${label}</span>
                    </div>`;
            });
        }

        function injectSpotlightSlides(players) {
            // Seleccionar 5 jugadores aleatorios para destacar
            // Filtramos los que tengan nombre de foto (NameInPage)
            const validPlayers = players.filter(p => p.NameInPage);
            const shuffled = validPlayers.sort(() => 0.5 - Math.random()).slice(0, 5);

            const container = document.getElementById('story-box');
            const searchSlide = document.querySelector('.search-slide'); // Insertar antes del buscador

            shuffled.forEach(p => {
                const div = document.createElement('div');
                div.className = 'slide';
                div.innerHTML = `
                    <h3 style="color: var(--oro);">Destacado 2025</h3>
                    <div class="spotlight-frame" style="background-image: url('fotos/${p.NameInPage}.jpg')"></div>
                    <h2 style="font-size: 2rem;">${p.NombresPila}</h2>
                    <p>${p.Club}</p>
                    <div style="margin-top:10px; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px;">
                        ${p.PARTICIPACIONES} Torneos jugados
                    </div>
                `;
                // Insertamos antes del √∫ltimo slide (buscador)
                container.insertBefore(div, searchSlide);
            });
        }

        // --- NAVEGACI√ìN ---
        function setupProgressBars() {
            const container = document.getElementById('progress-bars');
            container.innerHTML = "";
            slides.forEach((_, i) => {
                const bar = document.createElement('div');
                bar.className = 'progress-bar';
                bar.innerHTML = `<div class="progress-fill" id="fill-${i}"></div>`;
                container.appendChild(bar);
            });
        }

        function showSlide(index) {
            slides.forEach(s => s.classList.remove('active'));
            slides[index].classList.add('active');

            for(let i=0; i<slides.length; i++) {
                const fill = document.getElementById(`fill-${i}`);
                if(fill) fill.style.width = i < index ? '100%' : '0%';
            }

            if (index === slides.length - 1) { cancelAnimationFrame(timer); return; } // Parar en el buscador

            let fillCurrent = document.getElementById(`fill-${index}`);
            let start = null;
            cancelAnimationFrame(timer);
            
            function animate(timestamp) {
                if (!start) start = timestamp;
                let progress = (timestamp - start) / slideDuration;
                if(fillCurrent) fillCurrent.style.width = Math.min(progress * 100, 100) + '%';
                if (progress < 1) timer = requestAnimationFrame(animate);
                else nextSlide();
            }
            timer = requestAnimationFrame(animate);
        }

        function nextSlide() { if (currentSlide < slides.length - 1) { currentSlide++; showSlide(currentSlide); } }
        function prevSlide() { if (currentSlide > 0) { currentSlide--; showSlide(currentSlide); } }

        // --- BUSCADOR ---
        function manualSearch() {
            const input = document.getElementById('searchInput').value.trim().toLowerCase();
            const player = allPlayers.find(p => p.NameInPage.toLowerCase() === input || p.NombresPila.toLowerCase() === input);
            
            if (player) {
                // Redirigir a la carpeta del usuario
                window.location.href = `${player.NameInPage}/`; 
            } else {
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        // --- NIEVE ---
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let flakes = [];
        function setupSnow() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            flakes = [];
            for(let i=0; i<60; i++) flakes.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3+1 });
        }
        function drawSnow() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "white"; ctx.beginPath();
            flakes.forEach(f => {
                ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
                f.y += 1 + f.r/2; if(f.y > canvas.height) f.y = -10;
            });
            ctx.fill(); requestAnimationFrame(drawSnow);
        }

        window.onload = () => { init(); setupSnow(); drawSnow(); };
    </script>
</body>
</html>
