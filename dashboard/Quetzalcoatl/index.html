<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tablero de Progreso — Club de Ajedrez Infantil</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fredoka font -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Canvas Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --mint:#BFF3D0;
      --lilac:#D7C8FF;
      --sun:#FFF1B8;
      --card-shadow: 0 12px 30px rgba(16,24,40,0.08);
      --rounded: 1rem;
    }
    html,body,#app{height:100%;}
    body{
      font-family: 'Fredoka', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #f7fff9 0%, #fbf9ff 100%);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Kid-friendly hover bounce */
    .hover-bounce:hover{ transform: translateY(-6px) scale(1.02); transition: transform .25s cubic-bezier(.2,.8,.2,1); }
    .card { border-radius: var(--rounded); box-shadow: var(--card-shadow); }
    .xp-bar-bg { background: rgba(255,255,255,0.6); border-radius: .75rem; height:1.25rem; }
    .xp-bar-fill { height:1.25rem; border-radius: .75rem; transition: width 1200ms cubic-bezier(.2,.8,.2,1); box-shadow: inset 0 -2px 6px rgba(0,0,0,0.06); }
    .trophy { width:28px; height:28px; vertical-align:middle; margin-left:.4rem; }
    .hidden-name { display:none !important; } /* enforce privacy for name field if needed */
    /* small screens layout */
    @media (max-width:720px){
      .grid-responsive{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="app" class="p-6 max-w-6xl mx-auto">
    <header class="mb-6 flex items-center gap-4">
      <div class="w-14 h-14 rounded-full bg-gradient-to-br from-green-200 to-lilac-200 flex items-center justify-center text-2xl shadow-lg">♟️</div>
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">Tablero de Progreso — Club Infantil</h1>
        <p class="text-sm text-slate-600">Seguimiento gamificado de habilidades y metas — privacidad respetada</p>
      </div>
    </header>

    <!-- Controls -->
    <section class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card p-4 bg-white hover-bounce">
        <label class="block text-sm font-semibold mb-2">Buscar alumno (ID Lichess)</label>
        <input id="searchInput" class="w-full p-3 rounded-lg border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-300" placeholder="Escribe 3+ caracteres..." />
        <ul id="suggestions" class="mt-2 max-h-40 overflow-auto"></ul>
      </div>

      <div class="card p-4 bg-white hover-bounce">
        <label class="block text-sm font-semibold mb-2">Jugador seleccionado</label>
        <div id="selectedInfo" class="flex items-center gap-4">
          <img id="avatar" src="" alt="avatar" class="w-20 h-20 rounded-full shadow" />
          <div>
            <div class="text-lg font-semibold" id="publicId">—</div>
            <div class="text-xs text-slate-500">Solo se muestra el ID público (privacidad)</div>
            <div id="liveStatus" class="mt-1 text-xs text-emerald-600"></div>
          </div>
        </div>
      </div>

      <div class="card p-4 bg-white hover-bounce">
        <label class="block text-sm font-semibold mb-2">Acciones</label>
        <div class="flex gap-2">
          <button id="reloadCsv" class="px-4 py-2 rounded-lg bg-emerald-400 text-white font-medium shadow hover:brightness-95">Recargar CSV</button>
          <button id="refreshLichess" class="px-4 py-2 rounded-lg bg-indigo-400 text-white font-medium shadow hover:brightness-95">Actualizar desde Lichess</button>
          <button id="demoConfetti" class="px-4 py-2 rounded-lg bg-yellow-300 text-slate-800 font-medium shadow hover:brightness-95">Probar Confeti</button>
        </div>
      </div>
    </section>

    <!-- Main display: Two big zones -->
    <main class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Left: Rendimiento en Vivo -->
      <section class="card p-5 bg-white">
        <h2 class="text-xl font-bold mb-3">Rendimiento en Vivo</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Rayo Veloz -->
          <div class="p-4 rounded-lg" style="background: linear-gradient(135deg,var(--mint),#e9fff0)">
            <h3 class="font-semibold mb-2">Rayo Veloz (Bullet / Blitz)</h3>
            <div id="card-bullet" class="mb-3 p-3 rounded-lg bg-white card">
              <div class="flex justify-between items-center mb-2">
                <div class="text-sm font-medium">Bullet <span id="bulletValue" class="text-slate-500 text-sm"></span></div>
                <div id="bulletTrophy"></div>
              </div>
              <div class="xp-bar-bg">
                <div id="bulletBar" class="xp-bar-fill" style="width:0%; background: linear-gradient(90deg,#f3c5ff,#b9f7d0);"></div>
              </div>
              <div class="text-xs text-slate-500 mt-1">Partidas: <span id="bulletGames"></span></div>
            </div>

            <div id="card-blitz" class="p-3 rounded-lg bg-white card">
              <div class="flex justify-between items-center mb-2">
                <div class="text-sm font-medium">Blitz <span id="blitzValue" class="text-slate-500 text-sm"></span></div>
                <div id="blitzTrophy"></div>
              </div>
              <div class="xp-bar-bg">
                <div id="blitzBar" class="xp-bar-fill" style="width:0%; background: linear-gradient(90deg,#ffd9a8,#d7c8ff);"></div>
              </div>
              <div class="text-xs text-slate-500 mt-1">Partidas: <span id="blitzGames"></span></div>
            </div>
          </div>

          <!-- Ritmo Reflexivo -->
          <div class="p-4 rounded-lg" style="background: linear-gradient(135deg,var(--lilac),#f2ecff)">
            <h3 class="font-semibold mb-2">Ritmo Reflexivo (Rapid / Classical)</h3>
            <div id="card-rapid" class="mb-3 p-3 rounded-lg bg-white card">
              <div class="flex justify-between items-center mb-2">
                <div class="text-sm font-medium">Rapid <span id="rapidValue" class="text-slate-500 text-sm"></span></div>
                <div id="rapidTrophy"></div>
              </div>
              <div class="xp-bar-bg">
                <div id="rapidBar" class="xp-bar-fill" style="width:0%; background: linear-gradient(90deg,#c6f0ff,#ffd9a8);"></div>
              </div>
              <div class="text-xs text-slate-500 mt-1">Partidas: <span id="rapidGames"></span></div>
            </div>

            <div id="card-classical" class="p-3 rounded-lg bg-white card">
              <div class="flex justify-between items-center mb-2">
                <div class="text-sm font-medium">Classical <span id="classicalValue" class="text-slate-500 text-sm"></span></div>
                <div id="classicalTrophy"></div>
              </div>
              <div class="xp-bar-bg">
                <div id="classicalBar" class="xp-bar-fill" style="width:0%; background: linear-gradient(90deg,#e0ffd6,#c6f0ff);"></div>
              </div>
              <div class="text-xs text-slate-500 mt-1">Partidas: <span id="classicalGames"></span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Right: Gimnasio Cerebral -->
      <section class="card p-5 bg-white">
        <h2 class="text-xl font-bold mb-3">Gimnasio Cerebral</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Foco Profundo -->
          <div class="p-4 rounded-lg" style="background: linear-gradient(135deg,var(--sun),#fff7e3)">
            <h3 class="font-semibold mb-2">Foco Profundo (Puzzle / Streak)</h3>

            <div id="card-puzzle" class="mb-3 p-3 rounded-lg bg-white card">
              <div class="flex justify-between items-center mb-2">
                <div class="text-sm font-medium">Puzzle Rating <span id="puzzleValue" class="text-slate-500 text-sm"></span></div>
                <div id="puzzleTrophy"></div>
              </div>
              <div class="xp-bar-bg">
                <div id="puzzleBar" class="xp-bar-fill" style="width:0%; background: linear-gradient(90deg,#ffd9a8,#b9f7d0);"></div>
              </div>
              <div class="text-xs text-slate-500 mt-1">Resueltos: <span id="puzzlePlayed"></span></div>
            </div>

            <div id="card-streak" class="p-3 rounded-lg bg-white card">
              <div class="flex justify-between items-center mb-2">
                <div class="text-sm font-medium">Streak <span id="streakValue" class="text-slate-500 text-sm"></span></div>
                <div id="streakTrophy"></div>
              </div>
              <div class="xp-bar-bg">
                <div id="streakBar" class="xp-bar-fill" style="width:0%; background: linear-gradient(90deg,#bff3d0,#d7c8ff);"></div>
              </div>
              <div class="text-xs text-slate-500 mt-1">Intentos: <span id="streakAttempts"></span></div>
            </div>
          </div>

          <!-- Reacción Extrema -->
          <div class="p-4 rounded-lg" style="background: linear-gradient(135deg,#E6F7FF,#FCEAF7)">
            <h3 class="font-semibold mb-2">Reacción Extrema (Racer / Storm)</h3>

            <div id="card-racer" class="mb-3 p-3 rounded-lg bg-white card">
              <div class="flex justify-between items-center mb-2">
                <div class="text-sm font-medium">Racer <span id="racerValue" class="text-slate-500 text-sm"></span></div>
                <div id="racerTrophy"></div>
              </div>
              <div class="xp-bar-bg">
                <div id="racerBar" class="xp-bar-fill" style="width:0%; background: linear-gradient(90deg,#ffd9a8,#bff3d0);"></div>
              </div>
              <div class="text-xs text-slate-500 mt-1">Intentos: <span id="racerAttempts"></span></div>
            </div>

            <div id="card-storm" class="p-3 rounded-lg bg-white card">
              <div class="flex justify-between items-center mb-2">
                <div class="text-sm font-medium">Storm <span id="stormValue" class="text-slate-500 text-sm"></span></div>
                <div id="stormTrophy"></div>
              </div>
              <div class="xp-bar-bg">
                <div id="stormBar" class="xp-bar-fill" style="width:0%; background: linear-gradient(90deg,#c6f0ff,#ffd9a8);"></div>
              </div>
              <div class="text-xs text-slate-500 mt-1">Intentos: <span id="stormAttempts"></span></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-6 text-xs text-slate-500">
      <p>Diseño: Kid-friendly · Gamificación · Privacidad (solo ID público mostrado)</p>
    </footer>
  </div>

<script>
/*
  SPA JS
  - Carga base.csv y metas.csv (fetch local)
  - Autocomplete en 3+ caracteres por columna Lichess
  - Cargar perfil seleccionado: mostrar ID, avatar consistente, progresos calculados
  - Llamada a Lichess API para ratings actualizados
  - Reglas:
      * Rating progress: (Actual - Base) / (Meta - Base)
      * Si Lichess devuelve rating EXACTO 1500 => se trata como provisional => progrese = 0 (usamos Actual = Base)
      * Contadores: (Actual - Base) / (Meta - Base) (clamp 0..1)
  - Confetti + trofeo cuando un progreso llega a 100%
*/

/* ---------- Utilidades CSV ---------- */
async function fetchText(path){
  try {
    const r = await fetch(path);
    if(!r.ok) throw new Error('no file');
    return await r.text();
  } catch(e){
    console.warn('No se pudo cargar', path, e);
    return null;
  }
}

function parseCSV(text){
  // Simple CSV parser: assumes header in first line, comma separated, no quoted commas.
  if(!text) return [];
  const lines = text.trim().split(/\r?\n/).filter(Boolean);
  if(lines.length < 1) return [];
  const headers = lines[0].split(',').map(h => h.trim());
  const rows = lines.slice(1).map(line => {
    const cols = line.split(',').map(c => c.trim());
    const obj = {};
    headers.forEach((h,i) => obj[h] = cols[i] ?? '');
    return obj;
  });
  return { headers, rows };
}

/* ---------- App State ---------- */
let BASE = [];   // array of objects from base.csv
let METAS = null; // object from first row of metas.csv
let current = null; // selected user object (from BASE)
let lichessCache = {}; // cache of API responses

/* ---------- DOM refs ---------- */
const searchInput = document.getElementById('searchInput');
const suggestions = document.getElementById('suggestions');
const publicIdEl = document.getElementById('publicId');
const avatarEl = document.getElementById('avatar');
const liveStatus = document.getElementById('liveStatus');

const reloadBtn = document.getElementById('reloadCsv');
const refreshLichessBtn = document.getElementById('refreshLichess');
const demoConfettiBtn = document.getElementById('demoConfetti');

/* Stat references mapping */
const statsMap = {
  Bullet: { valEl: 'bulletValue', barEl: 'bulletBar', gamesEl: 'bulletGames', trophyEl: 'bulletTrophy', baseKey: 'Bullet', gamesKey: 'Bullet_Games' },
  Blitz:  { valEl: 'blitzValue',  barEl: 'blitzBar',  gamesEl: 'blitzGames',  trophyEl: 'blitzTrophy',  baseKey: 'Blitz',  gamesKey: 'Blitz_Games' },
  Rapid:  { valEl: 'rapidValue',  barEl: 'rapidBar',  gamesEl: 'rapidGames',  trophyEl: 'rapidTrophy',  baseKey: 'Rapid',  gamesKey: 'Rapid_Games' },
  Classical:{ valEl:'classicalValue', barEl:'classicalBar', gamesEl:'classicalGames', trophyEl:'classicalTrophy', baseKey:'Classical', gamesKey:'Classical_Games' },
  Puzzle_Rating:{ valEl:'puzzleValue', barEl:'puzzleBar', gamesEl:'puzzlePlayed', trophyEl:'puzzleTrophy', baseKey:'Puzzle_Rating', gamesKey:'Puzzles_Played' },
  Streak:{ valEl:'streakValue', barEl:'streakBar', gamesEl:'streakAttempts', trophyEl:'streakTrophy', baseKey:'Streak', gamesKey:'Streak_Attempts' },
  Racer:{ valEl:'racerValue', barEl:'racerBar', gamesEl:'racerAttempts', trophyEl:'racerTrophy', baseKey:'Racer', gamesKey:'Racer_Attempts' },
  Storm:{ valEl:'stormValue', barEl:'stormBar', gamesEl:'stormAttempts', trophyEl:'stormTrophy', baseKey:'Storm', gamesKey:'Storm_Attempts' }
};

/* ---------- Avatar: deterministic from lichess id & gender ---------- */
function stableHashToIndex(str, min=1, max=9){
  // simple hash: sum of char codes mod range
  let sum = 0;
  for(let i=0;i<str.length;i++) sum = (sum*31 + str.charCodeAt(i)) >>> 0;
  const idx = (sum % (max - min + 1)) + min;
  return idx;
}

function avatarForUser(lichessId, gender){
  const idx = stableHashToIndex(lichessId,1,9);
  if(gender && gender.toLowerCase()==='f'){
    return `peoncitas/peoncitas_${idx}.png`;
  } else {
    return `peoncitos/peoncitos_${idx}.png`;
  }
}

/* ---------- Progress calculation ---------- */
function computeProgress(baseNum, actualNum, metaNum, isRating=false){
  // Parse numbers safely
  const b = Number(baseNum) || 0;
  const a = Number(actualNum) || 0;
  const m = Number(metaNum) || b; // if meta missing, avoid div by 0
  // If meta equals base, no progress possible (return 0)
  if (m === b) return 0;
  let prog = (a - b) / (m - b);
  if(isNaN(prog)) prog = 0;
  // clamp 0..1
  prog = Math.max(0, Math.min(1, prog));
  return prog;
}

/* Special rating rule:
   If Lichess returns rating EXACT 1500, treat as provisional -> progress = 0.
   We'll implement by returning null to indicate "ignore Lichess actual" so we use base (so progress 0).
*/
function applyRatingRuleFromLichess(rating){
  if (rating === 1500) return null;
  return rating;
}

/* ---------- UI update functions ---------- */
function clearSuggestions(){ suggestions.innerHTML = ''; }

function showSuggestions(list){
  suggestions.innerHTML = '';
  if(!list.length) return;
  const frag = document.createDocumentFragment();
  list.forEach(id => {
    const li = document.createElement('li');
    li.className = 'p-2 rounded hover:bg-slate-100 cursor-pointer';
    li.textContent = id;
    li.addEventListener('click', () => {
      selectUserByLichessId(id);
      clearSuggestions();
      searchInput.value = id;
    });
    frag.appendChild(li);
  });
  suggestions.appendChild(frag);
}

function setSelectedInfo(lichessId, gender){
  publicIdEl.textContent = lichessId;
  avatarEl.src = avatarForUser(lichessId, gender);
  avatarEl.alt = `${lichessId}-avatar`;
}

/* Set a bar width visually with animation */
function setBar(el, pct){
  const bar = document.getElementById(el);
  if(!bar) return;
  bar.style.width = `${Math.round(pct*100)}%`;
}

/* show trophy icon in container */
function showTrophy(containerId){
  const c = document.getElementById(containerId);
  if(!c) return;
  c.innerHTML = `<svg class="trophy" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M7 4h10v2a5 5 0 01-3 4.58V12a6 6 0 11-4 0v-1.42A5 5 0 017 6V4z" fill="#FFD166"/>
    <circle cx="17" cy="7" r="1" fill="#FF9F1C"/>
  </svg>`;
}

/* ---------- Confetti ---------- */
function launchConfetti(){
  // full screen burst
  confetti({
    particleCount: 120,
    spread: 80,
    origin: { y: 0.6 }
  });
}

/* ---------- Load CSVs ---------- */
async function loadCSVs(){
  const baseTxt = await fetchText('base.csv');
  const metasTxt = await fetchText('metas.csv');

  const baseParsed = parseCSV(baseTxt);
  const metasParsed = parseCSV(metasTxt);

  if(!baseParsed.rows.length) {
    alert('No se encontró base.csv o está vacío. Añade base.csv en la misma carpeta.');
    BASE = [];
    METAS = null;
    return;
  }
  BASE = baseParsed.rows;
  METAS = metasParsed.rows && metasParsed.rows[0] ? metasParsed.rows[0] : null;
  // normalize some keys: trim spaces in headers (in case)
  console.log('CSV cargados: BASE:', BASE.length, 'METAS:', METAS ? 'sí' : 'no');
}

/* ---------- Autocomplete logic ---------- */
function searchLichessIds(q){
  if(!q || q.length < 3) return [];
  const lower = q.toLowerCase();
  // search Lichess column
  const ids = BASE.map(r => r['Lichess'] || '').filter(Boolean);
  const unique = [...new Set(ids)];
  return unique.filter(id => id.toLowerCase().includes(lower)).slice(0,10);
}

/* ---------- Selecting a user ---------- */
async function selectUserByLichessId(lichessId){
  const record = BASE.find(r => (r['Lichess'] || '').toLowerCase() === lichessId.toLowerCase());
  if(!record){
    alert('Usuario no encontrado en base.csv');
    return;
  }
  current = record;
  // privacy: only show lichess id publicly
  setSelectedInfo(lichessId, record['Género'] || record['Genero'] || record['Genero'] || record['Gender'] || record['género']);

  // show placeholder live status
  liveStatus.textContent = 'Consultando Lichess...';

  // Fetch Lichess API (and cache)
  const lichessData = await fetchLichessUser(lichessId);

  // Update cards with progression
  updateAllCards(lichessData);
}

/* ---------- Fetch Lichess API ---------- */
async function fetchLichessUser(lichessId){
  if(!lichessId) return null;
  // cached for session
  if(lichessCache[lichessId]) return lichessCache[lichessId];
  try {
    const r = await fetch(`https://lichess.org/api/user/${encodeURIComponent(lichessId)}`);
    if(!r.ok) throw new Error('no user');
    const data = await r.json();
    lichessCache[lichessId] = data;
    return data;
  } catch(e){
    console.warn('Lichess fetch failed:', e);
    lichessCache[lichessId] = null;
    return null;
  }
}

/* ---------- Update UI for all stats ---------- */
function updateAllCards(lichessData){
  if(!current){
    console.warn('No current user');
    return;
  }
  // For each stat, compute actual value:
  // For rating categories, prefer Lichess rating if present (and not provisional 1500)
  // For games/attempts counters we read from BASE (these are local counters), but user may want live updates via Lichess for some modes (we only use Lichess rating numbers when present).
  // Implementation choice: Use Lichess for Bullet/Blitz/Rapid/Classical ratings when available; for counters, use BASE only.
  const meta = METAS || {};
  const lichess = lichessData || {};

  // Live status
  if(lichessData) {
    liveStatus.textContent = `Lichess: datos cargados (última actividad: ${lichessData.seen ? new Date(lichessData.seen).toLocaleString() : 'n/d'})`;
  } else {
    liveStatus.textContent = 'Lichess: no disponible';
  }

  // Helper to get Lichess rating by perf type
  function lichessRatingFor(perf){
    if(!lichess || !lichess.perfs) return null;
    if(!lichess.perfs[perf]) return null;
    const r = lichess.perfs[perf].rating;
    return typeof r === 'number' ? r : null;
  }

  // Mapping: base keys to perf names
  const perfMap = {
    Bullet: 'bullet',
    Blitz: 'blitz',
    Rapid: 'rapid',
    Classical: 'classical'
  };

  // For each stat in statsMap
  Object.entries(statsMap).forEach(([key, cfg]) => {
    const baseKey = cfg.baseKey;
    // Base value from CSV
    const baseVal = current[baseKey] || 0;
    // Meta value from metas.csv
    const metaVal = meta[baseKey] ?? baseVal;

    let actualVal = baseVal; // default

    // Ratings: use Lichess when available
    if (key === 'Bullet' || key === 'Blitz' || key === 'Rapid' || key === 'Classical'){
      const perf = perfMap[key];
      let lichessRating = lichessRatingFor(perf);
      // Special rule: If lichess returns EXACT 1500 -> treat as provisional -> ignore -> set actualVal = baseVal => progress 0
      if (lichessRating === 1500){
        lichessRating = null; // ignore
      }
      if (lichessRating != null){
        actualVal = lichessRating;
      } else {
        // fall back to CSV base if no lichess rating
        actualVal = Number(baseVal) || 0;
      }
      // Compute progress
      const prog = computeProgress(baseVal, actualVal, metaVal, true);
      setBar(cfg.barEl, prog);
      // Show textual value: show actual rating (but we must NOT expose real name) — showing rating is permitted
      document.getElementById(cfg.valEl).textContent = `${Math.round(actualVal)}`;
      // games counters (from CSV)
      const games = current[cfg.gamesKey] || 0;
      document.getElementById(cfg.gamesEl).textContent = games;

      // Trophy on 100%
      if (prog >= 0.999){
        showTrophy(cfg.trophyEl);
        launchConfetti();
      } else {
        document.getElementById(cfg.trophyEl).innerHTML = '';
      }

    } else {
      // Counters / attempts: use actual value from CSV as "actual"
      const actual = Number(current[ cfg.baseKey ]) || 0;
      const metaN = Number(metaVal) || actual;
      const prog = computeProgress(baseVal, actual, metaN, false);
      setBar(cfg.barEl, prog);
      // textual value: show actual
      document.getElementById(cfg.valEl).textContent = `${actual}`;
      document.getElementById(cfg.gamesEl).textContent = current[cfg.gamesKey] ?? 0;

      if (prog >= 0.999){
        showTrophy(cfg.trophyEl);
        launchConfetti();
      } else {
        document.getElementById(cfg.trophyEl).innerHTML = '';
      }
    }
  });
}

/* ---------- Event handlers ---------- */
searchInput.addEventListener('input', (e) => {
  const q = e.target.value.trim();
  if(q.length >= 3){
    const results = searchLichessIds(q);
    showSuggestions(results);
  } else {
    clearSuggestions();
  }
});

reloadBtn.addEventListener('click', async () => {
  await loadCSVs();
  alert('CSV recargados.');
});

refreshLichessBtn.addEventListener('click', async () => {
  if(!current) { alert('Selecciona un alumno primero'); return; }
  liveStatus.textContent = 'Actualizando desde Lichess...';
  const lichessData = await fetchLichessUser(current['Lichess']);
  updateAllCards(lichessData);
});

demoConfettiBtn.addEventListener('click', () => {
  launchConfetti();
});

/* Keyboard: Enter to select first suggestion */
searchInput.addEventListener('keydown', (e) => {
  if(e.key === 'Enter'){
    const q = searchInput.value.trim();
    if(q) selectUserByLichessId(q);
  }
});

/* ---------- Init ---------- */
(async function init(){
  await loadCSVs();
  // Preload first user if available
  if(BASE.length){
    const first = BASE[0];
    // do not auto-show name — only set a placeholder public ID
    setSelectedInfo(first['Lichess'] || '—', first['Género'] || first['Genero']);
  }
})();
</script>

