<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Club de Ajedrez - Dashboard Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #f0fdf4;
            background-image: radial-gradient(#dcfce7 15%, transparent 16%), radial-gradient(#dcfce7 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
        }

        .card-meta {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom-width: 5px;
        }
        
        .card-meta:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .xp-bar-container {
            height: 12px;
            background: #e2e8f0;
            border-radius: 999px;
            overflow: hidden;
            border: 1px solid #cbd5e1;
        }

        .xp-bar-fill {
            height: 100%;
            transition: width 1.5s ease-out;
            background-image: linear-gradient(90deg, #6366f1, #a855f7);
        }

        .xp-bar-frozen {
            background: repeating-linear-gradient(45deg, #bae6fd, #bae6fd 10px, #7dd3fc 10px, #7dd3fc 20px);
            opacity: 0.7;
        }

        .avatar-main {
            width: 100px;
            height: 100px;
            border-radius: 24px;
            border: 4px solid white;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            object-fit: cover;
        }

        .zone-box {
            border-radius: 32px;
            overflow: hidden;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
        }

        .badge-level {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 2px 12px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="min-h-screen text-gray-800 pb-12">

    <div class="max-w-5xl mx-auto px-4 pt-8">
        <!-- Header -->
        <header class="text-center mb-12">
            <div class="inline-block bg-white px-8 py-4 rounded-full shadow-lg border-2 border-indigo-100 mb-4">
                <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 flex items-center gap-3">
                    <span>üèÜ</span> Club de Ajedrez <span>‚ôüÔ∏è</span>
                </h1>
            </div>
            <p class="text-indigo-400 font-medium">Panel de Alto Rendimiento y Seguimiento de Metas</p>
        </header>

        <!-- Buscador Estilo Original -->
        <div class="max-w-md mx-auto mb-12 relative">
            <input type="text" id="user-search" placeholder="Busca tu usuario de Lichess..." 
                   class="w-full px-6 py-4 rounded-2xl border-2 border-indigo-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all text-lg font-semibold text-gray-700 shadow-sm">
            <div id="search-suggestions" class="absolute z-50 w-full mt-2 bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden hidden"></div>
        </div>

        <div id="status-container" class="hidden text-center p-8"></div>

        <!-- Dashboard de Usuario -->
        <div id="progress-dashboard" class="hidden space-y-10">
            
            <!-- Cabecera Perfil -->
            <div class="bg-white p-6 md:p-8 rounded-[40px] shadow-sm border border-gray-100 flex flex-col md:flex-row items-center gap-8 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor"><path d="M19 22H5V20H19V22M17 18H7V16H17V18M15 14H9V2H15V14Z"/></svg>
                </div>

                <img id="player-avatar" src="avatars/m1.png" alt="Avatar" class="avatar-main bg-indigo-50">
                
                <div class="text-center md:text-left">
                    <div class="flex flex-wrap items-center justify-center md:justify-start gap-3 mb-2">
                        <h2 id="player-name" class="text-4xl font-extrabold text-gray-800">Cargando...</h2>
                        <span id="player-level-badge" class="badge-level">Nivel 1</span>
                    </div>
                    <p id="player-rank-desc" class="text-indigo-400 font-bold mb-4">Iniciando el camino del maestro...</p>
                    <div class="flex gap-2 justify-center md:justify-start">
                        <a id="player-link" href="#" target="_blank" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-xl text-sm font-bold hover:bg-indigo-100 transition-colors">Perfil Lichess ‚Üó</a>
                    </div>
                </div>
            </div>

            <!-- Contenedor de Zonas (Metas) -->
            <div id="zones-container" class="space-y-12"></div>

            <!-- Partidas Emblem√°ticas (Restaurado) -->
            <div class="zone-box bg-white border-t-8 border-orange-400">
                <div class="p-6 bg-orange-50/50 flex items-center justify-between cursor-pointer" onclick="toggleZone('games')">
                    <h3 class="text-2xl font-bold text-orange-700">‚≠ê Partidas Emblem√°ticas</h3>
                    <span id="icon-games" class="text-2xl transition-transform">‚ñº</span>
                </div>
                <div id="content-games" class="p-6 hidden grid grid-cols-1 md:grid-cols-2 gap-6 bg-white">
                    <div id="games-grid" class="col-span-full grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                </div>
            </div>

            <!-- Entrenamiento (Restaurado 4 opciones) -->
            <div class="zone-box bg-white border-t-8 border-green-400">
                <div class="p-6 bg-green-50/50 flex items-center justify-between cursor-pointer" onclick="toggleZone('train')">
                    <h3 class="text-2xl font-bold text-green-700">üéì Zona de Entrenamiento</h3>
                    <span id="icon-train" class="text-2xl transition-transform">‚ñº</span>
                </div>
                <div id="content-train" class="p-6 hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 bg-white">
                    <a href="https://lichess.org/learn" target="_blank" class="p-4 bg-gray-50 rounded-2xl border-b-4 border-gray-200 hover:border-green-400 hover:bg-green-50 transition-all text-center group">
                        <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">‚ôüÔ∏è</div>
                        <div class="font-bold text-gray-700">Aprender</div>
                    </a>
                    <a href="https://lichess.org/practice" target="_blank" class="p-4 bg-gray-50 rounded-2xl border-b-4 border-gray-200 hover:border-green-400 hover:bg-green-50 transition-all text-center group">
                        <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">üéì</div>
                        <div class="font-bold text-gray-700">Pr√°ctica</div>
                    </a>
                    <a href="https://lichess.org/training" target="_blank" class="p-4 bg-gray-50 rounded-2xl border-b-4 border-gray-200 hover:border-green-400 hover:bg-green-50 transition-all text-center group">
                        <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">üß©</div>
                        <div class="font-bold text-gray-700">T√°ctica</div>
                    </a>
                    <a href="https://lichess.org/storm" target="_blank" class="p-4 bg-gray-50 rounded-2xl border-b-4 border-gray-200 hover:border-green-400 hover:bg-green-50 transition-all text-center group">
                        <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">‚ö°</div>
                        <div class="font-bold text-gray-700">Storm</div>
                    </a>
                </div>
            </div>

        </div>
    </div>

    <script>
        const CSV_BASE = 'base.csv';
        const CSV_METAS = 'metas.csv';
        const MIN_ACTIVITY = 20;

        let players = [];
        let allMetas = [];

        const metricConfig = [
            { id: 'bullet', name: 'Bullet', emoji: 'üöÖ', key: 'Bullet', countKey: 'Bullet_Games', zone: 'Velocidad', api: 'perfs.bullet', color: 'border-red-400', bg: 'bg-red-50' },
            { id: 'blitz', name: 'Blitz', emoji: '‚ö°', key: 'Blitz', countKey: 'Blitz_Games', zone: 'Velocidad', api: 'perfs.blitz', color: 'border-yellow-400', bg: 'bg-yellow-50' },
            { id: 'rapid', name: 'Rapid', emoji: 'üê¢', key: 'Rapid', countKey: 'Rapid_Games', zone: 'Estrategia', api: 'perfs.rapid', color: 'border-green-400', bg: 'bg-green-50' },
            { id: 'puzzle', name: 'Puzzles', emoji: 'üß©', key: 'Puzzle_Rating', countKey: 'Puzzles_Played', zone: 'Gimnasio', api: 'perfs.puzzle', color: 'border-purple-400', bg: 'bg-purple-50' },
            { id: 'storm', name: 'Storm', emoji: 'üå™Ô∏è', key: 'Storm', countKey: 'Storm_Runs', zone: 'Gimnasio', api: 'perfs.storm', color: 'border-blue-400', bg: 'bg-blue-50' }
        ];

        async function init() {
            try {
                const [baseRes, metasRes] = await Promise.all([
                    fetch(CSV_BASE).then(r => r.text()),
                    fetch(CSV_METAS).then(r => r.text())
                ]);

                players = parseCSV(baseRes);
                allMetas = parseCSV(metasRes);
                
                document.getElementById('user-search').addEventListener('input', handleSearch);
            } catch (e) {
                console.error("Error cargando datos", e);
            }
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(/[,\t;]/).map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(/[,\t;]/).map(v => v.trim());
                let obj = {};
                headers.forEach((h, i) => obj[h] = isNaN(values[i]) || values[i] === '' ? values[i] : Number(values[i]));
                return obj;
            });
        }

        function getLevelInfo(rating) {
            if (rating >= 2000) return { name: 'Rey del Tablero', lvl: 'MAX', desc: 'Dominio absoluto de la estrategia.' };
            if (rating >= 1800) return { name: 'Maestro Local', lvl: '5', desc: 'Tus jugadas inspiran respeto.' };
            if (rating >= 1600) return { name: 'Caballero Avanzado', lvl: '4', desc: 'Un estratega s√≥lido y audaz.' };
            if (rating >= 1400) return { name: 'Alfil Guerrero', lvl: '3', desc: 'Dominando el centro del campo.' };
            if (rating >= 1200) return { name: 'Caballo Veloz', lvl: '2', desc: 'Saltando hacia la maestr√≠a.' };
            return { name: 'Pe√≥n Valiente', lvl: '1', desc: 'Cada paso adelante cuenta.' };
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            const suggestions = document.getElementById('search-suggestions');
            if (query.length < 2) { suggestions.classList.add('hidden'); return; }

            const matches = players.filter(p => p.Lichess?.toLowerCase().includes(query)).slice(0, 5);
            suggestions.innerHTML = '';
            if (matches.length > 0) {
                suggestions.classList.remove('hidden');
                matches.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'p-4 hover:bg-indigo-50 cursor-pointer font-bold text-gray-700 border-b last:border-0';
                    div.textContent = p.Lichess;
                    div.onclick = () => {
                        suggestions.classList.add('hidden');
                        document.getElementById('user-search').value = p.Lichess;
                        loadUser(p.Lichess);
                    };
                    suggestions.appendChild(div);
                });
            }
        }

        async function loadUser(username) {
            const container = document.getElementById('status-container');
            container.classList.remove('hidden');
            container.innerHTML = '<div class="text-indigo-500 font-bold animate-pulse">Consultando Lichess...</div>';

            try {
                const res = await fetch(`https://lichess.org/api/user/${username}`);
                const data = await res.json();
                const playerBase = players.find(p => p.Lichess === username);
                const playerMetas = allMetas.find(m => m.Lichess === username) || {};

                renderUser(playerBase, data, playerMetas);
                container.classList.add('hidden');
                document.getElementById('progress-dashboard').classList.remove('hidden');
            } catch (e) {
                container.innerHTML = '<div class="text-red-500 font-bold">Error al cargar datos de Lichess.</div>';
            }
        }

        function renderUser(base, live, metas) {
            // Perfil
            document.getElementById('player-name').textContent = base.Lichess;
            
            // Avatar por g√©nero
            const gen = String(base.Gen || 'M').toUpperCase();
            document.getElementById('player-avatar').src = gen === 'F' ? 'avatars/f1.png' : 'avatars/m1.png';
            
            const ratingAvg = (live.perfs.blitz.rating + live.perfs.rapid.rating) / 2;
            const lvl = getLevelInfo(ratingAvg);
            document.getElementById('player-level-badge').textContent = `Nivel ${lvl.lvl}`;
            document.getElementById('player-rank-desc').textContent = `${lvl.name} ‚Ä¢ ${lvl.desc}`;
            document.getElementById('player-link').href = `https://lichess.org/@/${base.Lichess}`;

            // Metas
            const zones = ['Velocidad', 'Estrategia', 'Gimnasio'];
            const container = document.getElementById('zones-container');
            container.innerHTML = '';

            zones.forEach(zoneName => {
                const zoneMetrics = metricConfig.filter(m => m.zone === zoneName);
                const zoneId = zoneName.toLowerCase();
                
                let html = `
                    <div class="zone-box bg-white border-t-8 ${zoneName === 'Velocidad' ? 'border-sky-400' : (zoneName === 'Gimnasio' ? 'border-purple-400' : 'border-emerald-400')}">
                        <div class="p-6 bg-gray-50 flex items-center justify-between cursor-pointer" onclick="toggleZone('${zoneId}')">
                            <h3 class="text-2xl font-bold text-gray-700">${zoneName === 'Velocidad' ? 'üöÄ Arena de Velocidad' : (zoneName === 'Gimnasio' ? 'üß† Gimnasio Cerebral' : 'üõ°Ô∏è Estrategia y Control')}</h3>
                            <span id="icon-${zoneId}" class="text-2xl transition-transform">‚ñº</span>
                        </div>
                        <div id="content-${zoneId}" class="p-6 hidden grid grid-cols-1 lg:grid-cols-2 gap-6 bg-white">
                `;

                zoneMetrics.forEach(m => {
                    const apiData = m.api.split('.').reduce((o, i) => o[i], live);
                    const currentVal = apiData.rating || apiData.score || 0;
                    const currentGames = apiData.games || apiData.runs || 0;
                    
                    const initVal = base[m.key] || 0;
                    const goalVal = metas[m.key] || 0;
                    const initGames = base[m.countKey] || 0;

                    const isFrozen = (currentGames - initGames) < MIN_ACTIVITY;
                    const progressVal = currentVal - initVal;
                    const needed = goalVal - initVal;
                    const percent = needed > 0 ? (progressVal / needed) * 100 : 0;
                    const displayPercent = Math.min(100, Math.max(0, percent));

                    html += `
                        <div class="card-meta flex flex-col md:flex-row items-center gap-4 p-5 rounded-3xl ${m.bg} border-b-4 ${m.color}">
                            <div class="text-4xl md:text-5xl">${m.emoji}</div>
                            <div class="flex-1 w-full">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-extrabold text-gray-800">${m.name}</span>
                                    <span class="text-[10px] font-bold ${isFrozen ? 'text-blue-400' : 'text-green-500'}">
                                        ${isFrozen ? '‚ùÑÔ∏è CONGELADO' : 'üî• ACTIVO'}
                                    </span>
                                </div>
                                <div class="xp-bar-container mb-2">
                                    <div class="xp-bar-fill ${isFrozen ? 'xp-bar-frozen' : ''}" style="width: 0%" data-pct="${displayPercent}"></div>
                                </div>
                                <div class="flex justify-between items-end">
                                    <div>
                                        <div class="text-2xl font-black text-gray-800">${currentVal}</div>
                                        <div class="text-[10px] font-bold text-gray-400 uppercase">Progreso: <span class="${progressVal >= 0 ? 'text-green-500' : 'text-red-400'}">${progressVal >= 0 ? '+' : ''}${progressVal}</span></div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs font-bold text-indigo-500">${Math.round(percent)}%</div>
                                        <div class="text-[10px] font-bold text-gray-400 uppercase">Meta: ${goalVal}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
                container.innerHTML += html;
            });

            // Juegos Emblem√°ticos
            const gamesGrid = document.getElementById('games-grid');
            const games = [base.Game1, base.Game2].filter(g => g && g !== 'none');
            gamesGrid.innerHTML = games.length ? '' : '<p class="text-gray-400 italic">No hay partidas registradas.</p>';
            games.forEach(gid => {
                gamesGrid.innerHTML += `
                    <div class="rounded-2xl overflow-hidden border border-gray-100 shadow-sm">
                        <iframe src="https://lichess.org/embed/${gid}?theme=auto&bg=auto" width="100%" height="380" frameborder="0"></iframe>
                    </div>
                `;
            });
        }

        function toggleZone(id) {
            const content = document.getElementById(`content-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            const isHidden = content.classList.contains('hidden');
            
            content.classList.toggle('hidden');
            icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';

            if (isHidden) {
                const bars = content.querySelectorAll('[data-pct]');
                setTimeout(() => {
                    bars.forEach(b => b.style.width = b.getAttribute('data-pct') + '%');
                }, 50);
            }
        }

        init();
    </script>
</body>
</html>