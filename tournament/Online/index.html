<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados de Torneos</title>
    
    <!-- CSS INTEGRADO -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap');

        :root {
            --primary-color: #3f51b5;
            --secondary-color: #ffc107;
            --bg-light: #f7f9fc;
            --text-dark: #2c3e50;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        header {
            background: var(--primary-color);
            color: #fff;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        header a {
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 700;
            transition: color 0.3s;
        }
        
        header a:hover { color: #fff; }

        main {
            width: 90%;
            max-width: 1200px;
            margin: auto;
            padding: 10px 0;
        }

        section {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: var(--primary-color);
            font-weight: 700;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--secondary-color);
            margin-bottom: 20px;
        }

        .card-grid { display: grid; gap: 20px; }
        #podio .card-grid { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }

        .podium-card {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        .podium-card:hover { transform: translateY(-5px); }
        .podium-card h3 { margin-top: 0; font-size: 1.3em; font-weight: 700; }

        .rank-1 { background-color: #ffd70030; border-top: 5px solid #ffd700; }
        .rank-2 { background-color: #c0c0c030; border-top: 5px solid #c0c0c0; }
        .rank-3 { background-color: #cd7f3230; border-top: 5px solid #cd7f32; }

        .cat-u1600 { background-color: #e3f2fd; border-top: 4px solid #2196f3; }
        .cat-u1200 { background-color: #e8f5e9; border-top: 4px solid #4caf50; }
        .cat-u800 { background-color: #fff3e0; border-top: 4px solid #ff9800; }

        #statsList { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); }
        
        .stat-item {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-item strong { display: block; font-size: 1.8em; line-height: 1.2; }
        .stat-item span { font-size: 0.85em; opacity: 0.9; }
        .stat-avg-rating { background-color: #1abc9c; }

        .partida-container {
            margin-top: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        .partida-container h3 {
            color: var(--text-dark);
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        .partida-container iframe {
            max-width: 100%; 
            height: 450px; 
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: none;
        }
        
        /* Estilos Selector */
        #selector-area {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        select {
            padding: 10px;
            font-size: 1rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 100%;
            max-width: 400px;
            cursor: pointer;
        }
        label { font-weight: bold; margin-bottom: 5px; display: block; }

        @media (max-width: 768px) {
            header h1 { font-size: 1.5em; }
            main { width: 95%; padding: 15px; }
            #statsList { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <header>
        <h1 id="torneoNombre">Cargando...</h1>
        <p>Enlace Directo: <a id="torneoLink" href="#" target="_blank">Ver en Lichess</a></p>

        <!-- SELECTOR DE TORNEO (Desde CSV) -->
        <div id="selector-area">
            <label for="csv-selector">Selecciona un Torneo:</label>
            <select id="csv-selector">
                <option value="">Cargando lista de torneos...</option>
            </select>
        </div>
    </header>

    <main id="content-area" style="opacity: 0.5; pointer-events: none;"> <!-- Deshabilitado hasta cargar -->
        
        <!-- SECCI√ìN 1: Podio -->
        <section id="podio">
            <h2>ü•á Podio y Ganadores ü•á</h2>
            <div class="card-grid">
                <div id="card-1" class="podium-card rank-1"><h3>1er Lugar</h3><p id="winner-1">-</p></div>
                <div id="card-2" class="podium-card rank-2"><h3>2do Lugar</h3><p id="winner-2">-</p></div>
                <div id="card-3" class="podium-card rank-3"><h3>3er Lugar</h3><p id="winner-3">-</p></div>
            </div>
        </section>
        
        <!-- SECCI√ìN 1.5: Premios por Categor√≠a -->
        <section id="premios-categoria">
            <h2>üåü Mejores por Categor√≠a üåü</h2>
            <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="podium-card cat-u1600"><h3>Mejor Sub-1600</h3><p id="best-u1600">-</p></div>
                <div class="podium-card cat-u1200"><h3>Mejor Sub-1200</h3><p id="best-u1200">-</p></div>
                <div class="podium-card cat-u800"><h3>Mejor Sub-800</h3><p id="best-u800">-</p></div>
            </div>
        </section>

        <!-- SECCI√ìN 2: Estad√≠sticas -->
        <section id="resultados-completos">
            <h2>üìä Estad√≠sticas del Torneo</h2>
            <div id="stats" class="card-grid">
                 <ul id="statsList" class="card-grid">
                    <li class="stat-item stat-avg-rating"><strong id="stat-avg-rating">-</strong> <span>Rating Promedio</span></li>
                    <li class="stat-item"><strong id="stat-players">0</strong> <span>Participantes</span></li>
                    <li class="stat-item"><strong id="stat-games">0</strong> <span>Partidas Jugadas</span></li>
                    <li class="stat-item"><strong id="stat-moves">0</strong> <span>Movimientos Totales</span></li>
                    <li class="stat-item" style="background-color: #6699ff;"><strong id="stat-white">0%</strong> <span>Victorias Blancas</span></li>
                    <li class="stat-item" style="background-color: #333333;"><strong id="stat-black">0%</strong> <span>Victorias Negras</span></li>
                    <li class="stat-item" style="background-color: #999999;"><strong id="stat-draw">0%</strong> <span>Porcentaje de Tablas</span></li>
                    <li class="stat-item" style="background-color: #ff6666;"><strong id="stat-berserk">0%</strong> <span>Tasa de Berserk</span></li>
                 </ul>
            </div>
        </section>
        
        <!-- SECCI√ìN 3: Partidas Destacadas -->
        <section id="partidas-destacadas">
            <h2>‚ôüÔ∏è Partidas Destacadas ‚ôüÔ∏è</h2>
            <div class="partida-container">
                <h3 id="title-game-1">Partida 1: La M√°s Larga</h3>
                <iframe id="game-iframe-1" src="" width="600" height="450" frameborder="0" allowtransparency="true"></iframe>
                <p id="game-1-info" style="font-size: 0.9em; color: #666;"></p>
            </div>
            <div class="partida-container">
                <h3 id="title-game-2">Partida 2: Mayor Nivel</h3>
                 <iframe id="game-iframe-2" src="" width="600" height="450" frameborder="0" allowtransparency="true"></iframe>
                 <p id="game-2-info" style="font-size: 0.9em; color: #666;"></p>
            </div>
        </section>

        <!-- SECCI√ìN 4: Buscador de Jugador -->
        <section id="partidas-jugador">
            <h2>üîç Analizar a un Jugador üîç</h2>
            <div class="player-select-container">
                <select id="player-selector"><option value="">Cargando jugadores...</option></select>
            </div>
            <div id="player-games-area" style="display:none;">
                <div class="partida-container">
                    <h3>Su Partida M√°s Larga</h3>
                    <iframe id="game-iframe-3" src="" width="600" height="450" frameborder="0" allowtransparency="true"></iframe>
                    <p id="game-3-info"></p>
                </div>
                <div class="partida-container">
                    <h3>Su Rival M√°s Duro</h3>
                    <iframe id="game-iframe-4" src="" width="600" height="450" frameborder="0" allowtransparency="true"></iframe>
                    <p id="game-4-info"></p>
                </div>
            </div>
        </section>

    </main>

    <script>
        // --- CONFIGURACI√ìN ---
        const formatNumber = (num) => (num || 0).toLocaleString('es-ES');
        let tournamentGames = []; // Variable global para guardar partidas

        // 1. CARGAR LISTA DE TORNEOS DESDE CSV
        async function loadTournamentList() {
            try {
                // Petici√≥n al archivo local torneos.csv
                const response = await fetch('torneos.csv');
                if (!response.ok) throw new Error("No se encontr√≥ el archivo torneos.csv");
                
                const text = await response.text();
                const lines = text.trim().split('\n');
                const select = document.getElementById('csv-selector');
                select.innerHTML = ''; // Limpiar

                let firstId = null;

                // Procesar CSV (saltando cabeceras si existen, o asumiendo que no)
                // Formato esperado: ID,NOMBRE
                lines.forEach(line => {
                    const [id, name] = line.split(',');
                    if (id && name && id.length > 4) { // Validaci√≥n simple
                        const option = document.createElement('option');
                        option.value = id.trim();
                        option.textContent = name.trim();
                        select.appendChild(option);
                        if (!firstId) firstId = id.trim();
                    }
                });

                // Listener para cambios
                select.addEventListener('change', (e) => {
                    loadTournamentData(e.target.value);
                });

                // Cargar el primero autom√°ticamente
                if (firstId) {
                    loadTournamentData(firstId);
                } else {
                    document.getElementById('torneoNombre').textContent = "El archivo CSV est√° vac√≠o o incorrecto.";
                }

            } catch (error) {
                console.error(error);
                document.getElementById('torneoNombre').textContent = "Error cargando torneos.csv (Revisa consola)";
                // Fallback visual si no hay CSV (ej: entorno local sin servidor)
                const select = document.getElementById('csv-selector');
                select.innerHTML = '<option>Error: Sube a GitHub o usa Live Server</option>';
            }
        }

        // 2. FUNCI√ìN PRINCIPAL: CARGAR DATOS DE UN ID
        async function loadTournamentData(id) {
            // UI Feedback
            document.getElementById('content-area').style.opacity = "0.5";
            document.getElementById('torneoNombre').textContent = "Cargando datos...";
            
            const detailsUrl = `https://lichess.org/api/tournament/${id}`;
            const resultsUrl = `https://lichess.org/api/tournament/${id}/results`;
            const gamesUrl = `https://lichess.org/api/tournament/${id}/games`; 
            
            document.getElementById('torneoLink').href = `https://lichess.org/tournament/${id}`;

            try {
                // A) DETALLES GENERALES
                const detailsRes = await fetch(detailsUrl);
                if(!detailsRes.ok) throw new Error("Torneo no encontrado");
                const details = await detailsRes.json();

                // Inyectar Textos y Stats
                document.getElementById('torneoNombre').textContent = `üèÜ ${details.fullName} üèÜ`;
                
                const stats = details.stats || {};
                const totalGames = stats.games || 0;
                const calcPct = (val) => totalGames > 0 ? Math.round((val || 0) / totalGames * 100) + '%' : '0%';
                
                document.getElementById('stat-players').textContent = formatNumber(details.nbPlayers);
                document.getElementById('stat-games').textContent = formatNumber(stats.games);
                document.getElementById('stat-moves').textContent = formatNumber(stats.moves);
                document.getElementById('stat-white').textContent = calcPct(stats.whiteWins);
                document.getElementById('stat-black').textContent = calcPct(stats.blackWins);
                document.getElementById('stat-draw').textContent = calcPct(stats.draws);
                // Berserk: se divide entre (partidas * 2)
                document.getElementById('stat-berserk').textContent = totalGames > 0 ? Math.round((stats.berserks || 0) / (totalGames * 2) * 100) + '%' : '0%';

                // B) JUGADORES (PODIO Y CATEGOR√çAS)
                const resultsRes = await fetch(resultsUrl);
                const resultsText = await resultsRes.text();
                // Parseo robusto de ND-JSON
                const players = resultsText.trim().split('\n')
                    .map(line => { try { return JSON.parse(line); } catch(e){return null} })
                    .filter(o => o && (o.username || o.name) && o.rank)
                    .sort((a, b) => a.rank - b.rank);

                // Podio
                const setWinner = (idx, elId) => {
                    const p = players[idx];
                    const el = document.getElementById(elId);
                    if(p) el.innerHTML = `<strong>${p.username || p.name}</strong><br>${p.score} pts`;
                    else el.textContent = "-";
                };
                setWinner(0, 'winner-1');
                setWinner(1, 'winner-2');
                setWinner(2, 'winner-3');

                // Categor√≠as
                const setCat = (limit, elId) => {
                    const p = players.find(x => x.rating < limit && x.rating > 0);
                    const el = document.getElementById(elId);
                    if(p) el.innerHTML = `<strong>#${p.rank} ${p.username || p.name}</strong><br>${p.rating} ELO`;
                    else el.textContent = "Desierto";
                };
                setCat(1600, 'best-u1600');
                setCat(1200, 'best-u1200');
                setCat(800, 'best-u800');

                // Rating Promedio
                const ratedPlayers = players.filter(p => p.rating > 0);
                const avgElo = ratedPlayers.length ? Math.round(ratedPlayers.reduce((a,b)=>a+b.rating,0)/ratedPlayers.length) : "N/A";
                document.getElementById('stat-avg-rating').textContent = avgElo;

                // Llenar Selector de Jugadores
                setupPlayerSelector(players);

                // C) PARTIDAS DESTACADAS (Globales)
                loadFeaturedGames(gamesUrl);

                // Habilitar UI
                document.getElementById('content-area').style.opacity = "1";
                document.getElementById('content-area').style.pointerEvents = "auto";

            } catch (err) {
                console.error(err);
                document.getElementById('torneoNombre').textContent = "‚ùå Error al cargar datos del torneo.";
            }
        }

        // 3. CARGAR PARTIDAS (L√≥gica Autom√°tica)
        async function loadFeaturedGames(gamesUrl) {
            try {
                // Pedir JSON expl√≠citamente
                const res = await fetch(`${gamesUrl}?max=100&clocks=false&evals=false&opening=true`, {
                    headers: { 'Accept': 'application/x-ndjson' }
                });
                const text = await res.text();
                tournamentGames = text.trim().split('\n')
                    .map(line => { try { return JSON.parse(line); } catch(e){return null} })
                    .filter(g => g);

                if (tournamentGames.length === 0) return;

                // 3.1 Partida M√°s Larga (Global)
                let longest = tournamentGames[0];
                let maxMoves = 0;
                tournamentGames.forEach(g => {
                    const m = g.moves ? g.moves.split(' ').length : 0;
                    if(m > maxMoves) { maxMoves = m; longest = g; }
                });
                
                setIframe('game-iframe-1', longest.id);
                setInfo('game-1-info', longest, `Duraci√≥n: ${Math.floor(maxMoves/2)} jugadas`);

                // 3.2 Partida Mayor Nivel (Global)
                let best = tournamentGames[0];
                let maxAvg = 0;
                tournamentGames.forEach(g => {
                    const avg = (getRating(g, 'white') + getRating(g, 'black')) / 2;
                    // Evitar repetir la misma si es posible
                    if(avg > maxAvg && (tournamentGames.length === 1 || g.id !== longest.id)) {
                        maxAvg = avg; best = g;
                    }
                });
                
                setIframe('game-iframe-2', best.id);
                setInfo('game-2-info', best, `ELO Promedio: ${Math.round(maxAvg)}`);

            } catch (e) { console.error("Error partidas", e); }
        }

        // Helpers para UI
        function setIframe(id, gameId) {
            document.getElementById(id).src = `https://lichess.org/embed/${gameId}?theme=blue&bg=light`;
        }
        function getRating(g, color) { return g.players[color].rating || 0; }
        function getName(g, color) { return g.players[color].user ? g.players[color].user.name : "An√≥nimo"; }
        
        function setInfo(elId, g, extra) {
            const w = `${getName(g,'white')} (${getRating(g,'white')})`;
            const b = `${getName(g,'black')} (${getRating(g,'black')})`;
            document.getElementById(elId).textContent = `${w} vs ${b} | ${extra}`;
        }

        // 4. BUSCADOR DE JUGADOR
        function setupPlayerSelector(players) {
            const select = document.getElementById('player-selector');
            select.innerHTML = '<option value="">-- Elige un jugador --</option>';
            // Copia ordenada alfab√©ticamente
            [...players].sort((a,b) => (a.username||"").localeCompare(b.username||""))
                .forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.username || p.name;
                    opt.textContent = p.username || p.name;
                    select.appendChild(opt);
                });
            
            select.onchange = (e) => updatePlayerGames(e.target.value);
        }

        function updatePlayerGames(user) {
            const area = document.getElementById('player-games-area');
            if(!user) { area.style.display = "none"; return; }
            area.style.display = "block";

            // Filtrar partidas del usuario
            const myGames = tournamentGames.filter(g => 
                getName(g,'white') === user || getName(g,'black') === user
            );

            if(myGames.length === 0) {
                document.getElementById('game-3-info').textContent = "Sin partidas disponibles.";
                return;
            }

            // Su m√°s larga
            let longest = myGames[0];
            let maxM = 0;
            myGames.forEach(g => {
                const m = g.moves ? g.moves.split(' ').length : 0;
                if(m > maxM) { maxM = m; longest = g; }
            });
            setIframe('game-iframe-3', longest.id);
            setInfo('game-3-info', longest, `${Math.floor(maxM/2)} jugadas`);

            // Su rival m√°s duro (mayor rating promedio)
            let hardest = myGames[0];
            let maxR = 0;
            myGames.forEach(g => {
                const avg = (getRating(g,'white') + getRating(g,'black'))/2;
                if(avg > maxR && (myGames.length===1 || g.id !== longest.id)) {
                    maxR = avg; hardest = g;
                }
            });
            setIframe('game-iframe-4', hardest.id);
            setInfo('game-4-info', hardest, `Nivel: ${Math.round(maxR)}`);
        }

        // INICIAR
        loadTournamentList();

    </script>
</body>
</html>
