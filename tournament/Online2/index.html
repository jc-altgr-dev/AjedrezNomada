<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe de Resultados del Torneo</title>
    
    <!-- CSS INTEGRADO -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap');

        :root {
            --primary-color: #2c3e50; /* Azul oscuro acad√©mico */
            --secondary-color: #f1c40f; /* Amarillo dorado */
            --accent-color: #3498db; /* Azul claro */
            --bg-light: #ecf0f1;
            --text-dark: #2c3e50;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        header {
            background: var(--primary-color);
            color: #fff;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        header a {
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 700;
            transition: color 0.3s;
        }
        
        header a:hover { color: #fff; }

        main {
            width: 90%;
            max-width: 1200px;
            margin: auto;
            padding: 10px 0;
        }

        section {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e0e0;
        }

        h2 {
            color: var(--primary-color);
            font-weight: 700;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.6rem;
        }

        /* GRID SYSTEM */
        .card-grid { display: grid; gap: 20px; }
        #podio .card-grid { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }

        /* PODIO & HOVER EFFECTS */
        .podium-card {
            position: relative; /* Necesario para el tooltip */
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            background: white;
            cursor: help; /* Indica que hay info extra */
        }
        .podium-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        .podium-card h3 { margin-top: 0; font-size: 1.3em; font-weight: 700; color: var(--primary-color); }

        /* Tooltip Oculto */
        .podium-details {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            width: 200px;
            font-size: 0.9rem;
            margin-bottom: 10px;
            z-index: 10;
            transition: opacity 0.3s, visibility 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        /* Flechita del tooltip */
        .podium-details::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--primary-color) transparent transparent transparent;
        }
        
        .podium-card:hover .podium-details {
            visibility: visible;
            opacity: 1;
        }

        /* Colores del Podio */
        .rank-1 { background: linear-gradient(to bottom, #fff, #fffdf0); border-top: 5px solid #ffd700; }
        .rank-2 { background: linear-gradient(to bottom, #fff, #f7f7f7); border-top: 5px solid #c0c0c0; }
        .rank-3 { background: linear-gradient(to bottom, #fff, #fff5eb); border-top: 5px solid #cd7f32; }

        /* Categor√≠as */
        .cat-u1600 { background-color: #e3f2fd; border-top: 4px solid #2196f3; }
        .cat-u1200 { background-color: #e8f5e9; border-top: 4px solid #4caf50; }
        .cat-u800 { background-color: #fff3e0; border-top: 4px solid #ff9800; }

        /* Estad√≠sticas */
        #statsList { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
        
        .stat-item {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-item strong { display: block; font-size: 1.8em; line-height: 1.2; }
        .stat-item span { font-size: 0.85em; opacity: 0.9; }
        .stat-avg-rating { background-color: #1abc9c; }

        /* Partidas */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .partida-container {
            text-align: center;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .partida-container h3 {
            color: var(--text-dark);
            font-size: 1.1em;
            margin-bottom: 10px;
            height: 2.5em; /* Altura fija para alineaci√≥n */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* --- NUEVO: WRAPPER Y OVERLAY PARA IFRAMES --- */
        .iframe-wrapper {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .iframe-wrapper iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .iframe-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 62, 80, 0.1); /* Fondo muy sutil */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: background 0.3s;
        }
        
        .iframe-overlay:hover {
            background: rgba(44, 62, 80, 0.3);
        }

        .iframe-overlay-btn {
            background: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s;
        }
        
        .iframe-overlay:hover .iframe-overlay-btn {
            transform: scale(1.05);
        }
        /* --------------------------------------------- */
        
        /* Estilos Selectores */
        #selector-area {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            display: inline-block;
        }
        select {
            padding: 10px;
            font-size: 1rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            min-width: 250px;
            cursor: pointer;
        }
        label { font-weight: bold; margin-bottom: 5px; display: block; font-size: 0.9em; }
        
        .player-select-container {
            text-align: center;
            margin-bottom: 20px;
            background: #f0f4c3; /* Un tono suave diferente */
            padding: 20px;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            header h1 { font-size: 1.5em; }
            main { width: 95%; padding: 10px; }
            #statsList { grid-template-columns: repeat(2, 1fr); }
            .games-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <h1 id="torneoNombre">Cargando Informe...</h1>
        <p>Fuente Oficial: <a id="torneoLink" href="#" target="_blank">Ver en Lichess</a></p>

        <!-- SELECTOR DE TORNEO (Desde CSV) -->
        <div id="selector-area">
            <label for="csv-selector">Seleccionar Evento:</label>
            <select id="csv-selector">
                <option value="">Cargando lista de eventos...</option>
            </select>
        </div>
    </header>

    <main id="content-area" style="opacity: 0.5; pointer-events: none;"> <!-- Deshabilitado hasta cargar -->
        
        <!-- SECCI√ìN 1: Cuadro de Honor (Podio) -->
        <section id="podio">
            <h2>ü•á Cuadro de Honor ü•á</h2>
            <p style="text-align: center; color: #666; font-size: 0.9em; margin-bottom: 20px;">
                (Coloca el cursor sobre la tarjeta para ver detalles de rendimiento)
            </p>
            <div class="card-grid">
                <!-- 1er Lugar -->
                <div id="card-1" class="podium-card rank-1">
                    <div class="podium-details" id="tooltip-1">Cargando datos...</div>
                    <h3>Campe√≥n del Torneo</h3>
                    <p id="winner-1">-</p>
                </div>
                <!-- 2do Lugar -->
                <div id="card-2" class="podium-card rank-2">
                    <div class="podium-details" id="tooltip-2">Cargando datos...</div>
                    <h3>Subcampe√≥n</h3>
                    <p id="winner-2">-</p>
                </div>
                <!-- 3er Lugar -->
                <div id="card-3" class="podium-card rank-3">
                    <div class="podium-details" id="tooltip-3">Cargando datos...</div>
                    <h3>Tercer Lugar</h3>
                    <p id="winner-3">-</p>
                </div>
            </div>
        </section>
        
        <!-- SECCI√ìN 1.5: Reconocimientos por Categor√≠a -->
        <section id="premios-categoria">
            <h2>üåü Destacados por Categor√≠a üåü</h2>
            <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="podium-card cat-u1600"><h3>Mejor Sub-1600</h3><p id="best-u1600">-</p></div>
                <div class="podium-card cat-u1200"><h3>Mejor Sub-1200</h3><p id="best-u1200">-</p></div>
                <div class="podium-card cat-u800"><h3>Mejor Sub-800</h3><p id="best-u800">-</p></div>
            </div>
        </section>

        <!-- SECCI√ìN 2: Estad√≠sticas Generales -->
        <section id="resultados-completos">
            <h2>üìä Estad√≠sticas Generales del Evento</h2>
            <div id="stats" class="card-grid">
                 <ul id="statsList" class="card-grid">
                    <li class="stat-item stat-avg-rating"><strong id="stat-avg-rating">-</strong> <span>Rating Promedio</span></li>
                    <li class="stat-item"><strong id="stat-players">0</strong> <span>Participantes</span></li>
                    <li class="stat-item"><strong id="stat-games">0</strong> <span>Partidas Jugadas</span></li>
                    <li class="stat-item"><strong id="stat-moves">0</strong> <span>Movimientos Totales</span></li>
                    <li class="stat-item" style="background-color: #6699ff;"><strong id="stat-white">0%</strong> <span>Victorias Blancas</span></li>
                    <li class="stat-item" style="background-color: #333333;"><strong id="stat-black">0%</strong> <span>Victorias Negras</span></li>
                    <li class="stat-item" style="background-color: #999999;"><strong id="stat-draw">0%</strong> <span>Porcentaje de Tablas</span></li>
                    <li class="stat-item" style="background-color: #ff6666;"><strong id="stat-berserk">0%</strong> <span>Tasa de Berserk</span></li>
                 </ul>
            </div>
        </section>
        
        <!-- SECCI√ìN 3: Partidas Representativas -->
        <section id="partidas-destacadas">
            <h2>‚ôüÔ∏è Partidas Representativas ‚ôüÔ∏è</h2>
            <p>Selecci√≥n autom√°tica de encuentros destacados por sus caracter√≠sticas t√©cnicas.</p>
            
            <div class="games-grid">
                <!-- Partida Larga -->
                <div class="partida-container">
                    <h3 id="title-game-1">Partida de Mayor Duraci√≥n</h3>
                    <iframe id="game-iframe-1" src="" allowtransparency="true"></iframe>
                    <p id="game-1-info" style="font-size: 0.85em; color: #666; margin-top:5px;"></p>
                </div>
                
                <!-- Partida Mejor Nivel -->
                <div class="partida-container">
                    <h3 id="title-game-2">Encuentro de Mayor Nivel T√©cnico</h3>
                    <iframe id="game-iframe-2" src="" allowtransparency="true"></iframe>
                    <p id="game-2-info" style="font-size: 0.85em; color: #666; margin-top:5px;"></p>
                </div>

                <!-- Partida Miniatura (Mate R√°pido) -->
                <div class="partida-container">
                    <h3 id="title-game-global-mate">Miniatura: Mate m√°s R√°pido</h3>
                    <iframe id="game-iframe-global-mate" src="" allowtransparency="true"></iframe>
                    <p id="game-global-mate-info" style="font-size: 0.85em; color: #666; margin-top:5px;"></p>
                </div>
            </div>
        </section>

        <!-- SECCI√ìN 4: An√°lisis Individual -->
        <section id="partidas-jugador">
            <h2>üîç An√°lisis Individual de Estudiantes üîç</h2>
            <div class="player-select-container">
                <label for="player-selector">Seleccione un estudiante para ver su desempe√±o:</label>
                <select id="player-selector"><option value="">Cargando listado...</option></select>
            </div>
            
            <div id="player-games-area" style="display:none;">
                <div class="games-grid">
                    <div class="partida-container">
                        <h3>Prueba de Resistencia (M√°s Larga)</h3>
                        <iframe id="game-iframe-3" src="" allowtransparency="true"></iframe>
                        <p id="game-3-info" style="font-size: 0.85em; color: #666;"></p>
                    </div>
                    <div class="partida-container">
                        <h3>Encuentro de Mayor Exigencia</h3>
                        <iframe id="game-iframe-4" src="" allowtransparency="true"></iframe>
                        <p id="game-4-info" style="font-size: 0.85em; color: #666;"></p>
                    </div>
                    <div class="partida-container">
                        <h3>Definici√≥n T√°ctica (Mate R√°pido)</h3>
                        <iframe id="game-iframe-5" src="" allowtransparency="true"></iframe>
                        <p id="game-5-info" style="font-size: 0.85em; color: #666;"></p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
        // --- CONFIGURACI√ìN ---
        const formatNumber = (num) => (num || 0).toLocaleString('es-ES');
        let tournamentGames = []; // Variable global para guardar partidas

        // 1. CARGAR LISTA DE TORNEOS DESDE CSV
        async function loadTournamentList() {
            try {
                const response = await fetch('torneos.csv');
                if (!response.ok) throw new Error("No se encontr√≥ el archivo torneos.csv");
                
                const text = await response.text();
                const lines = text.trim().split('\n');
                const select = document.getElementById('csv-selector');
                select.innerHTML = ''; 

                let firstId = null;

                lines.forEach(line => {
                    // Soporte b√°sico para CSV (ID,NOMBRE)
                    const parts = line.split(',');
                    if (parts.length >= 2) {
                        const id = parts[0].trim();
                        const name = parts.slice(1).join(',').trim(); // Unir el resto por si el nombre tiene comas
                        
                        if (id && id.length > 4) {
                            const option = document.createElement('option');
                            option.value = id;
                            option.textContent = name;
                            select.appendChild(option);
                            if (!firstId) firstId = id;
                        }
                    }
                });

                select.addEventListener('change', (e) => {
                    if(e.target.value) loadTournamentData(e.target.value);
                });

                if (firstId) {
                    loadTournamentData(firstId);
                } else {
                    document.getElementById('torneoNombre').textContent = "El archivo de torneos est√° vac√≠o.";
                }

            } catch (error) {
                console.error(error);
                document.getElementById('torneoNombre').textContent = "Error de lectura: Verifique 'torneos.csv'";
                const select = document.getElementById('csv-selector');
                select.innerHTML = '<option>Error al cargar lista</option>';
            }
        }

        // 2. FUNCI√ìN PRINCIPAL: CARGAR DATOS
        async function loadTournamentData(id) {
            // UI Feedback
            document.getElementById('content-area').style.opacity = "0.5";
            document.getElementById('torneoNombre').textContent = "Procesando resultados...";
            
            const detailsUrl = `https://lichess.org/api/tournament/${id}`;
            const resultsUrl = `https://lichess.org/api/tournament/${id}/results`;
            const gamesUrl = `https://lichess.org/api/tournament/${id}/games`; 
            
            document.getElementById('torneoLink').href = `https://lichess.org/tournament/${id}`;

            try {
                // A) DETALLES GENERALES
                const detailsRes = await fetch(detailsUrl);
                if(!detailsRes.ok) throw new Error("Torneo no encontrado");
                const details = await detailsRes.json();

                document.getElementById('torneoNombre').textContent = `üèÜ ${details.fullName} üèÜ`;
                
                const stats = details.stats || {};
                const totalGames = stats.games || 0;
                const calcPct = (val) => totalGames > 0 ? Math.round((val || 0) / totalGames * 100) + '%' : '0%';
                
                document.getElementById('stat-players').textContent = formatNumber(details.nbPlayers);
                document.getElementById('stat-games').textContent = formatNumber(stats.games);
                document.getElementById('stat-moves').textContent = formatNumber(stats.moves);
                document.getElementById('stat-white').textContent = calcPct(stats.whiteWins);
                document.getElementById('stat-black').textContent = calcPct(stats.blackWins);
                document.getElementById('stat-draw').textContent = calcPct(stats.draws);
                document.getElementById('stat-berserk').textContent = totalGames > 0 ? Math.round((stats.berserks || 0) / (totalGames * 2) * 100) + '%' : '0%';

                // B) JUGADORES (PODIO, CATEGOR√çAS Y TOOLTIPS)
                const resultsRes = await fetch(resultsUrl);
                const resultsText = await resultsRes.text();
                const players = resultsText.trim().split('\n')
                    .map(line => { try { return JSON.parse(line); } catch(e){return null} })
                    .filter(o => o && (o.username || o.name) && o.rank)
                    .sort((a, b) => a.rank - b.rank);

                // Funci√≥n para llenar el podio y el tooltip
                const setWinner = (idx, elId, tooltipId) => {
                    const p = players[idx];
                    const el = document.getElementById(elId);
                    const tip = document.getElementById(tooltipId);
                    
                    if(p) {
                        const name = p.username || p.name;
                        const title = p.title ? `[${p.title}] ` : '';
                        el.innerHTML = `<strong>${title}${name}</strong><br>${p.score} pts`;
                        
                        // L√≥gica del Tooltip (Hover)
                        const performance = p.performance ? `Performance: ${p.performance}` : 'Performance: N/A';
                        tip.innerHTML = `<strong>${name}</strong><br>${performance}<br>Ranking: #${p.rank}`;
                    } else {
                        el.textContent = "-";
                        tip.textContent = "Sin datos";
                    }
                };
                
                setWinner(0, 'winner-1', 'tooltip-1');
                setWinner(1, 'winner-2', 'tooltip-2');
                setWinner(2, 'winner-3', 'tooltip-3');

                // Categor√≠as
                const setCat = (limit, elId) => {
                    const p = players.find(x => x.rating < limit && x.rating > 0);
                    const el = document.getElementById(elId);
                    if(p) el.innerHTML = `<strong>#${p.rank} ${p.username || p.name}</strong><br>${p.rating} ELO`;
                    else el.textContent = "Desierto";
                };
                setCat(1600, 'best-u1600');
                setCat(1200, 'best-u1200');
                setCat(800, 'best-u800');

                // Rating Promedio
                const ratedPlayers = players.filter(p => p.rating > 0);
                const avgElo = ratedPlayers.length ? Math.round(ratedPlayers.reduce((a,b)=>a+b.rating,0)/ratedPlayers.length) : "N/A";
                document.getElementById('stat-avg-rating').textContent = avgElo;

                setupPlayerSelector(players);
                
                // C) PARTIDAS (Globales)
                loadFeaturedGames(gamesUrl);

                // Habilitar UI
                document.getElementById('content-area').style.opacity = "1";
                document.getElementById('content-area').style.pointerEvents = "auto";

            } catch (err) {
                console.error(err);
                document.getElementById('torneoNombre').textContent = "‚ùå Error al procesar informaci√≥n.";
            }
        }

        // 3. CARGAR PARTIDAS (L√≥gica Autom√°tica)
        async function loadFeaturedGames(gamesUrl) {
            try {
                const res = await fetch(`${gamesUrl}?max=100&clocks=false&evals=false&opening=true`, {
                    headers: { 'Accept': 'application/x-ndjson' }
                });
                const text = await res.text();
                tournamentGames = text.trim().split('\n')
                    .map(line => { try { return JSON.parse(line); } catch(e){return null} })
                    .filter(g => g);

                if (tournamentGames.length === 0) return;

                // 3.1 Mayor Duraci√≥n
                let longest = tournamentGames[0];
                let maxMoves = 0;
                tournamentGames.forEach(g => {
                    const m = g.moves ? g.moves.split(' ').length : 0;
                    if(m > maxMoves) { maxMoves = m; longest = g; }
                });
                setIframe('game-iframe-1', longest.id);
                setInfo('game-1-info', longest, `Total: ${Math.floor(maxMoves/2)} jugadas`);

                // 3.2 Mayor Nivel T√©cnico (Promedio ELO)
                let best = tournamentGames[0];
                let maxAvg = 0;
                tournamentGames.forEach(g => {
                    const avg = (getRating(g, 'white') + getRating(g, 'black')) / 2;
                    if(avg > maxAvg && (tournamentGames.length === 1 || g.id !== longest.id)) {
                        maxAvg = avg; best = g;
                    }
                });
                setIframe('game-iframe-2', best.id);
                setInfo('game-2-info', best, `ELO Promedio: ${Math.round(maxAvg)}`);

                // 3.3 Miniatura (Mate R√°pido Global)
                const mateGames = tournamentGames.filter(g => g.status === 'mate');
                let quickestMate = null;
                let minMoves = 9999;

                if (mateGames.length > 0) {
                    mateGames.forEach(g => {
                        const m = g.moves ? g.moves.split(' ').length : 9999;
                        const isDuplicate = (g.id === longest.id || g.id === best.id);
                        
                        if (m < minMoves && (!isDuplicate || mateGames.length < 3)) {
                            minMoves = m;
                            quickestMate = g;
                        }
                    });
                }

                if (quickestMate) {
                    setIframe('game-iframe-global-mate', quickestMate.id);
                    setInfo('game-global-mate-info', quickestMate, `Mate en ${Math.ceil(minMoves/2)} jugadas`);
                } else {
                    document.getElementById('game-iframe-global-mate').src = "https://placehold.co/600x400/eee/333?text=No+hubo+Jaque+Mates";
                    document.getElementById('game-global-mate-info').textContent = "Ninguna partida finaliz√≥ en mate.";
                }


            } catch (e) { console.error("Error partidas", e); }
        }

        // Helpers para UI
        // --- FUNCI√ìN setIframe MODIFICADA CON PROTECCI√ìN DE CLICK ---
        function setIframe(id, gameId) {
            const iframe = document.getElementById(id);
            if (!iframe) return;

            // Establecer la fuente
            const src = `https://lichess.org/embed/${gameId}?theme=blue&bg=light`;
            iframe.src = src;

            // 1. Comprobar si ya est√° envuelto en el wrapper de seguridad
            let wrapper = iframe.closest('.iframe-wrapper');
            
            if (!wrapper) {
                // 2. Crear Wrapper
                wrapper = document.createElement('div');
                wrapper.className = 'iframe-wrapper';
                
                // Insertar antes y mover el iframe dentro
                iframe.parentNode.insertBefore(wrapper, iframe);
                wrapper.appendChild(iframe);
                
                // 3. Crear Overlay
                const overlay = document.createElement('div');
                overlay.className = 'iframe-overlay';
                
                // Bot√≥n visual
                const btn = document.createElement('div');
                btn.className = 'iframe-overlay-btn';
                btn.innerHTML = '<span>üëÜ Activar Tablero</span>';
                overlay.appendChild(btn);
                
                // 4. Evento de Click para ocultar
                overlay.onclick = function() {
                    this.style.display = 'none';
                };
                
                wrapper.appendChild(overlay);
            } else {
                // Si ya existe el wrapper (al cambiar de torneo/jugador),
                // aseguramos que el overlay vuelva a aparecer para la nueva partida.
                const overlay = wrapper.querySelector('.iframe-overlay');
                if(overlay) overlay.style.display = 'flex';
            }
        }
        // -----------------------------------------------------------

        function getRating(g, color) { return g.players[color].rating || 0; }
        function getName(g, color) { return g.players[color].user ? g.players[color].user.name : "An√≥nimo"; }
        
        function setInfo(elId, g, extra) {
            const w = `${getName(g,'white')} (${getRating(g,'white')})`;
            const b = `${getName(g,'black')} (${getRating(g,'black')})`;
            document.getElementById(elId).textContent = `${w} vs ${b} | ${extra}`;
        }

        // 4. BUSCADOR DE JUGADOR
        function setupPlayerSelector(players) {
            const select = document.getElementById('player-selector');
            select.innerHTML = '<option value="">-- Seleccionar Estudiante --</option>';
            
            [...players].sort((a,b) => (a.username||"").localeCompare(b.username||""))
                .forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.username || p.name;
                    opt.textContent = p.username || p.name;
                    select.appendChild(opt);
                });
            
            select.onchange = (e) => updatePlayerGames(e.target.value);
        }

        function updatePlayerGames(user) {
            const area = document.getElementById('player-games-area');
            if(!user) { area.style.display = "none"; return; }
            area.style.display = "block";

            const myGames = tournamentGames.filter(g => 
                getName(g,'white') === user || getName(g,'black') === user
            );

            if(myGames.length === 0) return;

            // 4.1 Su m√°s larga
            let longest = myGames[0];
            let maxM = 0;
            myGames.forEach(g => {
                const m = g.moves ? g.moves.split(' ').length : 0;
                if(m > maxM) { maxM = m; longest = g; }
            });
            setIframe('game-iframe-3', longest.id);
            setInfo('game-3-info', longest, `${Math.floor(maxM/2)} jugadas`);

            // 4.2 Su rival m√°s duro
            let hardest = myGames[0];
            let maxR = 0;
            myGames.forEach(g => {
                const avg = (getRating(g,'white') + getRating(g,'black'))/2;
                if(avg > maxR && (myGames.length===1 || g.id !== longest.id)) {
                    maxR = avg; hardest = g;
                }
            });
            setIframe('game-iframe-4', hardest.id);
            setInfo('game-4-info', hardest, `Nivel Promedio: ${Math.round(maxR)}`);

            // 4.3 Su Mate m√°s r√°pido
            let bestMate = null;
            let minMateMoves = 9999;
            const myMateGames = myGames.filter(g => g.status === 'mate');
            
            let wonMates = myMateGames.filter(g => {
                const userColor = getName(g, 'white') === user ? 'white' : 'black';
                return g.winner === userColor;
            });

            const candidateMates = wonMates.length > 0 ? wonMates : myMateGames;

            if (candidateMates.length > 0) {
                candidateMates.forEach(g => {
                    const m = g.moves ? g.moves.split(' ').length : 9999;
                    const isDup = (g.id === longest.id || g.id === hardest.id);
                    if (m < minMateMoves && (!isDup || candidateMates.length < 3)) {
                        minMateMoves = m;
                        bestMate = g;
                    }
                });
            }

            if (bestMate) {
                setIframe('game-iframe-5', bestMate.id);
                const userColor = getName(bestMate, 'white') === user ? 'white' : 'black';
                const resultText = bestMate.winner === userColor ? "Victoria por Mate" : "Finaliz√≥ en Mate";
                setInfo('game-5-info', bestMate, `${resultText} en ${Math.ceil(minMateMoves/2)} jugadas`);
            } else {
                document.getElementById('game-iframe-5').src = "https://placehold.co/600x400/eee/333?text=Sin+Mates+Registrados";
                document.getElementById('game-5-info').textContent = "Este estudiante no defini√≥ partidas por jaque mate.";
            }
        }

        // INICIAR
        loadTournamentList();

    </script>
</body>
</html>
