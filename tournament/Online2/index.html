<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados del Torneo Escolar</title>
    
    <!-- Fuentes Divertidas de Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&display=swap');

        :root {
            /* Paleta "Kids" */
            --primary: #6c5ce7;    /* Morado divertido */
            --secondary: #fdcb6e;  /* Amarillo mostaza */
            --accent: #00b894;     /* Verde menta */
            --danger: #ff7675;     /* Rojo suave */
            --bg-body: #dfe6e9;    /* Gris azulado muy claro */
            --card-bg: #ffffff;
            --text-main: #2d3436;
        }

        body {
            font-family: 'Nunito', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            background-image: radial-gradient(#b2bec3 1px, transparent 1px);
            background-size: 20px 20px; /* Patr√≥n de puntos escolar */
        }

        header {
            background: var(--primary);
            color: #fff;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 8px 0 rgba(0,0,0,0.1); /* Sombra dura estilo cartoon */
            margin-bottom: 40px;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
        }

        h1 {
            font-family: 'Fredoka', sans-serif;
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 2px 2px 0 var(--text-main);
        }

        header a {
            color: var(--secondary);
            text-decoration: none;
            font-weight: 800;
            border-bottom: 2px dashed var(--secondary);
        }
        header a:hover { color: #fff; border-bottom-style: solid; }

        main {
            width: 95%;
            max-width: 1100px;
            margin: auto;
            padding-bottom: 60px;
        }

        section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            border: 3px solid #fff;
        }

        h2 {
            font-family: 'Fredoka', sans-serif;
            color: var(--primary);
            margin-top: 0;
            font-size: 1.8rem;
            border-bottom: 4px dotted var(--secondary);
            display: inline-block;
            padding-bottom: 5px;
        }

        /* --- TARJETAS Y GRID --- */
        .card-grid {
            display: grid;
            gap: 25px;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        }

        .podium-card {
            position: relative;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            background: #fff;
            transition: transform 0.3s;
            border: 2px solid transparent;
            cursor: help;
        }
        .podium-card:hover {
            transform: scale(1.03) rotate(1deg);
            border-color: var(--accent);
            z-index: 10;
        }
        .podium-card h3 { 
            font-family: 'Fredoka', sans-serif; 
            margin: 10px 0; 
            color: var(--text-main);
        }
        .podium-card p { font-size: 1.2rem; font-weight: bold; }

        /* Estilos espec√≠ficos del podio */
        .rank-1 { background-color: #fff9c4; border-bottom: 8px solid #f1c40f; } /* Oro pastel */
        .rank-2 { background-color: #f5f6fa; border-bottom: 8px solid #b2bec3; } /* Plata */
        .rank-3 { background-color: #ffccbc; border-bottom: 8px solid #e17055; } /* Bronce */

        /* Tooltip Estilo Comic */
        .podium-details {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-main);
            color: #fff;
            padding: 12px;
            border-radius: 10px;
            width: 180px;
            font-size: 0.9rem;
            z-index: 20;
            transition: all 0.2s;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.2);
        }
        .podium-details::after {
            content: "";
            position: absolute;
            top: 100%; left: 50%; margin-left: -8px;
            border-width: 8px; border-style: solid;
            border-color: var(--text-main) transparent transparent transparent;
        }
        .podium-card:hover .podium-details { visibility: visible; opacity: 1; bottom: 100%; }

        /* --- ESTAD√çSTICAS --- */
        #statsList {
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        }
        .stat-item {
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .stat-item strong { font-family: 'Fredoka', sans-serif; font-size: 1.8rem; display: block; }
        .stat-item span { font-size: 0.85rem; font-weight: 700; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        
        /* --- IFRAMES SEGUROS (SOLUCI√ìN AL SCROLL) --- */
        .games-grid {
            display: grid;
            gap: 30px;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
        .partida-container {
            background: #fff;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #eee;
        }
        .partida-container h3 {
            font-family: 'Fredoka', sans-serif;
            color: var(--primary);
            text-align: center;
        }

        /* El contenedor m√°gico */
        .iframe-wrapper {
            position: relative;
            width: 100%;
            height: 420px;
            border-radius: 10px;
            overflow: hidden;
            background: #eee; /* Placeholder bg */
        }
        
        .iframe-wrapper iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* La capa de bloqueo */
        .iframe-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(45, 52, 54, 0.1); /* Oscuro sutil */
            backdrop-filter: blur(2px); /* Efecto borroso */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s;
        }
        
        /* Bot√≥n grande y divertido */
        .btn-activate {
            background: var(--accent);
            color: white;
            border: none;
            padding: 15px 25px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #008f72; /* Efecto 3D */
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-activate:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #008f72;
        }
        .btn-activate:hover {
            background: #00d1a7;
        }

        /* Bot√≥n de Cerrar (Aparece SOLO cuando est√° activo) */
        .btn-close-board {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 20;
            display: none; /* Oculto por defecto */
            box-shadow: 0 4px 0 #d63031;
            font-family: 'Fredoka', sans-serif;
        }
        .btn-close-board:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #d63031;
        }

        /* Estados del Wrapper */
        .iframe-wrapper.active .iframe-overlay {
            opacity: 0;
            pointer-events: none; /* Deja pasar los clicks al iframe */
        }
        .iframe-wrapper.active .btn-close-board {
            display: block; /* Muestra el bot√≥n de cerrar */
            pointer-events: auto; /* Asegura que el bot√≥n sea clickeable */
        }

        /* --- SELECTORES --- */
        #selector-area {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 15px;
            margin-top: 20px;
            display: inline-block;
            border: 2px dashed rgba(255,255,255,0.5);
        }
        select {
            padding: 12px;
            font-family: 'Nunito', sans-serif;
            font-weight: bold;
            border-radius: 10px;
            border: 2px solid var(--secondary);
            outline: none;
            cursor: pointer;
        }
        
        .player-select-container {
            background: #fff9c4; /* Amarillo muy claro */
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px dashed var(--secondary);
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .games-grid { grid-template-columns: 1fr; }
            #statsList { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <h1 id="torneoNombre">üöÄ Cargando Torneo...</h1>
        <p>üè´ Resultados Oficiales | <a id="torneoLink" href="#" target="_blank">Ver en Lichess</a></p>

        <div id="selector-area">
            <label for="csv-selector" style="display:block; margin-bottom:5px; font-weight:bold;">üìÖ Seleccionar Evento:</label>
            <select id="csv-selector">
                <option value="">Cargando lista...</option>
            </select>
        </div>
    </header>

    <main id="content-area" style="opacity: 0.5; pointer-events: none;"> 
        
        <!-- PODIO -->
        <section id="podio">
            <h2>üèÜ Galer√≠a de Campeones</h2>
            <p style="text-align: center; margin-bottom: 20px;">‚ú® Pasa el rat√≥n sobre las tarjetas para ver detalles ‚ú®</p>
            <div class="card-grid">
                <div id="card-1" class="podium-card rank-1">
                    <div class="podium-details" id="tooltip-1">...</div>
                    <h3>ü•á Gran Campe√≥n</h3>
                    <p id="winner-1">-</p>
                </div>
                <div id="card-2" class="podium-card rank-2">
                    <div class="podium-details" id="tooltip-2">...</div>
                    <h3>ü•à Subcampe√≥n</h3>
                    <p id="winner-2">-</p>
                </div>
                <div id="card-3" class="podium-card rank-3">
                    <div class="podium-details" id="tooltip-3">...</div>
                    <h3>ü•â Tercer Lugar</h3>
                    <p id="winner-3">-</p>
                </div>
            </div>
        </section>
        
        <!-- CATEGOR√çAS -->
        <section id="premios-categoria">
            <h2>üéñÔ∏è Menciones Honor√≠ficas</h2>
            <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="podium-card cat-u1600" style="background:#e3f2fd; border-bottom: 5px solid #64b5f6;">
                    <h3>üöÄ Mejor Sub-1600</h3><p id="best-u1600">-</p>
                </div>
                <div class="podium-card cat-u1200" style="background:#e8f5e9; border-bottom: 5px solid #81c784;">
                    <h3>üå± Mejor Sub-1200</h3><p id="best-u1200">-</p>
                </div>
                <div class="podium-card cat-u800" style="background:#fff3e0; border-bottom: 5px solid #ffb74d;">
                    <h3>üê£ Mejor Sub-800</h3><p id="best-u800">-</p>
                </div>
            </div>
        </section>

        <!-- ESTAD√çSTICAS -->
        <section>
            <h2>üìä Datos Curiosos del Torneo</h2>
            <div id="stats" class="card-grid">
                 <ul id="statsList" class="card-grid">
                    <li class="stat-item" style="background:var(--accent);"><strong id="stat-avg-rating">-</strong> <span>Nivel Promedio</span></li>
                    <li class="stat-item"><strong id="stat-players">0</strong> <span>Jugadores</span></li>
                    <li class="stat-item"><strong id="stat-games">0</strong> <span>Partidas</span></li>
                    <li class="stat-item"><strong id="stat-moves">0</strong> <span>Movimientos</span></li>
                    <li class="stat-item" style="background:#ff7675;"><strong id="stat-berserk">0%</strong> <span>Modo Berserk</span></li>
                    <li class="stat-item" style="background:#74b9ff;"><strong id="stat-white">0%</strong> <span>Ganan Blancas</span></li>
                    <li class="stat-item" style="background:#2d3436;"><strong id="stat-black">0%</strong> <span>Ganan Negras</span></li>
                    <li class="stat-item" style="background:#b2bec3;"><strong id="stat-draw">0%</strong> <span>Tablas</span></li>
                 </ul>
            </div>
        </section>
        
        <!-- PARTIDAS DESTACADAS -->
        <section>
            <h2>‚ôüÔ∏è Sal√≥n de la Fama (Partidas)</h2>
            <p>¬°Revive los momentos m√°s emocionantes!</p>
            
            <div class="games-grid">
                <!-- 1. Larga -->
                <div class="partida-container">
                    <h3>‚è≥ La Partida Marat√≥n</h3>
                    <!-- Contenedor Iframe Seguro -->
                    <div class="iframe-wrapper" id="wrapper-1">
                        <button class="btn-close-board" onclick="deactivateBoard('wrapper-1')">‚ùå Cerrar Tablero</button>
                        <div class="iframe-overlay">
                            <button class="btn-activate" onclick="activateBoard('wrapper-1')">üëÜ Toca para Jugar</button>
                        </div>
                        <iframe id="game-iframe-1" src="" allowtransparency="true"></iframe>
                    </div>
                    <p id="game-1-info" style="font-weight:bold; color: var(--primary); margin-top:10px;"></p>
                </div>
                
                <!-- 2. Mejor Nivel -->
                <div class="partida-container">
                    <h3>üß† Duelo de Titanes (Nivel Alto)</h3>
                    <div class="iframe-wrapper" id="wrapper-2">
                        <button class="btn-close-board" onclick="deactivateBoard('wrapper-2')">‚ùå Cerrar Tablero</button>
                        <div class="iframe-overlay">
                            <button class="btn-activate" onclick="activateBoard('wrapper-2')">üëÜ Toca para Jugar</button>
                        </div>
                        <iframe id="game-iframe-2" src="" allowtransparency="true"></iframe>
                    </div>
                    <p id="game-2-info" style="font-weight:bold; color: var(--primary); margin-top:10px;"></p>
                </div>

                <!-- 3. Miniatura -->
                <div class="partida-container">
                    <h3>‚ö° El Rayo (Jaque Mate R√°pido)</h3>
                    <div class="iframe-wrapper" id="wrapper-mate">
                        <button class="btn-close-board" onclick="deactivateBoard('wrapper-mate')">‚ùå Cerrar Tablero</button>
                        <div class="iframe-overlay">
                            <button class="btn-activate" onclick="activateBoard('wrapper-mate')">üëÜ Toca para Jugar</button>
                        </div>
                        <iframe id="game-iframe-global-mate" src="" allowtransparency="true"></iframe>
                    </div>
                    <p id="game-global-mate-info" style="font-weight:bold; color: var(--primary); margin-top:10px;"></p>
                </div>
            </div>
        </section>

        <!-- AN√ÅLISIS JUGADOR -->
        <section>
            <h2>üîé Detective de Jugadores</h2>
            <div class="player-select-container">
                <label for="player-selector">Elige un nombre para ver sus mejores jugadas:</label>
                <select id="player-selector"><option value="">Cargando...</option></select>
            </div>
            
            <div id="player-games-area" style="display:none;">
                <div class="games-grid">
                    <!-- P3 -->
                    <div class="partida-container">
                        <h3>Su Partida M√°s Larga</h3>
                        <div class="iframe-wrapper" id="wrapper-3">
                            <button class="btn-close-board" onclick="deactivateBoard('wrapper-3')">‚ùå Cerrar</button>
                            <div class="iframe-overlay">
                                <button class="btn-activate" onclick="activateBoard('wrapper-3')">üëÜ Ver</button>
                            </div>
                            <iframe id="game-iframe-3" src="" allowtransparency="true"></iframe>
                        </div>
                        <p id="game-3-info" style="margin-top:10px; font-weight:bold; color:var(--primary)"></p>
                    </div>
                    <!-- P4 -->
                    <div class="partida-container">
                        <h3>Su Rival M√°s Fuerte</h3>
                        <div class="iframe-wrapper" id="wrapper-4">
                            <button class="btn-close-board" onclick="deactivateBoard('wrapper-4')">‚ùå Cerrar</button>
                            <div class="iframe-overlay">
                                <button class="btn-activate" onclick="activateBoard('wrapper-4')">üëÜ Ver</button>
                            </div>
                            <iframe id="game-iframe-4" src="" allowtransparency="true"></iframe>
                        </div>
                        <p id="game-4-info" style="margin-top:10px; font-weight:bold; color:var(--primary)"></p>
                    </div>
                    <!-- P5 -->
                    <div class="partida-container">
                        <h3>Su Mejor Jaque Mate</h3>
                        <div class="iframe-wrapper" id="wrapper-5">
                            <button class="btn-close-board" onclick="deactivateBoard('wrapper-5')">‚ùå Cerrar</button>
                            <div class="iframe-overlay">
                                <button class="btn-activate" onclick="activateBoard('wrapper-5')">üëÜ Ver</button>
                            </div>
                            <iframe id="game-iframe-5" src="" allowtransparency="true"></iframe>
                        </div>
                        <p id="game-5-info" style="margin-top:10px; font-weight:bold; color:var(--primary)"></p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
        const formatNumber = (num) => (num || 0).toLocaleString('es-ES');
        let tournamentGames = []; 

        // --- NUEVAS FUNCIONES DE SEGURIDAD PARA EL TABLERO ---
        function activateBoard(wrapperId) {
            document.getElementById(wrapperId).classList.add('active');
        }
        function deactivateBoard(wrapperId) {
            document.getElementById(wrapperId).classList.remove('active');
        }
        // ----------------------------------------------------

        async function loadTournamentList() {
            try {
                const response = await fetch('torneos.csv');
                if (!response.ok) throw new Error("Falta torneos.csv");
                
                const text = await response.text();
                const lines = text.trim().split('\n');
                const select = document.getElementById('csv-selector');
                select.innerHTML = ''; 

                let firstId = null;

                lines.forEach(line => {
                    const parts = line.split(',');
                    if (parts.length >= 2) {
                        const id = parts[0].trim();
                        const name = parts.slice(1).join(',').trim();
                        if (id && id.length > 4) {
                            const option = document.createElement('option');
                            option.value = id;
                            option.textContent = name;
                            select.appendChild(option);
                            if (!firstId) firstId = id;
                        }
                    }
                });

                select.addEventListener('change', (e) => {
                    if(e.target.value) loadTournamentData(e.target.value);
                });

                if (firstId) loadTournamentData(firstId);
                else document.getElementById('torneoNombre').textContent = "Lista vac√≠a.";

            } catch (error) {
                console.error(error);
                document.getElementById('torneoNombre').textContent = "Error: No se pudo leer la lista de torneos.";
            }
        }

        async function loadTournamentData(id) {
            // Reiniciar la UI de los tableros al cambiar de torneo
            document.querySelectorAll('.iframe-wrapper').forEach(w => w.classList.remove('active'));
            
            document.getElementById('content-area').style.opacity = "0.5";
            document.getElementById('torneoNombre').textContent = "üìö Leyendo datos...";
            
            const detailsUrl = `https://lichess.org/api/tournament/${id}`;
            const resultsUrl = `https://lichess.org/api/tournament/${id}/results`;
            const gamesUrl = `https://lichess.org/api/tournament/${id}/games`; 
            
            document.getElementById('torneoLink').href = `https://lichess.org/tournament/${id}`;

            try {
                const detailsRes = await fetch(detailsUrl);
                if(!detailsRes.ok) throw new Error("Error API");
                const details = await detailsRes.json();

                document.getElementById('torneoNombre').textContent = `üèÜ ${details.fullName}`;
                
                const stats = details.stats || {};
                const totalGames = stats.games || 0;
                const calcPct = (val) => totalGames > 0 ? Math.round((val || 0) / totalGames * 100) + '%' : '0%';
                
                document.getElementById('stat-players').textContent = formatNumber(details.nbPlayers);
                document.getElementById('stat-games').textContent = formatNumber(stats.games);
                document.getElementById('stat-moves').textContent = formatNumber(stats.moves);
                document.getElementById('stat-white').textContent = calcPct(stats.whiteWins);
                document.getElementById('stat-black').textContent = calcPct(stats.blackWins);
                document.getElementById('stat-draw').textContent = calcPct(stats.draws);
                document.getElementById('stat-berserk').textContent = totalGames > 0 ? Math.round((stats.berserks || 0) / (totalGames * 2) * 100) + '%' : '0%';

                const resultsRes = await fetch(resultsUrl);
                const resultsText = await resultsRes.text();
                const players = resultsText.trim().split('\n')
                    .map(line => { try { return JSON.parse(line); } catch(e){return null} })
                    .filter(o => o && (o.username || o.name) && o.rank)
                    .sort((a, b) => a.rank - b.rank);

                const setWinner = (idx, elId, tooltipId) => {
                    const p = players[idx];
                    const el = document.getElementById(elId);
                    const tip = document.getElementById(tooltipId);
                    if(p) {
                        const name = p.username || p.name;
                        const title = p.title ? `[${p.title}] ` : '';
                        el.innerHTML = `<strong>${title}${name}</strong><br>${p.score} pts`;
                        const perf = p.performance ? `Performance: ${p.performance}` : 'Sin datos perf.';
                        tip.innerHTML = `<strong>${name}</strong><br>${perf}<br>Ranking: #${p.rank}`;
                    } else {
                        el.textContent = "-";
                        tip.textContent = "Vacante";
                    }
                };
                
                setWinner(0, 'winner-1', 'tooltip-1');
                setWinner(1, 'winner-2', 'tooltip-2');
                setWinner(2, 'winner-3', 'tooltip-3');

                const setCat = (limit, elId) => {
                    const p = players.find(x => x.rating < limit && x.rating > 0);
                    const el = document.getElementById(elId);
                    if(p) el.innerHTML = `<strong>#${p.rank} ${p.username || p.name}</strong><br>${p.rating} ELO`;
                    else el.textContent = "Nadie";
                };
                setCat(1600, 'best-u1600');
                setCat(1200, 'best-u1200');
                setCat(800, 'best-u800');

                const ratedPlayers = players.filter(p => p.rating > 0);
                const avgElo = ratedPlayers.length ? Math.round(ratedPlayers.reduce((a,b)=>a+b.rating,0)/ratedPlayers.length) : "N/A";
                document.getElementById('stat-avg-rating').textContent = avgElo;

                setupPlayerSelector(players);
                loadFeaturedGames(gamesUrl);

                document.getElementById('content-area').style.opacity = "1";
                document.getElementById('content-area').style.pointerEvents = "auto";

            } catch (err) {
                console.error(err);
                document.getElementById('torneoNombre').textContent = "‚ùå Error de carga";
            }
        }

        async function loadFeaturedGames(gamesUrl) {
            try {
                const res = await fetch(`${gamesUrl}?max=100&clocks=false&evals=false&opening=true`, {
                    headers: { 'Accept': 'application/x-ndjson' }
                });
                const text = await res.text();
                tournamentGames = text.trim().split('\n')
                    .map(line => { try { return JSON.parse(line); } catch(e){return null} })
                    .filter(g => g);

                if (tournamentGames.length === 0) return;

                // L√≥gica Global
                let longest = tournamentGames[0];
                let maxMoves = 0;
                tournamentGames.forEach(g => {
                    const m = g.moves ? g.moves.split(' ').length : 0;
                    if(m > maxMoves) { maxMoves = m; longest = g; }
                });
                updateBoardSource('game-iframe-1', longest.id);
                setInfo('game-1-info', longest, `${Math.floor(maxMoves/2)} turnos`);

                let best = tournamentGames[0];
                let maxAvg = 0;
                tournamentGames.forEach(g => {
                    const avg = (getRating(g, 'white') + getRating(g, 'black')) / 2;
                    if(avg > maxAvg && (tournamentGames.length === 1 || g.id !== longest.id)) {
                        maxAvg = avg; best = g;
                    }
                });
                updateBoardSource('game-iframe-2', best.id);
                setInfo('game-2-info', best, `ELO Promedio: ${Math.round(maxAvg)}`);

                const mateGames = tournamentGames.filter(g => g.status === 'mate');
                let quickestMate = null;
                let minMoves = 9999;
                if (mateGames.length > 0) {
                    mateGames.forEach(g => {
                        const m = g.moves ? g.moves.split(' ').length : 9999;
                        const isDuplicate = (g.id === longest.id || g.id === best.id);
                        if (m < minMoves && (!isDuplicate || mateGames.length < 3)) {
                            minMoves = m;
                            quickestMate = g;
                        }
                    });
                }
                if (quickestMate) {
                    updateBoardSource('game-iframe-global-mate', quickestMate.id);
                    setInfo('game-global-mate-info', quickestMate, `Mate en ${Math.ceil(minMoves/2)} jugadas`);
                } else {
                    // Fallback visual
                    document.getElementById('game-iframe-global-mate').src = "https://placehold.co/600x420/e0f7fa/006064?text=Sin+Mates+R√°pidos";
                    document.getElementById('game-global-mate-info').textContent = "¬°Todos resistieron el mate!";
                }

            } catch (e) { console.error("Error partidas", e); }
        }

        // Simplemente actualiza el SRC del iframe, el wrapper y los botones ya existen en el HTML est√°tico
        function updateBoardSource(iframeId, gameId) {
            const iframe = document.getElementById(iframeId);
            if (iframe) {
                iframe.src = `https://lichess.org/embed/${gameId}?theme=blue&bg=light`;
                // Aseguramos que el tablero empiece desactivado al cargar uno nuevo
                const wrapper = iframe.closest('.iframe-wrapper');
                if(wrapper) wrapper.classList.remove('active');
            }
        }

        function getRating(g, color) { return g.players[color].rating || 0; }
        function getName(g, color) { return g.players[color].user ? g.players[color].user.name : "An√≥nimo"; }
        
        function setInfo(elId, g, extra) {
            const w = `${getName(g,'white')} (${getRating(g,'white')})`;
            const b = `${getName(g,'black')} (${getRating(g,'black')})`;
            document.getElementById(elId).textContent = `${w} vs ${b} | ${extra}`;
        }

        function setupPlayerSelector(players) {
            const select = document.getElementById('player-selector');
            select.innerHTML = '<option value="">-- Elige un Estudiante --</option>';
            [...players].sort((a,b) => (a.username||"").localeCompare(b.username||""))
                .forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.username || p.name;
                    opt.textContent = p.username || p.name;
                    select.appendChild(opt);
                });
            select.onchange = (e) => updatePlayerGames(e.target.value);
        }

        function updatePlayerGames(user) {
            const area = document.getElementById('player-games-area');
            if(!user) { area.style.display = "none"; return; }
            area.style.display = "block";

            const myGames = tournamentGames.filter(g => 
                getName(g,'white') === user || getName(g,'black') === user
            );

            if(myGames.length === 0) return;

            let longest = myGames[0];
            let maxM = 0;
            myGames.forEach(g => {
                const m = g.moves ? g.moves.split(' ').length : 0;
                if(m > maxM) { maxM = m; longest = g; }
            });
            updateBoardSource('game-iframe-3', longest.id);
            setInfo('game-3-info', longest, `${Math.floor(maxM/2)} turnos`);

            let hardest = myGames[0];
            let maxR = 0;
            myGames.forEach(g => {
                const avg = (getRating(g,'white') + getRating(g,'black'))/2;
                if(avg > maxR && (myGames.length===1 || g.id !== longest.id)) {
                    maxR = avg; hardest = g;
                }
            });
            updateBoardSource('game-iframe-4', hardest.id);
            setInfo('game-4-info', hardest, `Nivel: ${Math.round(maxR)}`);

            let bestMate = null;
            let minMateMoves = 9999;
            const myMateGames = myGames.filter(g => g.status === 'mate');
            let wonMates = myMateGames.filter(g => {
                const userColor = getName(g, 'white') === user ? 'white' : 'black';
                return g.winner === userColor;
            });
            const candidateMates = wonMates.length > 0 ? wonMates : myMateGames;

            if (candidateMates.length > 0) {
                candidateMates.forEach(g => {
                    const m = g.moves ? g.moves.split(' ').length : 9999;
                    const isDup = (g.id === longest.id || g.id === hardest.id);
                    if (m < minMateMoves && (!isDup || candidateMates.length < 3)) {
                        minMateMoves = m;
                        bestMate = g;
                    }
                });
            }

            if (bestMate) {
                updateBoardSource('game-iframe-5', bestMate.id);
                const userColor = getName(bestMate, 'white') === user ? 'white' : 'black';
                const resultText = bestMate.winner === userColor ? "¬°Victoria!" : "Aprendizaje";
                setInfo('game-5-info', bestMate, `${resultText} en ${Math.ceil(minMateMoves/2)} jugadas`);
            } else {
                document.getElementById('game-iframe-5').src = "https://placehold.co/600x420/e0f7fa/006064?text=Sin+Mates";
                document.getElementById('game-5-info').textContent = "Sin partidas definidas por mate.";
            }
        }

        loadTournamentList();
    </script>
</body>
</html>
