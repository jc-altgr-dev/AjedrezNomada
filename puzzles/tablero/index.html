<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chess Studio - Final Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        :root { --bg: #161512; --panel: #262421; --accent: #4581bf; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #ccc; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .main-layout { display: grid; grid-template-columns: 560px 350px; gap: 20px; max-width: 950px; }
        
        #board-container { background: #1c1a18; padding: 35px; border-radius: 8px; border: 1px solid #3d3d3d; position: relative; }
        #myBoard { width: 500px; }
        
        .side-panel { background: var(--panel); border-radius: 8px; display: flex; flex-direction: column; border: 1px solid #3d3d3d; height: 650px; }
        .header { padding: 15px; background: #1c1a18; font-weight: bold; text-align: center; border-bottom: 1px solid #3d3d3d; color: #ffce73; }
        
        .history-box { flex-grow: 1; padding: 10px; background: #111; overflow-y: auto; font-family: monospace; display: grid; grid-template-columns: 40px 1fr 1fr; gap: 5px; }
        
        .controls { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        input, select { background: #111; border: 1px solid #444; color: white; padding: 10px; border-radius: 4px; font-size: 13px; outline: none; }
        input:focus { border-color: var(--accent); }
        
        button { padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: #444; color: white; transition: 0.2s; }
        button:hover { background: #555; }
        .btn-solve { background: var(--accent); color: white; margin-top: 5px; }
        
        .status-msg { padding: 12px; text-align: center; font-weight: bold; font-size: 0.9em; min-height: 20px; border-bottom: 1px solid #333; }
        .correct { color: #2ecc71; }
        .wrong { color: #e74c3c; }
    </style>
</head>
<body class="theme-blue">

<div class="main-layout">
    <div>
        <div id="board-container">
            <div id="myBoard"></div>
        </div>
        <div class="controls">
            <input type="text" id="lichessLink" placeholder="Enlace Lichess (ej: https://lichess.org/training/61044)">
            <button class="btn-solve" onclick="loadLichessPuzzle()">CARGAR EJERCICIO</button>
        </div>
    </div>

    <div class="side-panel">
        <div class="header">DIAGRAMA Y ANÁLISIS</div>
        <div id="feedback" class="status-msg">Listo</div>
        <div class="history-box" id="history"></div>
        
        <div class="controls">
            <input type="text" id="fenInput" placeholder="Posición FEN...">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <button onclick="loadFen()">Cargar FEN</button>
                <button onclick="board.flip()">Girar</button>
            </div>
            <button onclick="resetGame()">Posición Inicial</button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
    var board = null;
    var game = new Chess();
    var puzzleMoves = [];
    var currentStep = 0;

    // PIEZAS PNG LOCALES
    function pieceTheme(piece) {
        return 'img/' + piece + '.png';
    }

    function onDragStart(source, piece) {
        if (game.game_over()) return false;
        if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
            (game.turn() === 'b' && piece.search(/^w/) !== -1)) return false;
    }

    function onDrop(source, target) {
        var move = game.move({ from: source, to: target, promotion: 'q' });
        
        // Si el movimiento es ilegal según las reglas
        if (move === null) return 'snapback';

        // Si hay un puzzle activo, validar contra la solución
        if (puzzleMoves.length > 0) {
            var moveUCI = source + target;
            // Manejo de promoción en notación UCI (ej: e7e8q)
            if (move.flags.includes('p')) moveUCI += 'q'; 

            if (moveUCI === puzzleMoves[currentStep]) {
                currentStep++;
                $('#feedback').html('¡CORRECTO!').removeClass('wrong').addClass('correct');
                
                // Respuesta de la máquina
                if (currentStep < puzzleMoves.length) {
                    setTimeout(() => {
                        game.move(puzzleMoves[currentStep], {sloppy: true});
                        currentStep++;
                        board.position(game.fen());
                        updateHistory();
                    }, 500);
                } else {
                    $('#feedback').html('¡EJERCICIO COMPLETADO!');
                }
            } else {
                $('#feedback').html('MOVIMIENTO INCORRECTO').addClass('wrong').removeClass('correct');
                game.undo();
                return 'snapback'; // Esto evita el efecto de arrastre doble
            }
        }
        updateHistory();
    }

    function updateHistory() {
        $('#fenInput').val(game.fen());
        const history = game.history();
        $('#history').empty();
        for (let i = 0; i < history.length; i += 2) {
            $('#history').append(`<div style="color:#666">${Math.floor(i/2)+1}.</div><div>${history[i]}</div><div>${history[i+1]||''}</div>`);
        }
        $('#history').scrollTop($('#history')[0].scrollHeight);
    }

    async function loadLichessPuzzle() {
        const url = $('#lichessLink').val().trim();
        const puzzleId = url.split('/').pop();
        if(!puzzleId) return;

        $('#feedback').html('Cargando...');

        try {
            // Usamos el proxy AllOrigins pero con un parámetro para evitar el caché
            const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://lichess.org/api/puzzle/' + puzzleId)}&_=${Date.now()}`);
            const json = await response.json();
            const data = JSON.parse(json.contents);

            // Resetear juego y cargar FEN inicial (antes del puzzle)
            game.load(data.game.fen);
            
            // Lichess requiere ejecutar el movimiento inicial del oponente
            const initialMove = data.puzzle.initialMove;
            game.move(initialMove, {sloppy: true});

            puzzleMoves = data.puzzle.lines;
            currentStep = 0;

            // Orientar y refrescar
            board.orientation(game.turn() === 'w' ? 'white' : 'black');
            board.position(game.fen());
            updateHistory();
            
            $('#feedback').html('TU TURNO (' + (game.turn() === 'w' ? 'Blancas' : 'Negras') + ')').removeClass('correct wrong');
        } catch (e) {
            $('#feedback').html('Error de conexión o ID inválido').addClass('wrong');
            console.error(e);
        }
    }

    function init() {
        board = ChessBoard('myBoard', {
            draggable: true,
            position: 'start',
            showNotation: true,
            onDragStart: onDragStart,
            onDrop: onDrop,
            // Eliminamos onSnapEnd para evitar el refresco redundante que causaba el doble arrastre
            pieceTheme: pieceTheme
        });
        updateHistory();
    }

    function loadFen() {
        if (game.load($('#fenInput').val())) {
            puzzleMoves = [];
            board.position(game.fen());
            updateHistory();
        }
    }

    function resetGame() {
        game.reset();
        puzzleMoves = [];
        board.start();
        board.orientation('white');
        updateHistory();
    }

    init();
</script>
</body>
</html>
