<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chess Training Studio - PNG Local</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        :root { --bg: #161512; --panel: #262421; --accent: #4581bf; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #ccc; display: flex; justify-content: center; padding: 20px; margin: 0; }
        
        .main-layout { display: grid; grid-template-columns: 550px 350px; gap: 20px; max-width: 950px; }
        
        /* Contenedor con padding para ver coordenadas externas */
        #board-container { background: #1c1a18; padding: 30px; border-radius: 8px; border: 1px solid #3d3d3d; position: relative; }
        #myBoard { width: 500px; }
        
        .side-panel { background: var(--panel); border-radius: 8px; display: flex; flex-direction: column; border: 1px solid #3d3d3d; height: 680px; }
        .header { padding: 15px; background: #1c1a18; font-weight: bold; text-align: center; border-bottom: 1px solid #3d3d3d; color: #ffce73; }
        
        .history-box { flex-grow: 1; padding: 10px; background: #111; overflow-y: auto; font-family: monospace; display: grid; grid-template-columns: 40px 1fr 1fr; gap: 5px; border-bottom: 1px solid #333; }
        
        .controls { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        input, select { background: #111; border: 1px solid #444; color: white; padding: 10px; border-radius: 4px; font-size: 13px; }
        
        button { padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: #444; color: white; transition: 0.2s; }
        button:hover { background: #555; }
        .btn-solve { background: var(--accent); color: white; }
        
        .status-msg { padding: 12px; text-align: center; font-weight: bold; font-size: 0.9em; min-height: 20px; }
        .correct { color: #2ecc71; border-bottom: 2px solid #2ecc71; }
        .wrong { color: #e74c3c; border-bottom: 2px solid #e74c3c; }

        .theme-blue .white-1e1d7 { background-color: #dee3e6 !important; }
        .theme-blue .black-3c85d { background-color: #8ca2ad !important; }
        .theme-pink .white-1e1d7 { background-color: #fce4ec !important; }
        .theme-pink .black-3c85d { background-color: #f06292 !important; }
    </style>
</head>
<body class="theme-blue">

<div class="main-layout">
    <div>
        <div id="board-container">
            <div id="myBoard"></div>
        </div>
        <div class="controls">
            <label style="font-size: 0.8em; color: #888;">ENLACE DE PUZZLE LICHESS:</label>
            <input type="text" id="lichessLink" placeholder="https://lichess.org/training/XXXXX">
            <button class="btn-solve" onclick="loadLichessPuzzle()">CARGAR Y JUGAR</button>
        </div>
    </div>

    <div class="side-panel">
        <div class="header">ENTRENAMIENTO PERSONAL</div>
        <div id="feedback" class="status-msg">Esperando ejercicio...</div>
        <div class="history-box" id="history"></div>
        
        <div class="controls">
            <input type="text" id="fenInput" placeholder="Posición FEN...">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <button onclick="loadFen()">Cargar FEN</button>
                <button onclick="board.flip()">Girar</button>
            </div>
            <select id="boardStyle" onchange="document.body.className = this.value">
                <option value="theme-blue">Tema Azul</option>
                <option value="theme-pink">Tema Rosa</option>
            </select>
            <button onclick="resetGame()">Posición Inicial</button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
    var board = null;
    var game = new Chess();
    var solution = [];
    var currentStep = 0;

    // CONFIGURACIÓN DE PIEZAS PNG LOCALES
    function pieceTheme(piece) {
        return 'img/' + piece + '.png';
    }

    function onDragStart (source, piece) {
        if (game.game_over()) return false;
        // Solo mover si es el turno de la pieza
        if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
            (game.turn() === 'b' && piece.search(/^w/) !== -1)) return false;
    }

    function onDrop (source, target) {
        var move = game.move({ from: source, to: target, promotion: 'q' });
        if (move === null) return 'snapback';

        // Si hay un puzzle activo, validar movimiento
        if (solution.length > 0) {
            var moveMade = source + target;
            if (moveMade === solution[currentStep]) {
                currentStep++;
                $('#feedback').html('¡CORRECTO!').removeClass('wrong').addClass('correct');
                
                // Respuesta automática de la máquina si existe
                if (currentStep < solution.length) {
                    setTimeout(() => {
                        game.move(solution[currentStep], {sloppy: true});
                        currentStep++;
                        updateUI();
                    }, 600);
                } else {
                    $('#feedback').html('¡EJERCICIO COMPLETADO!');
                    updateUI();
                }
            } else {
                $('#feedback').html('MOVIMIENTO INCORRECTO').addClass('wrong').removeClass('correct');
                game.undo();
                setTimeout(updateUI, 250);
                return 'snapback';
            }
        } else {
            updateUI();
        }
    }

    function updateUI() {
        board.position(game.fen());
        $('#fenInput').val(game.fen());
        renderHistory();
    }

    function renderHistory() {
        const history = game.history();
        $('#history').empty();
        for (let i = 0; i < history.length; i += 2) {
            $('#history').append(`<div style="color:#666">${Math.floor(i/2)+1}.</div><div>${history[i]}</div><div>${history[i+1]||''}</div>`);
        }
        $('#history').scrollTop($('#history')[0].scrollHeight);
    }

    async function fetchLichess(puzzleId) {
        // Intentar con un proxy diferente si el primero falla
        const proxies = [
            "https://api.allorigins.win/get?url=",
            "https://corsproxy.io/?"
        ];
        
        for (let proxy of proxies) {
            try {
                const target = `https://lichess.org/api/puzzle/${puzzleId}`;
                const response = await fetch(proxy + encodeURIComponent(target));
                if (!response.ok) continue;
                const data = await response.json();
                // AllOrigins envuelve la respuesta en .contents
                return typeof data.contents === 'string' ? JSON.parse(data.contents) : data;
            } catch (e) { console.log("Fallo con proxy:", proxy); }
        }
        throw new Error("No se pudo conectar con Lichess");
    }

    async function loadLichessPuzzle() {
        let url = $('#lichessLink').val().trim();
        if (!url) return;
        
        const puzzleId = url.split('/').pop();
        $('#feedback').html('Conectando con Lichess...').removeClass('correct wrong');

        try {
            const data = await fetchLichess(puzzleId);
            
            // 1. Cargar posición base
            game.load(data.game.fen);
            
            // 2. Realizar jugada inicial del oponente para plantear el problema
            const initialMove = data.puzzle.initialMove;
            game.move(initialMove, {sloppy: true});
            
            solution = data.puzzle.lines; 
            currentStep = 0;
            
            // 3. Orientar tablero según a quién le toca jugar
            board.orientation(game.turn() === 'w' ? 'white' : 'black');
            updateUI();
            $('#feedback').html('TU TURNO - Encuentra la mejor jugada');
            
        } catch (e) {
            $('#feedback').html('Error: No se encontró el puzzle o fallo de red.').addClass('wrong');
        }
    }

    function init() {
        board = ChessBoard('myBoard', {
            draggable: true,
            position: 'start',
            showNotation: true,
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: () => board.position(game.fen()),
            pieceTheme: pieceTheme
        });
        updateUI();
    }

    function loadFen() {
        if (game.load($('#fenInput').val())) {
            solution = [];
            board.position(game.fen());
            updateUI();
        } else alert("FEN inválido");
    }

    function resetGame() {
        game.reset();
        solution = [];
        board.start();
        board.orientation('white');
        updateUI();
    }

    init();
</script>
</body>
</html>
