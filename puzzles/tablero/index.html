<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>üèÜ Mi Desaf√≠o de Ajedrez üèÜ</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        :root { --bg: #1e1e2e; --panel: #2e2e3e; --accent: #ffcc00; --text: #ffffff; }
        body { font-family: 'Comic Sans MS', 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 20px; margin: 0; }
        
        .main-layout { display: grid; grid-template-columns: 580px 380px; gap: 20px; max-width: 1000px; }
        
        /* Tablero y Contenedor */
        #board-container { background: #3e3e4e; padding: 40px; border-radius: 20px; border: 5px solid #5e5e6e; box-shadow: 0 10px 0 #111; }
        #myBoard { width: 500px; }
        
        /* Panel Lateral */
        .side-panel { background: var(--panel); border-radius: 20px; display: flex; flex-direction: column; border: 4px solid var(--accent); height: 700px; overflow: hidden; }
        .header { padding: 15px; background: var(--accent); font-weight: bold; text-align: center; color: #333; font-size: 1.4em; }
        
        .stats-bar { display: flex; justify-content: space-around; padding: 10px; background: rgba(0,0,0,0.2); font-size: 1.1em; border-bottom: 2px solid #444; }
        
        #feedback { padding: 20px; text-align: center; font-weight: bold; font-size: 1.2em; min-height: 40px; transition: 0.3s; }
        .correct { color: #55ff55; transform: scale(1.1); }
        .wrong { color: #ff5555; }

        .history-box { flex-grow: 1; padding: 15px; background: #111; overflow-y: auto; font-family: monospace; line-height: 1.6; }
        .report-link { color: var(--accent); text-decoration: none; display: block; margin: 5px 0; font-size: 0.9em; }

        .controls { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .btn-main { padding: 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1em; transition: 0.2s; background: #444; color: white; }
        .btn-start { background: #27ae60; box-shadow: 0 4px 0 #1e8449; }
        .btn-start:active { transform: translateY(4px); box-shadow: none; }

        /* Colores de las casillas resaltadas */
        .highlight-last-move { box-shadow: inset 0 0 3px 3px yellow; }
    </style>
</head>
<body>

<div class="main-layout">
    <div>
        <div id="board-container">
            <div id="myBoard"></div>
        </div>
        <div class="controls">
            <label style="color: #aaa; font-size: 0.8em;">Selecciona tu archivo de 5 ejercicios:</label>
            <input type="file" id="csvFile" accept=".csv" style="color: white;">
            <button id="startBtn" class="btn-main btn-start" onclick="startTest()">üöÄ ¬°EMPEZAR DESAF√çO!</button>
        </div>
    </div>

    <div class="side-panel">
        <div class="header">üåü MI TEST DE AJEDREZ üåü</div>
        <div class="stats-bar">
            <span>üß© <span id="puzzleCount">0/5</span></span>
            <span>‚è±Ô∏è <span id="timer">00:00</span></span>
        </div>
        <div id="feedback">¬°Hola! Sube tu archivo y pulsa empezar.</div>
        <div class="history-box" id="reportArea">
            <p style="color: #777;">Tus jugadas aparecer√°n aqu√≠...</p>
        </div>
        <div class="controls">
            <button class="btn-main" onclick="board.flip()">üîÑ Girar Tablero</button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
    var board = null;
    var game = new Chess();
    var puzzleList = [];
    var currentIndex = 0;
    var puzzleMoves = [];
    var currentStep = 0;
    var startTime, timerInterval;
    var report = [];

    function pieceTheme(piece) { return 'img/' + piece + '.png'; }

    // --- CARGA DE DATOS ---
    function startTest() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return alert("¬°Primero elige tu archivo CSV!");

        $('#reportArea').empty();
        puzzleList = [];
        currentIndex = 0;

        Papa.parse(file, {
            header: true,
            complete: function(results) {
                // Tomamos solo los primeros 5 ejercicios
                puzzleList = results.data.slice(0, 5);
                if (puzzleList.length === 0) return alert("El archivo est√° vac√≠o");
                
                startTimer();
                loadNextPuzzle();
            }
        });
    }

    function loadNextPuzzle() {
        if (currentIndex >= puzzleList.length) {
            finishTest();
            return;
        }

        const data = puzzleList[currentIndex];
        game.load(data.FEN);
        puzzleMoves = data.Moves.split(' ');
        
        // 1. Mostrar la √∫ltima jugada (la jugada inicial del puzzle)
        const firstMoveUCI = puzzleMoves.shift();
        const move = game.move(firstMoveUCI, {sloppy: true});

        currentStep = 0;
        $('#puzzleCount').text((currentIndex + 1) + "/5");
        $('#feedback').html('‚≠ê ¬°Ejercicio ' + (currentIndex + 1) + '! ‚≠ê').removeClass('correct wrong');

        // Configurar tablero
        board.orientation(game.turn() === 'w' ? 'white' : 'black');
        board.position(game.fen());
        
        // Resaltar visualmente la √∫ltima jugada hecha por la m√°quina
        highlightMove(move.from, move.to);

        currentIndex++;
    }

    function highlightMove(from, to) {
        $('.square-55d63').removeClass('highlight-last-move');
        $('.square-' + from).addClass('highlight-last-move');
        $('.square-' + to).addClass('highlight-last-move');
    }

    // --- L√ìGICA DE JUEGO ---
    function onDrop(source, target) {
        var move = game.move({ from: source, to: target, promotion: 'q' });
        if (move === null) return 'snapback';

        var moveUCI = source + target;
        if (move.flags.includes('p')) moveUCI += 'q';

        if (moveUCI === puzzleMoves[currentStep]) {
            currentStep++;
            $('.square-55d63').removeClass('highlight-last-move'); // Quitar resalte al mover
            $('#feedback').text('‚ú® ¬°Muy bien! ‚ú®').addClass('correct').removeClass('wrong');
            
            if (currentStep < puzzleMoves.length) {
                setTimeout(() => {
                    const m = game.move(puzzleMoves[currentStep], {sloppy: true});
                    currentStep++;
                    board.position(game.fen());
                    highlightMove(m.from, m.to);
                }, 600);
            } else {
                $('#feedback').text('üéØ ¬°Logrado! Siguiente...');
                // Guardar para el reporte
                report.push(puzzleList[currentIndex-1]);
                setTimeout(loadNextPuzzle, 1500);
            }
        } else {
            $('#feedback').text('‚ùå ¬°Casi! Intenta otra vez').addClass('wrong').removeClass('correct');
            game.undo();
            return 'snapback';
        }
    }

    // --- CRON√ìMETRO Y FINAL ---
    function startTimer() {
        startTime = new Date();
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            $('#timer').text(m + ":" + s);
        }, 1000);
    }

    function finishTest() {
        clearInterval(timerInterval);
        $('#feedback').html('üéä ¬°DESAF√çO TERMINADO! üéä').addClass('correct');
        board.clear();
        
        let reportHTML = `<h3>üìä Tu Reporte Final:</h3>`;
        reportHTML += `<p>‚è±Ô∏è Tiempo total: ${$('#timer').text()}</p>`;
        reportHTML += `<p>‚úÖ Completaste 5 de 5 ejercicios.</p><hr>`;
        reportHTML += `<p>Repasa los ejercicios aqu√≠:</p>`;
        
        report.forEach((p, i) => {
            const url = p.GameUrl || `https://lichess.org/training/${p.PuzzleId}`;
            reportHTML += `<a href="${url}" target="_blank" class="report-link">üîó Ejercicio ${i+1} (ID: ${p.PuzzleId})</a>`;
        });

        $('#reportArea').html(reportHTML);
    }

    function init() {
        board = ChessBoard('myBoard', {
            draggable: true,
            position: 'start',
            showNotation: true,
            onDrop: onDrop,
            onDragStart: (s, p) => {
                if (game.game_over() || puzzleMoves.length === 0) return false;
                if ((game.turn() === 'w' && p.search(/^b/) !== -1) ||
                    (game.turn() === 'b' && p.search(/^w/) !== -1)) return false;
            },
            pieceTheme: pieceTheme
        });
    }

    init();
</script>
</body>
</html>
