<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lichess Puzzle Studio Pro</title>
    <style>
        :root { --bg: #161512; --card: #262421; --primary: #629924; --text: #bababa; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; }
        textarea { width: 100%; height: 100px; background: #1a1917; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .controls { margin: 20px 0; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        select, button { padding: 10px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        button { background: var(--primary); color: white; }
        #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .card img { width: 100%; border-radius: 4px; background: #333; min-height: 200px; }
        .fen-box { font-size: 11px; background: #000; padding: 5px; margin: 10px 0; word-break: break-all; border-radius: 3px; color: #888; }
        .loader { display: none; color: #f0ad4e; margin: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>‚ôüÔ∏è Lichess Puzzle Studio</h1>
    <textarea id="inputLinks" placeholder="Pega los enlaces aqu√≠..."></textarea>
    
    <div class="controls">
        <select id="styleSelect">
            <option value="theme=wood4&pieceSet=staunty">‚ú® Elegante</option>
            <option value="theme=purple-diag&pieceSet=kiwanee">üé® Kids</option>
            <option value="theme=blue2&pieceSet=cburnett">üíº Formal</option>
            <option value="theme=maple&pieceSet=alpha">üìñ Libro</option>
        </select>
        <button onclick="process()">Generar Diagramas</button>
    </div>

    <div id="loader" class="loader">Procesando... esto puede tardar unos segundos.</div>
    <div id="gallery"></div>
</div>

<script>
async function process() {
    const text = document.getElementById('inputLinks').value;
    const gallery = document.getElementById('gallery');
    const loader = document.getElementById('loader');
    const style = document.getElementById('styleSelect').value;
    
    const ids = [...text.matchAll(/training\/([a-zA-Z0-9]+)/g)].map(m => m[1]);
    if (ids.length === 0) return alert("No hay enlaces v√°lidos");

    gallery.innerHTML = '';
    loader.style.display = 'block';

    for (const id of ids) {
        try {
            // Usamos un servidor proxy diferente y m√°s directo
            const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://lichess.org/api/puzzle/' + id)}`);
            const json = await response.json();
            const data = JSON.parse(json.contents);

            // Intentamos obtener el FEN de varias rutas posibles en el JSON
            const fen = data.puzzle?.fen || data.game?.fen || null;

            if (fen) {
                const imageUrl = `https://lichess1.org/export/fen.png?fen=${encodeURIComponent(fen)}&${style}`;
                renderCard(id, fen, imageUrl);
            } else {
                console.error("No se encontr√≥ FEN para el puzzle " + id);
            }
        } catch (e) {
            console.error("Error cargando puzzle " + id, e);
        }
        // Espera de cortes√≠a para evitar bloqueos
        await new Promise(r => setTimeout(r, 300));
    }
    loader.style.display = 'none';
}

function renderCard(id, fen, imageUrl) {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
        <img src="${imageUrl}" onerror="this.src='https://placehold.co/400?text=Error+Cargando+Imagen'">
        <div class="fen-box">${fen}</div>
        <button onclick="navigator.clipboard.writeText('${fen}');alert('FEN Copiado')">Copiar FEN</button>
        <a href="${imageUrl}" target="_blank" style="color:var(--primary); text-decoration:none; font-size:12px; display:block; margin-top:10px;">Ver Imagen Grande</a>
    `;
    document.getElementById('gallery').appendChild(div);
}
</script>

</body>
</html>
