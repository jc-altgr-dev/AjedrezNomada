<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lichess Puzzle Visualizer - Local Fix</title>
    <style>
        :root { --bg: #161512; --card: #262421; --text: #bababa; --accent: #629924; --white: #fff; }
        body { font-family: sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 900px; width: 100%; text-align: center; }
        textarea { width: 100%; height: 100px; background: var(--card); border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; width: 100%; }
        .puzzle-card { background: var(--card); padding: 15px; border-radius: 10px; }
        .puzzle-card img { width: 100%; border-radius: 4px; margin-bottom: 10px; background: #333; min-height: 200px; }
        .fen-box { font-size: 0.7em; background: #111; padding: 5px; border-radius: 3px; word-break: break-all; margin-bottom: 10px; border: 1px solid #444; }
        .btn-small { padding: 5px 10px; font-size: 0.8em; cursor: pointer; background: #454545; color: white; border: none; border-radius: 3px; text-decoration: none; display: inline-block; }
        .loader { display: none; margin: 20px; color: #f0ad4e; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>Lichess Puzzle Downloader</h1>
    <p>Pega los enlaces de los puzzles (uno por línea):</p>
    <textarea id="inputLinks" placeholder="https://lichess.org/training/Galy2"></textarea>
    <br>
    <button onclick="processPuzzles()">GENERAR IMÁGENES</button>
    <div id="loader" class="loader">Consultando a Lichess...</div>
    <div id="gallery"></div>
</div>

<script>
    async function processPuzzles() {
        const text = document.getElementById('inputLinks').value;
        const gallery = document.getElementById('gallery');
        const loader = document.getElementById('loader');
        
        // Regex para capturar IDs de puzzles
        const regex = /training\/([a-zA-Z0-9]+)/g;
        let ids = [];
        let match;
        while ((match = regex.exec(text)) !== null) { ids.push(match[1]); }

        if (ids.length === 0) {
            alert("Por favor, pega enlaces válidos.");
            return;
        }

        gallery.innerHTML = '';
        loader.style.display = 'block';

        for (const id of ids) {
            try {
                // Usamos un proxy de CORS para evitar el bloqueo del navegador en archivos locales
                // Si esto falla, intenta con: https://api.allorigins.win/raw?url=
                const proxy = "https://api.allorigins.win/raw?url=";
                const apiUrl = encodeURIComponent(`https://lichess.org/api/puzzle/${id}`);
                
                const response = await fetch(proxy + apiUrl);
                if (!response.ok) throw new Error("Error en red");
                
                const data = await response.json();
                const fen = data.game.fen;
                
                // Renderizado de imagen
                const imageUrl = `https://lichess1.org/export/fen.png?fen=${encodeURIComponent(fen)}&theme=brown&pieceSet=cburnett`;

                const card = document.createElement('div');
                card.className = 'puzzle-card';
                card.innerHTML = `
                    <img src="${imageUrl}" alt="Puzzle ${id}">
                    <div class="fen-box">${fen}</div>
                    <button class="btn-small" onclick="navigator.clipboard.writeText('${fen}');alert('Copiado')">Copiar FEN</button>
                    <a href="${imageUrl}" target="_blank" download="puzzle_${id}.png" class="btn-small" style="background:#629924">Abrir Imagen</a>
                `;
                gallery.appendChild(card);
                
            } catch (e) {
                console.error("Error cargando el puzzle " + id, e);
            }
        }
        loader.style.display = 'none';
    }
</script>

</body>
</html>
