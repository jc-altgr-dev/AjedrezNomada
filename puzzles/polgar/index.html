<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chess Trainer - Modo Simple</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; background: #2c3e50; color: white; padding: 20px; }
        #board { width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .controls { width: 400px; margin-top: 20px; background: #34495e; padding: 20px; border-radius: 8px; text-align: center; }
        .nav { display: flex; justify-content: space-between; margin: 15px 0; }
        .status-msg { margin: 10px 0; min-height: 1.2em; color: #f1c40f; font-weight: bold; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; background: #27ae60; color: white; font-weight: bold; }
        button:hover { background: #2ecc71; }
        input { padding: 7px; border-radius: 4px; border: none; width: 60px; }
        .search { margin-top: 15px; border-top: 1px solid #5d6d7e; padding-top: 15px; }
    </style>
</head>
<body>

    <div id="board"></div>

    <div class="controls">
        <div id="problem-title" style="font-size: 1.2em; margin-bottom: 5px;"></div>
        <div id="status" class="status-msg">Tu turno</div>
        
        <div class="nav">
            <button onclick="changeProb(-1)">◀ Anterior</button>
            <button onclick="changeProb(1)">Siguiente ▶</button>
        </div>

        <div class="search">
            <input type="number" id="searchId" placeholder="ID">
            <button onclick="search()">Buscar Problema</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        const data = { "problems": [
            {"problemid":1,"first":"White to Move","type":"Mate in One","fen":"3q1rk1/5pbp/5Qp1/8/8/2B5/5PPP/6K1 w - - 0 1","moves":"f6-g7"},
            {"problemid":2,"first":"White to Move","type":"Mate in One","fen":"2r2rk1/2q2p1p/6pQ/4P1N1/8/8/PPP5/2KR4 w - - 0 1","moves":"h6-h7"},
            {"problemid":3,"first":"White to Move","type":"Mate in One","fen":"r2q1rk1/pp1p1p1p/5PpQ/8/4N3/8/PP3PPP/R5K1 w - - 0 1","moves":"h6-g7"},
            {"problemid":4460,"first":"Black to Move","type":"Mate in Three","fen":"r1b2r1k/pp4pB/6Q1/3p2N1/2n5/1N2P1P1/PP3q1P/2R4K b - - 0 1","moves":"f2-f1;c1-f1;f8-f1;h1-g2;c4-e3"},
            {"problemid":4461,"first":"Black to Move","type":"Mate in Three","fen":"6rr/1b2k3/p2pp3/1p2bP1P/6P1/1PNB3K/1PP5/3R1R2 b - - 0 1","moves":"h8-h5;g4-h5;b7-g2;h3-h4;e5-f6"},
            {"problemid":4462,"first":"Black to Move","type":"Mate in Three","fen":"r1b4k/ppn3pp/8/3p4/P2PP2q/1Q2BP2/NP2nNK1/2R2R2 b - - 0 1","moves":"c8-h3;f2-h3;h4-g3;g2-h1;g3-h3"}
        ]};

        let index = 0;
        let board = null;
        let game = new Chess();
        let solutionMoves = [];
        let currentMoveIndex = 0;

        function getWikiPiece(piece) {
            const wiki = {'wP':'4/45/Chess_plt45.svg','wN':'7/70/Chess_nlt45.svg','wB':'b/b1/Chess_blt45.svg','wR':'7/72/Chess_rlt45.svg','wQ':'1/15/Chess_qlt45.svg','wK':'4/42/Chess_klt45.svg','bP':'c/c7/Chess_pdt45.svg','bN':'e/ef/Chess_ndt45.svg','bB':'9/98/Chess_bdt45.svg','bR':'f/ff/Chess_rdt45.svg','bQ':'4/47/Chess_qdt45.svg','bK':'f/f0/Chess_kdt45.svg'};
            return 'https://upload.wikimedia.org/wikipedia/commons/' + wiki[piece];
        }

        function onDragStart(source, piece) {
            if (game.game_over()) return false;
            // Solo permitir mover las piezas del color que toca
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        }

        function onDrop(source, target) {
            const moveStr = `${source}-${target}`;
            const expectedMove = solutionMoves[currentMoveIndex];

            // Validar si es el movimiento correcto según el JSON
            if (moveStr !== expectedMove) {
                document.getElementById('status').innerText = "¡Movimiento incorrecto! Intenta de nuevo.";
                return 'snapback';
            }

            // Ejecutar movimiento en la lógica
            game.move({ from: source, to: target, promotion: 'q' });
            currentMoveIndex++;
            document.getElementById('status').innerText = "¡Correcto!";

            // Si quedan movimientos (respuesta de la máquina)
            if (currentMoveIndex < solutionMoves.length) {
                setTimeout(makeReplyMove, 500);
            } else {
                document.getElementById('status').innerText = "¡Excelente! Problema resuelto.";
                setTimeout(() => changeProb(1), 1500);
            }
        }

        function makeReplyMove() {
            const moveParts = solutionMoves[currentMoveIndex].split('-');
            game.move({ from: moveParts[0], to: moveParts[1], promotion: 'q' });
            board.position(game.fen());
            currentMoveIndex++;
        }

        function render() {
            const p = data.problems[index];
            game.load(p.fen);
            solutionMoves = p.moves.split(';');
            currentMoveIndex = 0;

            document.getElementById('problem-title').innerText = `Problema #${p.problemid} (${p.type})`;
            document.getElementById('status').innerText = "Tu turno: " + p.first;
            
            if (board) board.destroy();
            board = Chessboard('board', {
                position: p.fen,
                draggable: true,
                pieceTheme: getWikiPiece,
                orientation: p.first.toLowerCase().includes('white') ? 'white' : 'black',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: () => board.position(game.fen())
            });
        }

        function changeProb(d) {
            let nextIdx = index + d;
            if (nextIdx >= 0 && nextIdx < data.problems.length) {
                index = nextIdx;
                render();
            }
        }

        function search() {
            const id = parseInt(document.getElementById('searchId').value);
            const found = data.problems.findIndex(p => p.problemid === id);
            if (found !== -1) { index = found; render(); }
            else { alert("ID no encontrado"); }
        }

        render();
    </script>
</body>
</html>
