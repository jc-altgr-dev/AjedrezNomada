<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess Kids Academy üèÜ</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        :root { --primary: #4CAF50; --secondary: #2196F3; --accent: #FFEB3B; --bg: #E3F2FD; --text: #2c3e50; }
        body { 
            font-family: 'Comic Sans MS', sans-serif; background: var(--bg); color: var(--text); 
            margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center;
        }
        
        #board { width: 95vw; max-width: 380px; margin-bottom: 10px; border: 6px solid white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .ui-container { width: 95vw; max-width: 380px; background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; margin-bottom: 10px; }

        /* FEN Display */
        .fen-box { background: #f8f9fa; border: 1px solid #ddd; padding: 8px; border-radius: 8px; font-family: monospace; font-size: 11px; margin: 10px 0; display: flex; align-items: center; gap: 5px; }
        .fen-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
        .copy-btn { background: var(--secondary); padding: 4px 8px; font-size: 10px; box-shadow: 0 2px 0 #1976D2; }

        /* Promoci√≥n Modal */
        #promotion-dialog {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 20px; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.3); z-index: 1000;
        }
        .promo-btns { display: flex; gap: 10px; margin-top: 10px; }
        .promo-btns button { flex: 1; background: #eee; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; }
        .promo-btns img { width: 40px; }

        input, select { padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-family: inherit; }
        .search-zone { display: flex; gap: 5px; margin-bottom: 10px; }
        .type-tag { font-size: 0.75em; background: var(--accent); padding: 2px 8px; border-radius: 10px; margin-bottom: 8px; display: inline-block; }
        .turn-msg { font-size: 1em; margin: 10px 0; padding: 10px; border-radius: 12px; background: #f0f4f8; border: 2px dashed var(--primary); min-height: 40px; }

        .nav-buttons { display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 12px; color: white; font-weight: bold; font-size: 14px; cursor: pointer; transition: 0.1s; }
        .btn-prev { background: #95a5a6; box-shadow: 0 4px 0 #7f8c8d; }
        .btn-next { background: var(--primary); box-shadow: 0 4px 0 #388E3C; }
        button:active { transform: translateY(2px); box-shadow: none; }
        .highlight-sq { box-shadow: inset 0 0 5px 5px rgba(33, 150, 243, 0.6) !important; }
    </style>
</head>
<body>

    <div id="promotion-dialog">
        <p>¬°Coronaci√≥n! Elige pieza:</p>
        <div class="promo-btns">
            <button onclick="selectPromotion('q')"><img id="pq" src=""></button>
            <button onclick="selectPromotion('r')"><img id="pr" src=""></button>
            <button onclick="selectPromotion('b')"><img id="pb" src=""></button>
            <button onclick="selectPromotion('n')"><img id="pn" src=""></button>
        </div>
    </div>

    <div class="ui-container">
        <div class="search-zone">
            <input type="number" id="goto-id" placeholder="ID (1-4462)">
            <button onclick="goToProblem()" style="flex: 0; background: var(--secondary); box-shadow: 0 4px 0 #1976D2;">üîç</button>
        </div>
        <select id="category-index" onchange="jumpToCategory()">
            <option value="">üìÇ Explorar categor√≠as...</option>
        </select>
    </div>

    <div id="board"></div>

    <div class="ui-container">
        <div id="exercise-title" class="exercise-title">Cargando...</div>
        <div id="book-section" class="type-tag">---</div>
        <div id="status" class="turn-msg">¬°Prep√°rate!</div>
        
        <div class="fen-box">
            <span class="fen-text" id="fen-display">...</span>
            <button class="copy-btn" onclick="copyFEN()">Copiar</button>
        </div>

        <div class="nav-buttons">
            <button class="btn-prev" onclick="changeProb(-1)">‚¨ÖÔ∏è</button>
            <button class="btn-next" onclick="changeProb(1)">Siguiente ‚û°Ô∏è</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        let allProblems = [], currentIdx = 0;
        let board, game = new Chess();
        let solutionMoves = [], moveStep = 0;
        let sourceSq = null, pendingMove = null;

        const positiveFeedback = ["¬°Incre√≠ble!", "¬°Qu√© cerebro!", "¬°Eres un genio!", "¬°Maestro total!", "¬°S√∫per jugada!"];

        fetch('puzzles.json')
            .then(r => r.json())
            .then(data => {
                allProblems = data.problems.sort((a, b) => a.problemid - b.problemid);
                buildCategoryIndex();
                render();
            });

        function getWikiPiece(p) {
            const m = {'wP':'4/45/Chess_plt45.svg','wN':'7/70/Chess_nlt45.svg','wB':'b/b1/Chess_blt45.svg','wR':'7/72/Chess_rlt45.svg','wQ':'1/15/Chess_qlt45.svg','wK':'4/42/Chess_klt45.svg','bP':'c/c7/Chess_pdt45.svg','bN':'e/ef/Chess_ndt45.svg','bB':'9/98/Chess_bdt45.svg','bR':'f/ff/Chess_rdt45.svg','bQ':'4/47/Chess_qdt45.svg','bK':'f/f0/Chess_kdt45.svg'};
            return 'https://upload.wikimedia.org/wikipedia/commons/' + m[p];
        }

        function handleMove(src, tgt) {
            const piece = game.get(src);
            // Detectar promoci√≥n
            if (piece && piece.type === 'p' && ((piece.color === 'w' && tgt[1] === '8') || (piece.color === 'b' && tgt[1] === '1'))) {
                pendingMove = { from: src, to: tgt };
                showPromotionDialog(piece.color);
                return 'snapback';
            }
            return finalizeMove(src, tgt);
        }

        function showPromotionDialog(color) {
            document.getElementById('pq').src = getWikiPiece(color + 'Q');
            document.getElementById('pr').src = getWikiPiece(color + 'R');
            document.getElementById('pb').src = getWikiPiece(color + 'B');
            document.getElementById('pn').src = getWikiPiece(color + 'N');
            document.getElementById('promotion-dialog').style.display = 'block';
        }

        function selectPromotion(pieceType) {
            document.getElementById('promotion-dialog').style.display = 'none';
            finalizeMove(pendingMove.from, pendingMove.to, pieceType);
            board.position(game.fen(), false);
        }

        function finalizeMove(src, tgt, promo = 'q') {
            const move = game.move({ from: src, to: tgt, promotion: promo });
            if (!move) return 'snapback';

            const uci = `${src}-${tgt}${promo === 'q' && !solutionMoves[moveStep].includes('q') ? '' : promo}`;
            const targetUci = solutionMoves[moveStep].replace('-', '');
            const currentUci = src + tgt + (move.promotion ? move.promotion : '');

            if (currentUci === targetUci) {
                moveStep++;
                updateFEN();
                if (game.in_checkmate() || moveStep >= solutionMoves.length) {
                    document.getElementById('status').innerText = "‚≠ê " + positiveFeedback[Math.floor(Math.random()*5)];
                    setTimeout(() => changeProb(1), 1000);
                } else {
                    document.getElementById('status').innerText = "¬°Bien! ¬øQu√© sigue?";
                    setTimeout(makeReply, 250);
                }
            } else {
                game.undo();
                document.getElementById('status').innerText = "¬°Casi! Intenta otra vez üß†";
                return 'snapback';
            }
        }

        function makeReply() {
            const reply = solutionMoves[moveStep];
            const [f, t] = reply.split('-');
            const promo = t.length > 2 ? t[2] : 'q';
            game.move({ from: f, to: t.substring(0,2), promotion: promo });
            board.position(game.fen(), false);
            moveStep++;
            updateFEN();
        }

        function updateFEN() {
            const fen = game.fen();
            document.getElementById('fen-display').innerText = fen;
        }

        function copyFEN() {
            const text = document.getElementById('fen-display').innerText;
            navigator.clipboard.writeText(text);
            const btn = document.querySelector('.copy-btn');
            btn.innerText = "¬°Copiado!";
            setTimeout(() => btn.innerText = "Copiar", 2000);
        }

        function render() {
            if (!allProblems.length) return;
            const p = allProblems[currentIdx];
            game.load(p.fen);
            solutionMoves = p.moves.split(';');
            moveStep = 0;
            updateFEN();

            document.getElementById('exercise-title').innerText = `Reto #${p.problemid}`;
            document.getElementById('book-section').innerText = p.type;
            document.getElementById('progress-val').innerText = currentIdx + 1;

            if (board) board.destroy();
            board = Chessboard('board', {
                position: p.fen,
                draggable: true,
                onDrop: handleMove,
                onSnapEnd: () => board.position(game.fen(), false),
                pieceTheme: getWikiPiece,
                orientation: p.first.toLowerCase().includes('white') ? 'white' : 'black'
            });
            // Re-vincular tap para m√≥viles
            $('.square-55d63').off().on('touchstart mousedown', function(e) {
                e.preventDefault();
                const sq = $(this).data('square');
                if (sourceSq === sq) { removeHighlights(); sourceSq = null; }
                else if (game.get(sq) && game.get(sq).color === game.turn()) {
                    removeHighlights(); sourceSq = sq; $(this).addClass('highlight-sq');
                } else if (sourceSq) {
                    const r = handleMove(sourceSq, sq);
                    if (r !== 'snapback') board.position(game.fen(), false);
                    removeHighlights(); sourceSq = null;
                }
            });
        }

        function removeHighlights() { $('.square-55d63').removeClass('highlight-sq'); }
        function changeProb(d) { currentIdx = (currentIdx + d + allProblems.length) % allProblems.length; render(); }
        function goToProblem() {
            const id = parseInt(document.getElementById('goto-id').value);
            const idx = allProblems.findIndex(p => p.problemid === id);
            if (idx !== -1) { currentIdx = idx; render(); }
        }
        function buildCategoryIndex() {
            const select = document.getElementById('category-index');
            const cats = {};
            allProblems.forEach((p, i) => { if (!cats[p.type]) cats[p.type] = i; });
            for (let t in cats) {
                const o = document.createElement('option'); o.value = cats[t]; o.innerText = t; select.appendChild(o);
            }
        }
        function jumpToCategory() { 
            const v = document.getElementById('category-index').value;
            if(v !== "") { currentIdx = parseInt(v); render(); }
        }
    </script>
</body>
</html>
