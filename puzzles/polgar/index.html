<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess Kids Academy üèÜ</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        :root { --primary: #4CAF50; --secondary: #2196F3; --accent: #FFEB3B; --bg: #E3F2FD; --text: #2c3e50; }
        body { 
            font-family: 'Comic Sans MS', sans-serif; background: var(--bg); color: var(--text); 
            margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center;
        }
        
        /* Contenedor del Tablero - Aseguramos que siempre tenga tama√±o */
        #board { 
            width: 95vw; max-width: 380px; min-height: 300px;
            margin-bottom: 10px; border: 6px solid white; border-radius: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); background: #eee;
        }

        .ui-container { width: 95vw; max-width: 380px; background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; margin-bottom: 10px; box-sizing: border-box; }

        /* FEN y Herramientas */
        .fen-box { background: #f8f9fa; border: 1px solid #ddd; padding: 8px; border-radius: 8px; font-family: monospace; font-size: 10px; margin: 10px 0; display: flex; align-items: center; gap: 5px; }
        .fen-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; color: #666; }
        .copy-btn { background: var(--secondary); border: none; color: white; padding: 5px 10px; border-radius: 5px; font-size: 10px; cursor: pointer; }

        /* Dialogo de Promoci√≥n */
        #promotion-dialog {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 20px; border-radius: 15px; box-shadow: 0 0 30px rgba(0,0,0,0.5); z-index: 9999; text-align: center;
        }
        .promo-btns { display: flex; gap: 10px; margin-top: 10px; }
        .promo-btns button { background: #f0f0f0; border: 2px solid #ddd; border-radius: 10px; padding: 5px; cursor: pointer; }
        .promo-btns img { width: 45px; height: 45px; }

        /* UI General */
        .search-zone { display: flex; gap: 5px; margin-bottom: 10px; }
        input, select { padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-family: inherit; font-size: 14px; }
        input { width: 80px; }
        select { flex: 1; }
        .type-tag { font-size: 0.75em; background: var(--accent); padding: 2px 10px; border-radius: 10px; margin-bottom: 8px; display: inline-block; font-weight: bold; }
        .turn-msg { font-size: 1.1em; margin: 10px 0; padding: 12px; border-radius: 12px; background: #f0f4f8; border: 2px dashed var(--primary); min-height: 45px; display: flex; align-items: center; justify-content: center; }
        .nav-buttons { display: flex; gap: 10px; }
        button.nav { flex: 1; padding: 12px; border: none; border-radius: 12px; color: white; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.1s; }
        .btn-prev { background: #95a5a6; box-shadow: 0 4px 0 #7f8c8d; }
        .btn-next { background: var(--primary); box-shadow: 0 4px 0 #388E3C; }
        button:active { transform: translateY(2px); box-shadow: none; }
        .highlight-sq { box-shadow: inset 0 0 5px 5px rgba(33, 150, 243, 0.6) !important; }
    </style>
</head>
<body>

    <div id="promotion-dialog">
        <p style="margin:0 0 10px 0; font-weight:bold;">¬°Elige tu pieza! üåü</p>
        <div class="promo-btns">
            <button onclick="selectPromotion('q')"><img id="pq" src=""></button>
            <button onclick="selectPromotion('n')"><img id="pn" src=""></button>
            <button onclick="selectPromotion('r')"><img id="pr" src=""></button>
            <button onclick="selectPromotion('b')"><img id="pb" src=""></button>
        </div>
    </div>

    <div class="ui-container">
        <div class="search-zone">
            <input type="number" id="goto-id" placeholder="ID">
            <select id="category-index" onchange="jumpToCategory()">
                <option value="">üìÇ Categor√≠as...</option>
            </select>
            <button onclick="goToProblem()" style="background: var(--secondary); border:none; color:white; border-radius:10px; padding:0 15px; cursor:pointer;">üîç</button>
        </div>
    </div>

    <div id="board"></div>

    <div class="ui-container">
        <div id="exercise-title" class="exercise-title" style="font-weight:bold; color:var(--secondary);">Cargando aventura...</div>
        <div id="book-section" class="type-tag">---</div>
        <div id="status" class="turn-msg">Cargando tablero...</div>
        
        <div class="fen-box">
            <span class="fen-text" id="fen-display">fen...</span>
            <button class="copy-btn" onclick="copyFEN()">Copiar</button>
        </div>

        <div class="nav-buttons">
            <button class="nav btn-prev" onclick="changeProb(-1)">‚¨ÖÔ∏è</button>
            <button class="nav btn-next" onclick="changeProb(1)">Siguiente ‚û°Ô∏è</button>
        </div>
        <p style="font-size: 0.7em; color: #999; margin: 10px 0 0 0;">Progreso: <span id="progress-val">0</span>/4462</p>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        let allProblems = [], currentIdx = 0;
        let board, game = new Chess();
        let solutionMoves = [], moveStep = 0;
        let sourceSq = null, pendingMove = null;

        const positiveFeedback = ["¬°Incre√≠ble!", "¬°Qu√© visi√≥n!", "¬°Eres un genio!", "¬°Maestro total!", "¬°S√∫per jugada!"];

        // Cargar Datos
        fetch('puzzles.json')
            .then(r => r.json())
            .then(data => {
                allProblems = data.problems.sort((a, b) => a.problemid - b.problemid);
                buildCategoryIndex();
                render();
            })
            .catch(e => {
                document.getElementById('status').innerText = "Error cargando puzzles.json";
                console.error(e);
            });

        function getWikiPiece(p) {
            const m = {'wP':'4/45/Chess_plt45.svg','wN':'7/70/Chess_nlt45.svg','wB':'b/b1/Chess_blt45.svg','wR':'7/72/Chess_rlt45.svg','wQ':'1/15/Chess_qlt45.svg','wK':'4/42/Chess_klt45.svg','bP':'c/c7/Chess_pdt45.svg','bN':'e/ef/Chess_ndt45.svg','bB':'9/98/Chess_bdt45.svg','bR':'f/ff/Chess_rdt45.svg','bQ':'4/47/Chess_qdt45.svg','bK':'f/f0/Chess_kdt45.svg'};
            return 'https://upload.wikimedia.org/wikipedia/commons/' + m[p];
        }

        function handleMove(src, tgt) {
            const piece = game.get(src);
            // Detectar si es un pe√≥n coronando
            if (piece && piece.type === 'p' && ((piece.color === 'w' && tgt[1] === '8') || (piece.color === 'b' && tgt[1] === '1'))) {
                pendingMove = { from: src, to: tgt };
                showPromotionDialog(piece.color);
                return 'snapback';
            }
            return finalizeMove(src, tgt, 'q');
        }

        function showPromotionDialog(color) {
            document.getElementById('pq').src = getWikiPiece(color + 'Q');
            document.getElementById('pn').src = getWikiPiece(color + 'N');
            document.getElementById('pr').src = getWikiPiece(color + 'R');
            document.getElementById('pb').src = getWikiPiece(color + 'B');
            document.getElementById('promotion-dialog').style.display = 'block';
        }

        function selectPromotion(pType) {
            document.getElementById('promotion-dialog').style.display = 'none';
            finalizeMove(pendingMove.from, pendingMove.to, pType);
            board.position(game.fen(), false);
        }

        function finalizeMove(src, tgt, promo) {
            const move = game.move({ from: src, to: tgt, promotion: promo });
            if (!move) return 'snapback';

            // Comparar con la soluci√≥n
            const userMoveUCI = src + "-" + tgt + (promo !== 'q' || solutionMoves[moveStep].includes('q') ? promo : '');
            const correctMoveUCI = solutionMoves[moveStep];

            // Aceptamos el movimiento si coincide o si es mate
            if (userMoveUCI === correctMoveUCI || game.in_checkmate()) {
                moveStep++;
                updateFEN();
                if (game.in_checkmate() || moveStep >= solutionMoves.length) {
                    document.getElementById('status').innerText = "‚≠ê " + positiveFeedback[Math.floor(Math.random()*5)];
                    setTimeout(() => changeProb(1), 1200);
                } else {
                    document.getElementById('status').innerText = "¬°Bien! ¬øQu√© sigue?";
                    setTimeout(makeReply, 300);
                }
            } else {
                game.undo();
                document.getElementById('status').innerText = "¬°Casi! Intenta otra idea üß†";
                return 'snapback';
            }
        }

        function makeReply() {
            const reply = solutionMoves[moveStep];
            const [f, t] = reply.split('-');
            const promo = t.length > 2 ? t[2] : 'q';
            game.move({ from: f, to: t.substring(0,2), promotion: promo });
            board.position(game.fen(), false);
            moveStep++;
            updateFEN();
        }

        function updateFEN() {
            const f = game.fen();
            document.getElementById('fen-display').innerText = f;
        }

        function copyFEN() {
            const t = document.getElementById('fen-display').innerText;
            navigator.clipboard.writeText(t);
            const b = document.querySelector('.copy-btn');
            b.innerText = "¬°Listo!";
            setTimeout(() => b.innerText = "Copiar", 2000);
        }

        function render() {
            if (!allProblems.length) return;
            const p = allProblems[currentIdx];
            game.load(p.fen);
            solutionMoves = p.moves.split(';');
            moveStep = 0;
            updateFEN();

            document.getElementById('exercise-title').innerText = `Reto #${p.problemid}`;
            document.getElementById('book-section').innerText = p.type;
            document.getElementById('progress-val').innerText = currentIdx + 1;
            document.getElementById('status').innerText = (p.first || "").includes('White') ? "Juegan Blancas ‚ö™" : "Juegan Negras ‚ö´";

            // Destruir tablero anterior para evitar duplicados
            if (board) board.destroy();
            
            board = Chessboard('board', {
                position: p.fen,
                draggable: true,
                onDrop: handleMove,
                onSnapEnd: () => board.position(game.fen(), false),
                pieceTheme: getWikiPiece,
                orientation: (p.first || "").toLowerCase().includes('white') ? 'white' : 'black'
            });

            // Tap Tap para m√≥viles (con prevenci√≥n de lag)
            $('.square-55d63').off().on('click touchstart', function(e) {
                e.preventDefault();
                const sq = $(this).data('square');
                if (sourceSq === sq) { 
                    removeHighlights(); sourceSq = null; 
                } else if (game.get(sq) && game.get(sq).color === game.turn()) {
                    removeHighlights(); sourceSq = sq; $(this).addClass('highlight-sq');
                } else if (sourceSq) {
                    const r = handleMove(sourceSq, sq);
                    if (r !== 'snapback') board.position(game.fen(), false);
                    removeHighlights(); sourceSq = null;
                }
            });
        }

        function removeHighlights() { $('.square-55d63').removeClass('highlight-sq'); }
        function changeProb(d) { currentIdx = (currentIdx + d + allProblems.length) % allProblems.length; render(); }
        function goToProblem() {
            const id = parseInt(document.getElementById('goto-id').value);
            const idx = allProblems.findIndex(x => x.problemid === id);
            if (idx !== -1) { currentIdx = idx; render(); }
        }
        function buildCategoryIndex() {
            const s = document.getElementById('category-index');
            const cats = {};
            allProblems.forEach((p, i) => { if (!cats[p.type]) cats[p.type] = i; });
            for (let t in cats) {
                const o = document.createElement('option'); o.value = cats[t]; o.innerText = t; s.appendChild(o);
            }
        }
        function jumpToCategory() { 
            const v = document.getElementById('category-index').value;
            if(v !== "") { currentIdx = parseInt(v); render(); }
        }

        // Redimensionar tablero al cambiar tama√±o de ventana
        $(window).on('resize', () => { if(board) board.resize(); });
    </script>
</body>
</html>
