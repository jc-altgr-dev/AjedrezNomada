<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess Trainer Final</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { 
            font-family: sans-serif; display: flex; flex-direction: column; align-items: center; 
            background: #2c3e50; color: white; margin: 0; padding: 10px;
            touch-action: manipulation;
        }
        #board { 
            width: 90vw; max-width: 400px; 
            touch-action: none; 
        }
        .controls { width: 90vw; max-width: 400px; margin-top: 15px; background: #34495e; padding: 15px; border-radius: 8px; text-align: center; box-sizing: border-box; }
        .nav { display: flex; justify-content: space-between; margin: 15px 0; gap: 10px; }
        button { flex: 1; padding: 12px; cursor: pointer; border: none; border-radius: 4px; background: #27ae60; color: white; font-weight: bold; font-size: 16px; }
        input { padding: 10px; border-radius: 4px; border: none; width: 80px; text-align: center; font-size: 16px; color: black;}
        .status-msg { margin-bottom: 10px; font-weight: bold; color: #f1c40f; min-height: 1.2em; }
        /* Resaltado de casilla seleccionada */
        .highlight { box-shadow: inset 0 0 3px 3px #f1c40f !important; }
    </style>
</head>
<body>

    <div id="board"></div>

    <div class="controls">
        <div id="status" class="status-msg">Cargando...</div>
        
        <div class="nav">
            <button onclick="changeProb(-1)">◀ Ant.</button>
            <button onclick="changeProb(1)">Sig. ▶</button>
        </div>

        <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; align-items: center; border-top: 1px solid #555; padding-top: 15px;">
            <input type="number" id="searchId" placeholder="ID">
            <button onclick="search()" style="flex: none;">Buscar</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        const data = { "problems": [
            {"problemid":1,"first":"White to Move","type":"Mate in One","fen":"3q1rk1/5pbp/5Qp1/8/8/2B5/5PPP/6K1 w - - 0 1","moves":"f6-g7"},
            {"problemid":2,"first":"White to Move","type":"Mate in One","fen":"2r2rk1/2q2p1p/6pQ/4P1N1/8/8/PPP5/2KR4 w - - 0 1","moves":"h6-h7"},
            {"problemid":3,"first":"White to Move","type":"Mate in One","fen":"r2q1rk1/pp1p1p1p/5PpQ/8/4N3/8/PP3PPP/R5K1 w - - 0 1","moves":"h6-g7"},
            {"problemid":4460,"first":"Black to Move","type":"Mate in Three","fen":"r1b2r1k/pp4pB/6Q1/3p2N1/2n5/1N2P1P1/PP3q1P/2R4K b - - 0 1","moves":"f2-f1;c1-f1;f8-f1;h1-g2;c4-e3"},
            {"problemid":4461,"first":"Black to Move","type":"Mate in Three","fen":"6rr/1b2k3/p2pp3/1p2bP1P/6P1/1PNB3K/1PP5/3R1R2 b - - 0 1","moves":"h8-h5;g4-h5;b7-g2;h3-h4;e5-f6"},
            {"problemid":4462,"first":"Black to Move","type":"Mate in Three","fen":"r1b4k/ppn3pp/8/3p4/P2PP2q/1Q2BP2/NP2nNK1/2R2R2 b - - 0 1","moves":"c8-h3;f2-h3;h4-g3;g2-h1;g3-h3"}
        ]};

        let index = 0;
        let board = null;
        let game = new Chess();
        let solutionMoves = [];
        let currentMoveIndex = 0;
        let sourceSquare = null;

        function getWikiPiece(piece) {
            const wiki = {'wP':'4/45/Chess_plt45.svg','wN':'7/70/Chess_nlt45.svg','wB':'b/b1/Chess_blt45.svg','wR':'7/72/Chess_rlt45.svg','wQ':'1/15/Chess_qlt45.svg','wK':'4/42/Chess_klt45.svg','bP':'c/c7/Chess_pdt45.svg','bN':'e/ef/Chess_ndt45.svg','bB':'9/98/Chess_bdt45.svg','bR':'f/ff/Chess_rdt45.svg','bQ':'4/47/Chess_qdt45.svg','bK':'f/f0/Chess_kdt45.svg'};
            return 'https://upload.wikimedia.org/wikipedia/commons/' + wiki[piece];
        }

        // Eliminar resaltados
        function removeHighlights() {
            $('#board .square-55d6').removeClass('highlight');
        }

        // Añadir resaltado
        function addHighlight(square) {
            $('#board .square-' + square).addClass('highlight');
        }

        function onDrop(source, target) {
            removeHighlights();
            const moveStr = `${source}-${target}`;
            const expected = solutionMoves[currentMoveIndex];

            if (moveStr === expected) {
                game.move({ from: source, to: target, promotion: 'q' });
                currentMoveIndex++;
                document.getElementById('status').innerText = "¡Correcto!";
                
                if (currentMoveIndex < solutionMoves.length) {
                    setTimeout(makeReplyMove, 600);
                } else {
                    document.getElementById('status').innerText = "¡Resuelto!";
                    setTimeout(() => changeProb(1), 1200);
                }
            } else {
                document.getElementById('status').innerText = "Incorrecto, intenta de nuevo";
                return 'snapback';
            }
        }

        // Soporte para clics (Tap-Tap) además de arrastrar
        function onSquareClick(square) {
            const piece = game.get(square);

            // Si no hay nada seleccionado y toca una pieza de su color
            if (sourceSquare === null) {
                if (piece && piece.color === game.turn()) {
                    sourceSquare = square;
                    addHighlight(square);
                }
            } else {
                // Si ya había algo seleccionado, intentamos mover
                const move = onDrop(sourceSquare, square);
                if (move !== 'snapback') {
                    board.position(game.fen());
                }
                sourceSquare = null;
                removeHighlights();
            }
        }

        function makeReplyMove() {
            const [from, to] = solutionMoves[currentMoveIndex].split('-');
            game.move({ from, to, promotion: 'q' });
            board.position(game.fen());
            currentMoveIndex++;
        }

        function render() {
            const p = data.problems[index];
            game.load(p.fen);
            solutionMoves = p.moves.split(';');
            currentMoveIndex = 0;
            sourceSquare = null;

            document.getElementById('status').innerText = "Mueven " + (p.first.includes('White') ? 'Blancas' : 'Negras');
            
            if (board) board.destroy();
            board = Chessboard('board', {
                position: p.fen,
                draggable: true,
                pieceTheme: getWikiPiece,
                orientation: p.first.toLowerCase().includes('white') ? 'white' : 'black',
                onDrop: onDrop,
                onSnapEnd: () => board.position(game.fen())
            });

            // Vincular evento de clic a las casillas
            $('#board').on('click', '.square-55d6', function() {
                const square = $(this).attr('data-square');
                onSquareClick(square);
            });
        }

        function changeProb(d) {
            let nextIdx = index + d;
            if (nextIdx >= 0 && nextIdx < data.problems.length) {
                index = nextIdx;
                render();
            }
        }

        function search() {
            const id = parseInt(document.getElementById('searchId').value);
            const found = data.problems.findIndex(p => p.problemid === id);
            if (found !== -1) { index = found; render(); }
        }

        render();
    </script>
</body>
</html>
