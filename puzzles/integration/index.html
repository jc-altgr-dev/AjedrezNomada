<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Memory Adaptativo V3</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #f1f5f9; }
        #myBoard { width: 100%; border-radius: 1rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        /* --- CAMBIO 1: NUEVO EFECTO DE DESENFOQUE --- */
        /* En lugar de negro total, usamos desenfoque y opacidad */
        .chess-hidden { 
            filter: blur(4px) opacity(0.6) !important; 
            transition: all 0.4s ease-in-out; 
            pointer-events: none; /* Evita mover piezas mientras est√°n borrosas */
        }
        
        /* Estilos de Tarjetas */
        .card-level { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-width: 4px; }
        .card-level:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -10px rgba(0,0,0,0.1); }
        .card-level:active { transform: scale(0.95); }

        /* --- CAMBIO 4: BORDES COLOREADOS --- */
        /* Se a√±adieron border-color espec√≠ficos para cada tema */
        .bg-A1 { background-color: #dcfce7; color: #166534; border-color: #86efac; }
        .bg-A2 { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; }
        .bg-B1 { background-color: #ffedd5; color: #9a3412; border-color: #fdba74; }
        .bg-B2 { background-color: #f3e8ff; color: #6b21a8; border-color: #d8b4fe; }
        .bg-C1 { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; }
        .bg-C2 { background-color: #e0e7ff; color: #3730a3; border-color: #a5b4fc; }
        .bg-Hard { background-color: #1e293b; color: #f8fafc; border-color: #475569; }
    </style>
</head>
<body class="min-h-screen py-8 px-4 flex flex-col items-center justify-center">

    <div id="app" class="max-w-4xl w-full bg-white rounded-[3rem] shadow-2xl overflow-hidden border-4 border-white transition-all duration-700">
        
        <div id="screen-start" class="p-12 text-center">
            <div class="mb-2 inline-block text-6xl">üß†</div>
            <h1 class="text-4xl font-bold text-slate-800 mb-2">Chess Memory Adaptativo</h1>
            <p class="text-slate-400 mb-12 italic text-lg">"¬°Memoriza, calcula y conquista!"</p>
            
            <div id="level-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mb-12">
                </div>

            <a href="https://enael.com.mx" target="_blank" class="inline-flex items-center gap-2 text-indigo-500 font-bold hover:underline">
                üåê Volver a Enael.com.mx
            </a>
        </div>

        <div id="screen-game" class="hidden p-8 md:p-12">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h2 id="current-lvl-tag" class="text-3xl font-bold text-slate-800">Nivel A1</h2>
                    <p id="progress-text" class="text-sm text-slate-400 font-bold uppercase tracking-widest mt-1">Cargando...</p>
                </div>
                <div class="text-right">
                    <div id="timer" class="text-3xl font-mono font-bold text-slate-700 leading-none">00:00</div>
                    <div id="speed-indicator" class="mt-2 text-[10px] font-bold bg-slate-100 text-slate-500 px-3 py-1 rounded-full border border-slate-200 uppercase">
                        Visibilidad: 20s
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                <div class="lg:col-span-7 relative">
                    <div class="bg-slate-200 rounded-[1rem]">
                         <div id="myBoard"></div>
                    </div>
                    <div class="w-full h-3 bg-slate-100 mt-6 rounded-full overflow-hidden border border-slate-50">
                        <div id="visibility-bar" class="h-full bg-indigo-400 transition-all duration-1000"></div>
                    </div>
                </div>

                <div class="lg:col-span-5 flex flex-col justify-center">
                    
                    <button id="btn-hint" onclick="useHint()" disabled class="w-full mb-6 bg-amber-100 text-amber-800 py-4 rounded-2xl font-bold hover:bg-amber-200 transition-all shadow-sm disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        üí° Usar Pista (1s)
                    </button>

                    <div id="feedback" class="p-8 rounded-[2rem] mb-6 text-center hidden animate-bounce">
                        <p id="feedback-text" class="text-xl font-bold"></p>
                    </div>
                    
                    <div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-100 mb-6">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Historial</h4>
                        <div id="mini-stats" class="flex gap-2 flex-wrap"></div>
                    </div>

                    <button id="btn-next" onclick="nextExercise()" class="hidden w-full bg-indigo-600 text-white py-5 rounded-2xl font-bold text-lg shadow-xl hover:bg-indigo-700 transition-all transform hover:-translate-y-1">
                        Siguiente Ejercicio ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <div id="screen-results" class="hidden p-12 text-center">
            <div class="text-7xl mb-6">üèÜ</div>
            <h2 class="text-4xl font-bold text-slate-800 mb-2">¬°Reto Finalizado!</h2>
            <p class="text-slate-400 mb-10">Resumen de tu sesi√≥n:</p>
            <div id="results-summary" class="grid grid-cols-2 gap-4 max-w-sm mx-auto mb-10"></div>
            <button onclick="location.reload()" class="w-full max-w-sm bg-slate-900 text-white py-5 rounded-2xl font-bold text-lg">Volver al Inicio</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        // CONFIGURACI√ìN DE NIVELES (Aseg√∫rate de que las carpetas existan)
        const levelsConfig = [
            { id: "A1", label: "NIVEL 400 ELO", color: "bg-A1" },
            { id: "A2", label: "NIVEL 800 ELO", color: "bg-A2" },
            { id: "B1", label: "NIVEL 1200 ELO", color: "bg-B1" },
            { id: "B2", label: "NIVEL 1600 ELO", color: "bg-B2" },
            { id: "C1", label: "NIVEL 2000 ELO", color: "bg-C1" },
            { id: "C2", label: "NIVEL 2400 ELO", color: "bg-C2" }
        ];

        let board = null;
        let game = new Chess();
        let puzzleList = [];
        let currentIndex = 0;
        let puzzleMoves = [];
        let currentStep = 0;
        let currentVisibleTime = 20;
        let visibilityTimeout;
        let score = 0;
        let hintsUsed = 0;
        let isBoardHidden = false; // Nueva variable de estado

        function init() {
            const grid = document.getElementById('level-grid');
            levelsConfig.forEach(lvl => {
                grid.innerHTML += `
                    <button onclick="loadLevelData('${lvl.id}')" class="card-level ${lvl.color} p-8 rounded-[2rem] text-center">
                        <div class="text-4xl font-bold mb-1">${lvl.id}</div>
                        <div class="text-[10px] font-black opacity-60 uppercase tracking-tighter">${lvl.label}</div>
                    </button>`;
            });
        }

        function loadLevelData(folder) {
            const csvPath = `${folder}/puzzles_selected_${folder}.csv`;
            Papa.parse(csvPath, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    puzzleList = results.data;
                    if (puzzleList.length === 0) { alert(`Archivo vac√≠o o no encontrado: ${csvPath}`); return; }
                    startSession(folder);
                },
                error: function() { alert(`Error al cargar ${csvPath}. Revisa que la carpeta y el archivo existan.`); }
            });
        }

        function startSession(folder) {
            currentIndex = 0; score = 0; hintsUsed = 0;
            document.getElementById('current-lvl-tag').innerText = `Nivel ${folder}`;
            document.getElementById('screen-start').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            
            board = ChessBoard('myBoard', {
                draggable: true,
                onDrop: onDrop,
                // --- CAMBIO 3: PIEZAS LOCALES PNG ---
                // Aseg√∫rate de tener la carpeta 'img' con wP.png, bK.png, etc.
                pieceTheme: (piece) => `img/${piece}.png`
            });
            
            loadPuzzle();
        }

        function loadPuzzle() {
            const data = puzzleList[currentIndex];
            game.load(data.FEN);
            puzzleMoves = data.Moves.split(' ');
            currentStep = 0;

            const firstMove = puzzleMoves.shift();
            game.move(firstMove, {sloppy: true});
            
            board.orientation(game.turn() === 'w' ? 'white' : 'black');
            board.position(game.fen());
            
            document.getElementById('progress-text').innerText = `Ejercicio ${currentIndex + 1} de ${puzzleList.length}`;
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('btn-next').classList.add('hidden');
            // Desactivar pista al cargar nuevo puzzle
            document.getElementById('btn-hint').disabled = true;

            startMemoryCycle();
        }

        function startMemoryCycle() {
            clearTimeout(visibilityTimeout);
            const bar = document.getElementById('visibility-bar');
            const boardEl = document.getElementById('myBoard');
            
            boardEl.classList.remove('chess-hidden');
            bar.style.transitionDuration = '0s';
            bar.style.width = '100%';
            document.getElementById('speed-indicator').innerText = `Memoriza: ${currentVisibleTime}s`;
            isBoardHidden = false;
            document.getElementById('btn-hint').disabled = true; // No pista mientras es visible

            setTimeout(() => {
                bar.style.transitionDuration = `${currentVisibleTime}s`;
                bar.style.width = '0%';
            }, 50);

            visibilityTimeout = setTimeout(() => {
                boardEl.classList.add('chess-hidden');
                document.getElementById('speed-indicator').innerText = `¬°Resuelve de memoria!`;
                isBoardHidden = true;
                document.getElementById('btn-hint').disabled = false; // Activar pista ahora
            }, currentVisibleTime * 1000);
        }

        // --- CAMBIO 2: FUNCI√ìN DE PISTA ---
        function useHint() {
            if (!isBoardHidden) return;
            hintsUsed++;
            const boardEl = document.getElementById('myBoard');
            const btnHint = document.getElementById('btn-hint');
            
            // Mostrar brevemente
            boardEl.classList.remove('chess-hidden');
            btnHint.disabled = true; // Evitar doble click
            
            // Ocultar despu√©s de 1 segundo
            setTimeout(() => {
                if(isBoardHidden) { // Verificar que siga en modo oculto
                     boardEl.classList.add('chess-hidden');
                     btnHint.disabled = false;
                }
            }, 1000);
        }

        function onDrop(source, target) {
            const moveUCI = source + target;
            const move = game.move({ from: source, to: target, promotion: 'q' });
            
            if (move === null) return 'snapback';

            if (moveUCI === puzzleMoves[currentStep] || (moveUCI + 'q') === puzzleMoves[currentStep]) {
                currentStep++;
                // Al mover correctamente, mostramos el tablero y desactivamos la pista
                document.getElementById('myBoard').classList.remove('chess-hidden');
                isBoardHidden = false;
                document.getElementById('btn-hint').disabled = true;

                if (currentStep < puzzleMoves.length) {
                    setTimeout(() => {
                        game.move(puzzleMoves[currentStep], {sloppy: true});
                        currentStep++;
                        board.position(game.fen());
                    }, 500);
                } else {
                    score++;
                    showFeedback(true, "¬°Excelente!");
                    document.getElementById('btn-next').classList.remove('hidden');
                    updateMiniStats(true);
                }
            } else {
                game.undo();
                showFeedback(false, "Intenta de nuevo...");
                updateMiniStats(false);
                return 'snapback';
            }
        }

        function showFeedback(correct, text) {
            const fb = document.getElementById('feedback');
            fb.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'text-green-700', 'text-red-700');
            fb.classList.add(correct ? 'bg-green-100' : 'bg-red-100');
            fb.classList.add(correct ? 'text-green-700' : 'text-red-700');
            document.getElementById('feedback-text').innerText = text;
        }

        function updateMiniStats(correct) {
            document.getElementById('mini-stats').innerHTML += `<span class="text-xl">${correct ? '‚úÖ' : '‚ùå'}</span>`;
        }

        function nextExercise() {
            currentIndex++;
            currentIndex < puzzleList.length ? loadPuzzle() : showFinalResults();
        }

        function showFinalResults() {
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-results').classList.remove('hidden');
            document.getElementById('results-summary').innerHTML = `
                <div class="bg-indigo-50 p-6 rounded-3xl">
                    <div class="text-xs font-bold text-indigo-400 uppercase">Aciertos</div>
                    <div class="text-3xl font-bold text-indigo-700">${score}/${puzzleList.length}</div>
                </div>
                <div class="bg-amber-50 p-6 rounded-3xl">
                    <div class="text-xs font-bold text-amber-600 uppercase">Pistas Usadas</div>
                    <div class="text-3xl font-bold text-amber-700">${hintsUsed}</div>
                </div>
            `;
        }

        init();
    </script>
</body>
</html>
